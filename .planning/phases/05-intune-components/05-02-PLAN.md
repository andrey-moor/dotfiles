---
phase: 05-intune-components
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/home/linux/intune.nix
autonomous: true

must_haves:
  truths:
    - "Health check validates each Intune component layer"
    - "Health check reports clear pass/fail status"
    - "Health check provides remediation hints for failures"
    - "Health check handles missing YubiKey gracefully"
    - "Critical vs optional failures are distinguished"
  artifacts:
    - path: "modules/home/linux/intune.nix"
      provides: "intune-health helper script"
      contains: "intune-health"
  key_links:
    - from: "intune-health script"
      to: "systemctl status microsoft-identity-device-broker"
      via: "checks device broker service"
      pattern: "microsoft-identity-device-broker"
    - from: "intune-health script"
      to: "busctl --system list"
      via: "checks D-Bus registration"
      pattern: "busctl.*devicebroker"
---

<objective>
Implement a comprehensive health check script that validates each Intune component layer.

Purpose: The existing `intune-status` helper shows basic status but doesn't provide actionable diagnostics. Per research recommendations, we need a health check that validates systemd services, D-Bus activation, pcscd, and PKCS#11 with clear pass/fail and remediation hints.

Output: New `intune-health` helper script in intune.nix that performs layer-by-layer validation with remediation guidance.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-intune-components/05-RESEARCH.md (health check pattern and code example)
@modules/home/linux/intune.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement intune-health helper script</name>
  <files>modules/home/linux/intune.nix</files>
  <action>
Add a comprehensive health check script to the intune.nix module, following the pattern from 05-RESEARCH.md.

In the helper scripts section (near statusHelper), add:

```nix
healthHelper = pkgs.writeShellScriptBin "intune-health" ''
  #!/usr/bin/env bash
  # intune-health: Comprehensive validation of Intune components
  # Exit 0 if all critical components pass
  # Exit 1 if any critical component fails

  set -uo pipefail

  # Colors for output
  PASS="\033[32m[PASS]\033[0m"
  FAIL="\033[31m[FAIL]\033[0m"
  WARN="\033[33m[WARN]\033[0m"
  INFO="\033[34m[INFO]\033[0m"

  CRITICAL_FAILURES=0

  check() {
    local name="$1"
    local critical="$2"
    shift 2
    if "$@" >/dev/null 2>&1; then
      echo -e "$PASS $name"
      return 0
    else
      if [[ "$critical" == "critical" ]]; then
        echo -e "$FAIL $name"
        ((CRITICAL_FAILURES++))
      else
        echo -e "$WARN $name (optional)"
      fi
      return 1
    fi
  }

  hint() {
    echo -e "      $INFO Hint: $1"
  }

  echo "=== INTUNE HEALTH CHECK (mode: ${if mode != null then mode else "unsupported"}) ==="
  echo ""

  # === SYSTEMD SERVICES ===
  echo "--- Systemd Services ---"
  if ! check "Device broker service running" critical systemctl is-active microsoft-identity-device-broker; then
    hint "Run: intune-prerequisites && sudo systemctl start microsoft-identity-device-broker"
  fi

  if ! check "Device broker enabled at boot" optional systemctl is-enabled microsoft-identity-device-broker; then
    hint "Run: sudo systemctl enable microsoft-identity-device-broker"
  fi

  if ! check "Intune agent timer enabled" optional systemctl --user is-enabled intune-agent.timer; then
    hint "Run: systemctl --user enable --now intune-agent.timer"
  fi
  echo ""

  # === D-BUS SERVICES ===
  echo "--- D-Bus Services ---"
  if ! check "Device broker on system bus" critical busctl --system list | grep -q devicebroker; then
    hint "Run: intune-prerequisites (installs D-Bus policy)"
  fi

  if ! check "User broker service file exists" critical test -f ~/.local/share/dbus-1/services/com.microsoft.identity.broker1.service; then
    hint "Run: home-manager switch --flake .#$(hostname)"
  fi

  # Test D-Bus activation works
  if ! check "User broker D-Bus activates" critical busctl --user call com.microsoft.identity.broker1 /com/microsoft/identity/broker1 org.freedesktop.DBus.Peer Ping; then
    hint "Check: cat ~/.local/share/dbus-1/services/com.microsoft.identity.broker1.service"
  fi
  echo ""

  # === PCSCD / SMART CARD ===
  echo "--- Smart Card (pcscd) ---"
  if ! check "pcscd service running" critical systemctl is-active pcscd.service || systemctl is-active pcscd.socket; then
    hint "Run: sudo systemctl start pcscd.socket"
  fi

  if ! check "pcscd socket symlink exists" critical test -L /run/pcscd/pcscd; then
    hint "Run: intune-prerequisites (creates tmpfiles symlink)"
  fi
  echo ""

  # === PKCS#11 MODULE ===
  echo "--- PKCS#11 Module ---"
  OPENSC_MODULE=""
  # Try user config first
  if [[ -f ~/.config/pkcs11/modules/opensc.module ]]; then
    OPENSC_MODULE=$(grep "^module:" ~/.config/pkcs11/modules/opensc.module 2>/dev/null | cut -d: -f2 | tr -d ' ')
  fi
  # Fall back to system config
  if [[ -z "$OPENSC_MODULE" ]] && [[ -d /etc/pkcs11/modules ]]; then
    OPENSC_MODULE=$(grep -h "^module:" /etc/pkcs11/modules/*.module 2>/dev/null | head -1 | cut -d: -f2 | tr -d ' ')
  fi

  if ! check "OpenSC module configured" critical test -n "$OPENSC_MODULE"; then
    hint "Run: intune-prerequisites (installs PKCS#11 modules)"
  else
    if ! check "OpenSC module file exists" critical test -f "$OPENSC_MODULE"; then
      hint "Module path in config does not exist: $OPENSC_MODULE"
    fi
  fi
  echo ""

  # === YUBIKEY (optional) ===
  echo "--- YubiKey (optional) ---"
  if command -v pcsc_scan >/dev/null 2>&1 && pcsc_scan -r 2>/dev/null | grep -qi "yubikey\|piv"; then
    check "YubiKey detected by pcscd" optional true
    if [[ -n "$OPENSC_MODULE" ]] && [[ -f "$OPENSC_MODULE" ]]; then
      if ! check "PIV certificates accessible" optional pkcs11-tool --module "$OPENSC_MODULE" --list-objects --type cert 2>/dev/null | grep -q "Certificate"; then
        hint "Insert YubiKey and unlock with PIN"
      fi
    fi
  else
    echo -e "$WARN YubiKey not inserted - skipping certificate checks"
    hint "Insert YubiKey for authentication"
  fi
  echo ""

  # === SUMMARY ===
  echo "--- Summary ---"
  if [[ $CRITICAL_FAILURES -eq 0 ]]; then
    echo -e "$PASS All critical components healthy"
    echo ""
    echo "Ready to launch: intune-portal${wrapperSuffix}"
    exit 0
  else
    echo -e "$FAIL $CRITICAL_FAILURES critical failure(s)"
    echo ""
    echo "Run 'intune-prerequisites' to fix common issues"
    exit 1
  fi
'';
```

Add `healthHelper` to the home.packages list alongside statusHelper and logsHelper.
  </action>
  <verify>
Run `nix eval --raw .#homeConfigurations.stargazer.activationPackage` to verify module evaluates.
Grep the module for "intune-health" to confirm it's present.
  </verify>
  <done>
Module includes healthHelper with all component checks, it's in home.packages, and the script structure matches the research pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update intune-status to reference intune-health</name>
  <files>modules/home/linux/intune.nix</files>
  <action>
Update the existing statusHelper (intune-status) to:

1. Keep its current quick-overview format
2. Add a note at the end suggesting `intune-health` for detailed diagnostics

Change the statusHelper to add at the end:

```
echo ""
echo "For detailed diagnostics: intune-health"
```

This keeps intune-status as the quick "what's running" view while intune-health is the "is everything working" diagnostic.
  </action>
  <verify>
Grep the module for "For detailed diagnostics" to confirm the hint was added.
  </verify>
  <done>
intune-status now suggests intune-health for deeper diagnostics.
  </done>
</task>

</tasks>

<verification>
1. Module evaluates without errors: `nix eval --json .#homeConfigurations.stargazer.config.home.packages 2>&1 | head -5`
2. healthHelper defined: `grep -c "healthHelper" modules/home/linux/intune.nix`
3. healthHelper in packages: `grep "healthHelper" modules/home/linux/intune.nix | grep -c "home.packages"`
4. Status hints at health: `grep "detailed diagnostics" modules/home/linux/intune.nix`
</verification>

<success_criteria>
- intune-health script validates all component layers
- Clear pass/fail output with colors
- Remediation hints for each failure
- YubiKey checks are optional (warn, not fail)
- intune-status references intune-health for detailed checks
</success_criteria>

<output>
After completion, create `.planning/phases/05-intune-components/05-02-SUMMARY.md`
</output>
