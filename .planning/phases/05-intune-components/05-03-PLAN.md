---
phase: 05-intune-components
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - hosts/stargazer/README.md
autonomous: false

must_haves:
  truths:
    - "intune-portal launches and displays login window"
    - "microsoft-identity-broker D-Bus service activates when called"
    - "microsoft-identity-device-broker systemd service starts and stays running"
    - "pcscd detects YubiKey when inserted"
    - "OpenSC PKCS#11 module can list certificates from YubiKey"
  artifacts:
    - path: "hosts/stargazer/README.md"
      provides: "Updated documentation with automated setup commands"
      contains: "intune-prerequisites"
  key_links:
    - from: "hosts/stargazer/README.md Section 8"
      to: "scripts/intune-prerequisites.sh"
      via: "references automated script"
      pattern: "intune-prerequisites"
---

<objective>
Validate Phase 5 success criteria on a live stargazer VM and update documentation.

Purpose: The previous plans created automation scripts and health checks. This plan validates they work on the actual enrolled stargazer VM and updates the README to use the new automated approach.

Output: Verified working Intune stack, updated documentation referencing automated tools.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-intune-components/05-RESEARCH.md
@.planning/phases/05-intune-components/05-01-SUMMARY.md
@.planning/phases/05-intune-components/05-02-SUMMARY.md
@hosts/stargazer/README.md
@modules/home/linux/intune.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply home-manager switch on stargazer</name>
  <files></files>
  <action>
Apply the updated Nix configuration to stargazer VM to install the new helper scripts.

Run via prlctl exec (or SSH if available):

```bash
prlctl exec stargazer "su andreym -s /bin/bash -c '. /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh && cd /mnt/psf/Home/Documents/dotfiles && nix run home-manager -- switch --flake .#stargazer -b backup'"
```

This installs the new `intune-health` and `intune-prerequisites` wrapper scripts.
  </action>
  <verify>
Run `prlctl exec stargazer "which intune-health"` - should return a Nix store path.
Run `prlctl exec stargazer "which intune-prerequisites"` - should return a Nix store path.
  </verify>
  <done>
New helper scripts are available on stargazer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run intune-prerequisites on stargazer</name>
  <files></files>
  <action>
Run the prerequisites script to ensure all system-level config is applied.

```bash
prlctl exec stargazer "su andreym -s /bin/bash -c 'DOTFILES=/mnt/psf/Home/Documents/dotfiles /home/andreym/.nix-profile/bin/intune-prerequisites'"
```

The script should report either "already configured" for each section or apply the configuration.

If any section fails, debug and fix the script (may need to adjust 05-01-PLAN implementation).
  </action>
  <verify>
Script completes without error. Each section shows either "[+]" (applied) or "[=]" (already configured).
  </verify>
  <done>
Prerequisites script ran successfully on stargazer.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run intune-health on stargazer</name>
  <files></files>
  <action>
Run the health check to validate all components.

```bash
prlctl exec stargazer "su andreym -s /bin/bash -c '/home/andreym/.nix-profile/bin/intune-health'"
```

Expected output:
- All critical checks should PASS (device broker, D-Bus, pcscd, PKCS#11)
- YubiKey check may WARN if not inserted (that's OK)

If any critical check fails, debug and fix.
  </action>
  <verify>
Health check exits with code 0 and shows "All critical components healthy".
  </verify>
  <done>
All critical Intune components pass health check.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Automated Intune setup scripts and health check validation</what-built>
  <how-to-verify>
On the stargazer VM (either via console or SSH):

1. **Verify intune-health passes:**
   ```bash
   intune-health
   ```
   Expected: All critical checks show [PASS], exit code 0

2. **Insert YubiKey and re-run:**
   ```bash
   intune-health
   ```
   Expected: YubiKey detected, PIV certificates accessible

3. **Launch intune-portal:**
   ```bash
   intune-portal-rosetta
   ```
   Expected: Portal window opens, shows Microsoft login prompt (not blank screen)

4. **Verify device broker stays running:**
   ```bash
   systemctl status microsoft-identity-device-broker
   ```
   Expected: Active (running), no crash loops

5. **Test user broker D-Bus activation:**
   ```bash
   busctl --user call com.microsoft.identity.broker1 /com/microsoft/identity/broker1 org.freedesktop.DBus.Peer Ping
   ```
   Expected: Returns without error
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Update stargazer README with automated approach</name>
  <files>hosts/stargazer/README.md</files>
  <action>
Update Section 8 (Intune Setup) in hosts/stargazer/README.md to:

1. **Simplify dramatically** - replace manual commands with:
   ```bash
   # Run the automated prerequisites script
   intune-prerequisites

   # Verify everything is working
   intune-health
   ```

2. **Keep detailed commands in collapsible section** for reference/debugging:
   ```markdown
   <details>
   <summary>Manual setup (for reference)</summary>

   [Keep existing manual commands here]

   </details>
   ```

3. **Update Section 9 (Verify)** to use intune-health as primary verification.

4. **Add intune-prerequisites to the setup flow summary** in the Overview section.

Keep troubleshooting section unchanged as it's still useful.
  </action>
  <verify>
README contains "intune-prerequisites" command in Section 8.
README contains "intune-health" command in Section 9.
Manual commands are wrapped in details/summary tags.
  </verify>
  <done>
README updated to reference automated scripts while keeping manual commands as reference.
  </done>
</task>

</tasks>

<verification>
1. `prlctl exec stargazer "intune-health"` exits 0
2. `prlctl exec stargazer "systemctl status microsoft-identity-device-broker"` shows active
3. `grep -c "intune-prerequisites" hosts/stargazer/README.md` returns > 0
4. `grep -c "intune-health" hosts/stargazer/README.md` returns > 0
</verification>

<success_criteria>
Phase 5 Success Criteria (from ROADMAP.md):
1. intune-portal launches and displays login window (not blank) - VERIFIED via checkpoint
2. microsoft-identity-broker D-Bus service activates when called - VERIFIED via intune-health
3. microsoft-identity-device-broker systemd service starts and stays running - VERIFIED via intune-health
4. pcscd detects YubiKey when inserted - VERIFIED via checkpoint
5. OpenSC PKCS#11 module can list certificates from YubiKey - VERIFIED via checkpoint

Additional:
- Automated scripts work on live VM
- Documentation updated to use automated approach
</success_criteria>

<output>
After completion, create `.planning/phases/05-intune-components/05-03-SUMMARY.md`
</output>
