---
phase: 05-intune-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/home/linux/intune.nix
  - scripts/intune-prerequisites.sh
autonomous: true

must_haves:
  truths:
    - "Device broker D-Bus policy can be installed automatically"
    - "pcscd socket symlink is created for x86_64 compatibility"
    - "pcscd polkit is disabled for Rosetta compatibility"
    - "PKCS#11 modules are registered system-wide"
    - "Prerequisites script is idempotent"
  artifacts:
    - path: "scripts/intune-prerequisites.sh"
      provides: "Intune-specific system configuration automation"
      min_lines: 80
  key_links:
    - from: "scripts/intune-prerequisites.sh"
      to: "/usr/share/dbus-1/system.d/com.microsoft.identity.devicebroker1.conf"
      via: "copies D-Bus policy from Nix store"
      pattern: "dbus-1/system.d.*devicebroker"
    - from: "scripts/intune-prerequisites.sh"
      to: "/etc/tmpfiles.d/pcscd-symlink.conf"
      via: "creates tmpfiles config"
      pattern: "pcscd-symlink"
---

<objective>
Automate Intune-specific system configuration that currently requires manual steps.

Purpose: Section 8 of stargazer/README.md has ~50 lines of manual shell commands for device broker D-Bus policy, pcscd configuration, and PKCS#11 setup. These should be automated in an idempotent script that users run once after home-manager switch.

Output: New `scripts/intune-prerequisites.sh` that handles all system-level Intune setup (device broker D-Bus, pcscd symlink, pcscd polkit override, PKCS#11 modules, ccid driver patch).
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-intune-components/05-RESEARCH.md
@hosts/stargazer/README.md (Section 8: Intune Setup)
@scripts/prerequisites.sh (for idempotent pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intune-prerequisites.sh script</name>
  <files>scripts/intune-prerequisites.sh</files>
  <action>
Create a new idempotent script that automates Section 8.1-8.4 of stargazer/README.md.

The script should follow the same patterns as prerequisites.sh:
- Use log()/warn()/skip() helper functions
- Check if each configuration already exists before applying
- Run with sudo where needed (user runs as regular user)
- Be safe to re-run

Sections to automate:

1. **Device broker D-Bus policy** (8.1)
   - Find broker package in /nix/store by pattern `*microsoft-identity-broker-2.0.4`
   - Copy `com.microsoft.identity.devicebroker1.conf` to `/usr/share/dbus-1/system.d/`
   - Set permissions to 644
   - Signal dbus-daemon with `pkill -HUP dbus-daemon`
   - Skip if file already exists with correct content

2. **Device broker systemd service** (8.1)
   - Copy service file from broker package to `/etc/systemd/system/`
   - Create override directory and rosetta.conf with:
     - ExecStart override to use Nix wrapper
     - HOME/XDG environment variables for MSAL
     - Restart=always with RestartSec=5
   - Enable and start the service
   - Skip if already configured (check for override conf)

3. **pcscd socket symlink** (8.2)
   - Create `/etc/tmpfiles.d/pcscd-symlink.conf` with symlink rule
   - Run `systemd-tmpfiles --create` to apply
   - Skip if symlink already exists

4. **pcscd polkit disable** (8.2)
   - Create `/etc/systemd/system/pcscd.service.d/override.conf`
   - Add ExecStart override with `--disable-polkit`
   - Reload systemd and restart pcscd
   - Skip if override already exists

5. **System PKCS#11 modules** (8.2)
   - Create `/etc/pkcs11/modules/` directory
   - Find opensc-arch package in Nix store
   - Create opensc-x86.module pointing to Nix OpenSC
   - Create opensc.module pointing to /usr/lib (system OpenSC)
   - Skip if modules already exist

6. **ccid driver patch** (8.2)
   - Patch Info.plist in /usr/lib/pcsc/drivers/ifd-ccid.bundle/ to add Parallels Proxy CCID
   - Skip if patch already applied (grep for 0x203A)

7. **PAM password policy** (8.4)
   - Create `/etc/pam.d/common-password` with Intune-compliant policy
   - Set permissions to 644 (readable by intune-agent)
   - Skip if already exists with correct content

8. **Keyring default** (8.3)
   - Create `~/.local/share/keyrings/default` containing "login"
   - Skip if already exists

Add a verification section at the end that reports status of each component.

Include a --check flag that only verifies without making changes.
  </action>
  <verify>
Run `bash -n scripts/intune-prerequisites.sh` to check syntax.
Verify script has all 8 sections by checking for section headers.
  </verify>
  <done>
Script exists with all automation sections, syntax is valid, and follows idempotent patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add intune-prerequisites wrapper to Nix module</name>
  <files>modules/home/linux/intune.nix</files>
  <action>
Add a wrapper script to the intune.nix module that invokes the prerequisites script from the dotfiles repo.

In the helper scripts section (after statusHelper), add:

```nix
prereqHelper = pkgs.writeShellScriptBin "intune-prerequisites" ''
  #!/usr/bin/env bash
  # Wrapper to run intune-prerequisites.sh from dotfiles
  DOTFILES="''${DOTFILES:-$HOME/.dotfiles}"
  SCRIPT="$DOTFILES/scripts/intune-prerequisites.sh"
  if [[ -f "$SCRIPT" ]]; then
    exec "$SCRIPT" "$@"
  else
    echo "Error: intune-prerequisites.sh not found at $SCRIPT"
    echo "Set DOTFILES env var to your dotfiles location"
    exit 1
  fi
'';
```

Add `prereqHelper` to home.packages list.

Update the activation script (verifyIntuneSetup) to:
1. Check if device-broker service is running
2. If not, suggest running `intune-prerequisites`
  </action>
  <verify>
Run `nix eval --raw .#homeConfigurations.stargazer.activationPackage` to verify module evaluates without errors.
  </verify>
  <done>
Module has prereqHelper wrapper, it's in home.packages, and activation script suggests running it.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/intune-prerequisites.sh` - syntax check passes
2. Script contains all 8 sections (grep for section headers)
3. Nix module evaluates: `nix eval --json .#homeConfigurations.stargazer.config.home.packages 2>&1 | head -5`
4. prereqHelper appears in packages list
</verification>

<success_criteria>
- intune-prerequisites.sh exists with all manual steps automated
- Script is idempotent (safe to run multiple times)
- Nix module includes wrapper to invoke the script
- Activation script hints at running prerequisites if not configured
</success_criteria>

<output>
After completion, create `.planning/phases/05-intune-components/05-01-SUMMARY.md`
</output>
