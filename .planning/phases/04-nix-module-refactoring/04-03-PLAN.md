---
phase: 04-nix-module-refactoring
plan: 03
type: execute
wave: 3
depends_on:
  - "04-02"
files_modified:
  - modules/home/linux/intune-rosetta.nix
  - modules/home/linux/intune-nix.nix
  - modules/home/linux/intune.nix
autonomous: false

must_haves:
  truths:
    - "Stargazer builds and switches successfully (Rosetta mode)"
    - "Rocinante builds successfully (native x86_64 mode)"
    - "Old modules are renamed to .bak for safety"
  artifacts:
    - path: "modules/home/linux/intune-rosetta.nix.bak"
      provides: "Backup of old Rosetta module"
    - path: "modules/home/linux/intune-nix.nix.bak"
      provides: "Backup of old x86_64 module"
  key_links:
    - from: "hosts/stargazer/default.nix"
      to: "modules/home/linux/intune.nix"
      via: "successful build"
---

<objective>
Validate the unified module works on both architectures and archive old modules.

Purpose: Ensure the refactor didn't break anything before removing old code.

Output: Validated builds on both architectures, old modules backed up.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-nix-module-refactoring/04-01-SUMMARY.md
@.planning/phases/04-nix-module-refactoring/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build stargazer configuration (Rosetta mode)</name>
  <files>None (build only)</files>
  <action>
Build the stargazer configuration to validate Rosetta mode works:

```bash
cd /Users/andreym/Documents/dotfiles
nix build .#homeConfigurations.stargazer.activationPackage --dry-run
```

If dry-run succeeds, proceed with actual build:
```bash
nix build .#homeConfigurations.stargazer.activationPackage
```

This validates:
- Mode detection correctly identifies Rosetta (aarch64 + Rosetta binary)
- pkgsX86 cross-compilation works
- Library categories compose correctly
- All wrappers build successfully

Note: Actual switching on stargazer VM is optional (requires VM access).
  </action>
  <verify>
```bash
# Build should complete without errors
ls -la /Users/andreym/Documents/dotfiles/result 2>/dev/null
# result symlink should exist pointing to nix store path
```
  </verify>
  <done>
- stargazer homeConfiguration builds successfully
- Rosetta mode detection works
- Cross-arch package imports work
  </done>
</task>

<task type="auto">
  <name>Task 2: Build rocinante configuration (native x86_64 mode)</name>
  <files>None (build only)</files>
  <action>
Build the rocinante configuration to validate native x86_64 mode works:

```bash
cd /Users/andreym/Documents/dotfiles
nix build .#homeConfigurations.rocinante.activationPackage --dry-run
```

If dry-run succeeds, proceed with actual build:
```bash
nix build .#homeConfigurations.rocinante.activationPackage
```

This validates:
- Mode detection correctly identifies native-x86_64
- pkgSource uses native pkgs (not pkgsX86)
- Library paths use native packages
- Wrappers have correct wrapper suffix (empty for native)

Note: Actual switching on rocinante requires SSH access to remote machine.
  </action>
  <verify>
```bash
# Build should complete without errors
# Note: This may take longer as it needs x86_64 packages
```
  </verify>
  <done>
- rocinante homeConfiguration builds successfully
- Native x86_64 mode detection works
- No unnecessary cross-compilation
  </done>
</task>

<task type="auto">
  <name>Task 3: Rename old modules to .bak</name>
  <files>modules/home/linux/intune-rosetta.nix, modules/home/linux/intune-nix.nix</files>
  <action>
After successful builds, rename old modules to prevent accidental use:

```bash
cd /Users/andreym/Documents/dotfiles
mv modules/home/linux/intune-rosetta.nix modules/home/linux/intune-rosetta.nix.bak
mv modules/home/linux/intune-nix.nix modules/home/linux/intune-nix.nix.bak
```

The .bak suffix:
- Prevents auto-discovery by module system (only .nix files are loaded)
- Keeps code available for reference during transition
- Can be deleted in future phase once confident in unified module
  </action>
  <verify>
```bash
ls -la /Users/andreym/Documents/dotfiles/modules/home/linux/intune*.nix*
# Should show:
# intune.nix (new unified module)
# intune-rosetta.nix.bak (backed up)
# intune-nix.nix.bak (backed up)
```
  </verify>
  <done>
- intune-rosetta.nix renamed to .bak
- intune-nix.nix renamed to .bak
- Old modules no longer auto-loaded
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Unified intune module that handles both architectures via mode detection, with old modules backed up.
  </what-built>
  <how-to-verify>
1. Check module exists and is under 500 lines:
   ```bash
   wc -l modules/home/linux/intune.nix
   ```

2. Check old modules are backed up:
   ```bash
   ls modules/home/linux/intune*.nix*
   ```

3. Check builds succeeded:
   - stargazer build completed (Rosetta mode)
   - rocinante build completed (native x86_64 mode)

4. (Optional) If you have access to stargazer VM, switch and test:
   ```bash
   prlctl exec stargazer "su andreym -s /bin/bash -c '. /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh && cd /mnt/psf/Home/Documents/dotfiles && nix run home-manager -- switch --flake .#stargazer -b backup'"
   ```
   Then verify `intune-portal-rosetta` works.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm refactoring is complete, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. Both stargazer and rocinante homeConfigurations build
2. Old modules renamed to .bak
3. New intune.nix is the only active module
4. User confirms refactoring is acceptable
</verification>

<success_criteria>
- [ ] stargazer homeConfiguration builds (Rosetta mode)
- [ ] rocinante homeConfiguration builds (native x86_64 mode)
- [ ] intune-rosetta.nix renamed to .bak
- [ ] intune-nix.nix renamed to .bak
- [ ] User approves checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/04-nix-module-refactoring/04-03-SUMMARY.md`
</output>
