---
phase: 04-nix-module-refactoring
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - hosts/stargazer/default.nix
  - hosts/endurance/default.nix
  - hosts/rocinante/default.nix
  - hosts/rocinante/README.md
autonomous: true

must_haves:
  truths:
    - "All hosts use unified modules.linux.intune module"
    - "No hosts reference deprecated intune-rosetta or intune-nix modules"
    - "Host configs build successfully"
  artifacts:
    - path: "hosts/stargazer/default.nix"
      provides: "Stargazer host config"
      contains: "intune.enable = true"
    - path: "hosts/endurance/default.nix"
      provides: "Endurance host config"
      contains: "intune.enable = true"
    - path: "hosts/rocinante/default.nix"
      provides: "Rocinante host config"
      contains: "intune.enable = true"
  key_links:
    - from: "hosts/stargazer/default.nix"
      to: "modules/home/linux/intune.nix"
      via: "module option"
      pattern: "modules\\.linux\\.intune"
---

<objective>
Update all host configurations to use the new unified intune module.

Purpose: Migrate stargazer, endurance, and rocinante from intune-rosetta/intune-nix to the unified intune module.

Output: All three hosts use `modules.linux.intune.enable = true` with the unified module detecting architecture automatically.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-nix-module-refactoring/04-01-SUMMARY.md
@hosts/stargazer/default.nix
@hosts/endurance/default.nix
@hosts/rocinante/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update host configs to use unified intune module</name>
  <files>hosts/stargazer/default.nix, hosts/endurance/default.nix, hosts/rocinante/default.nix</files>
  <action>
Update each host configuration:

**hosts/stargazer/default.nix:**
Change:
```nix
intune-rosetta.enable = true;
intune-rosetta.debug = true;
```
To:
```nix
intune.enable = true;
intune.debug = true;
```

**hosts/endurance/default.nix:**
Change:
```nix
intune-rosetta.enable = true;
intune-rosetta.debug = true;
```
To:
```nix
intune.enable = true;
intune.debug = true;
```

**hosts/rocinante/default.nix:**
Change:
```nix
intune-nix.enable = true;
intune-nix.debug = true;
```
To:
```nix
intune.enable = true;
intune.debug = true;
```

The new unified module auto-detects:
- stargazer (aarch64 + Rosetta) -> rosetta mode
- endurance (aarch64 + Rosetta) -> rosetta mode
- rocinante (x86_64) -> native-x86_64 mode
  </action>
  <verify>
```bash
cd /Users/andreym/Documents/dotfiles
grep -r "intune-rosetta" hosts/  # Should return nothing
grep -r "intune-nix" hosts/       # Should return nothing (except README)
grep -r "intune.enable" hosts/    # Should show 3 hosts
```
  </verify>
  <done>
- All hosts use modules.linux.intune
- No references to deprecated intune-rosetta or intune-nix in host configs
  </done>
</task>

<task type="auto">
  <name>Task 2: Update rocinante README</name>
  <files>hosts/rocinante/README.md</files>
  <action>
Update hosts/rocinante/README.md to reference the unified module:

Change any mention of `intune-nix` to reference the unified `intune` module.

The line:
```
The `intune-nix` module provides full Nix library chain to avoid ABI issues with Arch system libs.
```

Should become:
```
The `intune` module provides full Nix library chain to avoid ABI issues with Arch system libs.
It auto-detects x86_64-linux and uses native packages (no Rosetta emulation needed).
```
  </action>
  <verify>
```bash
grep -c "intune-nix" /Users/andreym/Documents/dotfiles/hosts/rocinante/README.md  # Should be 0
grep "intune module" /Users/andreym/Documents/dotfiles/hosts/rocinante/README.md  # Should show reference
```
  </verify>
  <done>
- rocinante README references unified intune module
- No references to deprecated intune-nix
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `grep -r "intune-rosetta" hosts/` returns nothing
2. `grep -r "intune-nix" hosts/` returns nothing (except README that explains migration)
3. All three hosts have `intune.enable = true`
</verification>

<success_criteria>
- [ ] hosts/stargazer/default.nix uses modules.linux.intune
- [ ] hosts/endurance/default.nix uses modules.linux.intune
- [ ] hosts/rocinante/default.nix uses modules.linux.intune
- [ ] hosts/rocinante/README.md references unified module
- [ ] No deprecated module references in host configs
</success_criteria>

<output>
After completion, create `.planning/phases/04-nix-module-refactoring/04-02-SUMMARY.md`
</output>
