---
phase: 01-vm-template-creation
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - scripts/generalize-template.sh
autonomous: false

must_haves:
  truths:
    - "Template VM is generalized (no machine-specific data)"
    - "Cloned VM boots with unique machine-id"
    - "Cloned VM has new hostname"
    - "User can change LUKS passphrase on clone"
  artifacts:
    - path: "VM: ArchBase-Template (Parallels)"
      provides: "Generalized template VM"
    - path: "Snapshot: Template-Ready (Parallels)"
      provides: "Final template state for cloning"
    - path: "VM: ArchBase-Clone-Test (Parallels)"
      provides: "Test clone to verify cloning works"
    - path: "scripts/generalize-template.sh"
      provides: "Script to generalize VM before templating"
  key_links:
    - from: "scripts/generalize-template.sh"
      to: "VM machine-id"
      via: "truncate command"
      pattern: "truncate.*machine-id"
    - from: "prlctl clone"
      to: "New VM"
      via: "Parallels cloning"
      pattern: "prlctl clone"
---

<objective>
Follow docs/template-generalization.md to generalize the VM and verify the clone workflow works. Create the generalize-template.sh script for reproducibility.

Purpose: Test that template-generalization.md correctly documents the generalization process and that cloning produces a working VM.

Output:
- Generalized template VM ready for cloning
- Tested clone workflow with verification
- scripts/generalize-template.sh for future use
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md
@docs/template-generalization.md
@scripts/create-arch-vm.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generalize-template.sh script</name>
  <files>scripts/generalize-template.sh</files>
  <action>
Create a script that generalizes a VM for templating. This script runs INSIDE the VM:

```bash
#!/usr/bin/env bash
# Generalize Arch Linux VM for templating
# Run as root inside the VM before shutdown
#
# Usage: sudo ./generalize-template.sh
#
# What it does:
# - Clears machine-id (regenerates on boot)
# - Sets generic hostname
# - Removes SSH host keys (regenerate on boot)
# - Clears shell history
# - Clears pacman cache

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

log() { echo -e "${GREEN}[+]${NC} $1"; }
error() { echo -e "${RED}[x]${NC} $1"; exit 1; }

# Must run as root
[[ $EUID -eq 0 ]] || error "Run as root: sudo $0"

log "Generalizing VM for templating..."

# Clear machine-id (will regenerate on first boot)
log "Clearing machine-id..."
truncate -s 0 /etc/machine-id
rm -f /var/lib/dbus/machine-id 2>/dev/null || true
ln -sf /etc/machine-id /var/lib/dbus/machine-id 2>/dev/null || true

# Set generic hostname
log "Setting generic hostname..."
echo "archbase" > /etc/hostname
# Update /etc/hosts
sed -i 's/127.0.1.1.*/127.0.1.1\tarchbase/' /etc/hosts 2>/dev/null || true

# Remove SSH host keys (regenerate on first boot)
log "Removing SSH host keys..."
rm -f /etc/ssh/ssh_host_*

# Clear shell history for all users
log "Clearing shell history..."
rm -f /root/.bash_history /root/.zsh_history 2>/dev/null || true
for home in /home/*; do
    rm -f "$home/.bash_history" "$home/.zsh_history" 2>/dev/null || true
done
history -c 2>/dev/null || true

# Clear pacman cache
log "Clearing pacman cache..."
pacman -Scc --noconfirm 2>/dev/null || true

# Clear journal logs
log "Clearing journal logs..."
journalctl --rotate 2>/dev/null || true
journalctl --vacuum-time=1s 2>/dev/null || true

log "Generalization complete!"
echo ""
echo "Next steps:"
echo "  1. Shutdown the VM: shutdown -h now"
echo "  2. Create Parallels snapshot"
echo "  3. Clone from snapshot for new VMs"
echo ""
echo "After cloning, remember to:"
echo "  - Set new hostname: hostnamectl set-hostname <name>"
echo "  - Change LUKS passphrase: sudo cryptsetup luksChangeKey /dev/sda2"
```

Make executable:
```bash
chmod +x scripts/generalize-template.sh
```
  </action>
  <verify>
- File exists: `ls scripts/generalize-template.sh`
- Is executable: `test -x scripts/generalize-template.sh`
- Contains machine-id handling: `grep "machine-id" scripts/generalize-template.sh`
- Contains SSH key removal: `grep "ssh_host" scripts/generalize-template.sh`
  </verify>
  <done>
Script exists and contains all generalization steps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Start VM and copy generalization script</name>
  <files></files>
  <action>
Start the VM and copy the generalization script into it:

```bash
# Start VM
prlctl start ArchBase-Template

# Wait for boot
sleep 60

# Copy script to VM via shared folder
# The dotfiles repo should be at /mnt/psf/Home/Documents/dotfiles
# So the script is already available at /mnt/psf/Home/Documents/dotfiles/scripts/generalize-template.sh
```

Alternative if shared folders don't work:
```bash
# Use prl-type.sh to type the script contents
# Or use prlctl exec if SSH is configured
```
  </action>
  <verify>
- VM is running: `prlctl list | grep ArchBase-Template` shows "running"
  </verify>
  <done>
VM is running and script is accessible via shared folder.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Run generalization script</name>
  <action>
Human must enter LUKS passphrase at boot and run script as root.
  </action>
  <what-to-do>
1. **Boot the VM** - Enter LUKS passphrase when prompted

2. **Login** as the user created during Omarchy installation

3. **Run the generalization script:**
```bash
# Navigate to dotfiles via shared folder
cd /mnt/psf/Home/Documents/dotfiles

# Run script
sudo ./scripts/generalize-template.sh
```

4. **Verify generalization:**
```bash
# Check machine-id is empty
cat /etc/machine-id  # Should be empty

# Check hostname
cat /etc/hostname  # Should be "archbase"

# Check SSH keys removed
ls /etc/ssh/ssh_host_*  # Should show "No such file or directory"
```

5. **Shutdown cleanly:**
```bash
sudo shutdown -h now
```
  </what-to-do>
  <resume-signal>Type "generalized" when VM is shutdown after running the script</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create template snapshot and test clone</name>
  <files></files>
  <action>
Create the final template snapshot and test cloning:

```bash
# Verify VM is stopped
prlctl list | grep ArchBase-Template

# Create final template snapshot
prlctl snapshot ArchBase-Template -n "Template-Ready-$(date +%Y-%m-%d)" -d "Generalized template ready for cloning"

# Verify snapshot
prlctl snapshot-list ArchBase-Template

# Clone the template
prlctl clone ArchBase-Template --name ArchBase-Clone-Test

# Verify clone exists
prlctl list -a | grep ArchBase-Clone-Test
```
  </action>
  <verify>
- Template snapshot exists: `prlctl snapshot-list ArchBase-Template | grep "Template-Ready"`
- Clone exists: `prlctl list -a | grep ArchBase-Clone-Test`
  </verify>
  <done>
Template snapshot created and clone VM exists.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 5: Verify cloned VM works</name>
  <what-built>
Cloned VM from generalized template.
  </what-built>
  <how-to-verify>
1. **Start the cloned VM:**
```bash
prlctl start ArchBase-Clone-Test
```

2. **Verify LUKS boot:**
   - GRUB menu should appear
   - LUKS passphrase prompt should appear
   - Use passphrase: 4815162342

3. **Login and verify uniqueness:**
```bash
# Check new machine-id was generated
cat /etc/machine-id  # Should NOT be empty now

# Check hostname (should still be archbase)
cat /etc/hostname

# Check new SSH keys were generated
ls /etc/ssh/ssh_host_*  # Should exist now
```

4. **Test hostname change:**
```bash
sudo hostnamectl set-hostname my-new-vm
cat /etc/hostname  # Should show "my-new-vm"
```

5. **Test LUKS passphrase change (optional but verify command works):**
```bash
# Just verify the command is understood (don't actually change for test VM)
sudo cryptsetup luksChangeKey /dev/sda2 --help
```

6. **Cleanup test clone (optional):**
```bash
# From macOS
prlctl stop ArchBase-Clone-Test
prlctl delete ArchBase-Clone-Test
```
  </how-to-verify>
  <resume-signal>Type "clone-verified" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria - FINAL CHECK:
- [x] VM boots with LUKS passphrase prompt and decrypts successfully
- [x] Rosetta is enabled in Parallels settings and /mnt/psf/RosettaLinux/rosetta exists
- [x] Shared folders mount dotfiles at expected path (/mnt/psf/Home/Documents/dotfiles)
- [ ] SSH access works from macOS host using key authentication (deferred - not critical for template)
- [x] Template creation process is documented and can be followed by a new developer
- [x] Template can be cloned and clone boots successfully
</verification>

<success_criteria>
- scripts/generalize-template.sh exists and works
- Template VM is generalized (empty machine-id, generic hostname, no SSH keys)
- Snapshot "Template-Ready-YYYY-MM-DD" exists
- Clone "ArchBase-Clone-Test" boots with LUKS
- Clone has unique machine-id (different from template)
- Clone can have hostname changed
- template-generalization.md was followable (note any issues)
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-04-SUMMARY.md`

Include in summary:
- Final template snapshot name
- Any issues encountered during generalization or cloning
- Size of template VM (.pvm file size)
- Confirmation that clone workflow works end-to-end
</output>
