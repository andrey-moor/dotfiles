---
phase: 01-vm-template-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hosts/endurance/README.md
autonomous: false

must_haves:
  truths:
    - "VM exists in Parallels with 4 CPU, 8GB RAM, 128GB disk"
    - "Rosetta is enabled before first boot"
    - "Shared folders enabled before first boot"
    - "Bridged networking configured"
    - "LUKS2 encryption with argon2id protects root partition"
    - "GRUB bootloader installed with encrypt hook"
    - "Base Arch system boots and prompts for LUKS passphrase"
  artifacts:
    - path: "hosts/endurance/README.md"
      provides: "VM creation and base installation documentation"
      contains: "VM Creation"
  key_links:
    - from: "GRUB"
      to: "/boot (unencrypted)"
      via: "kernel + initramfs loading"
    - from: "initramfs encrypt hook"
      to: "LUKS partition"
      via: "cryptsetup open"
---

<objective>
Document and execute Parallels VM creation with LUKS-encrypted Arch Linux base installation.

Purpose: Create the foundation VM with encryption, bootloader, and proper Parallels settings that must be configured before first boot.

Output: Working encrypted Arch Linux ARM VM that boots to console, plus documentation in hosts/endurance/README.md.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@hosts/endurance/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document VM creation and base installation process</name>
  <files>hosts/endurance/README.md</files>
  <action>
Rewrite hosts/endurance/README.md to document the complete VM template creation process. Structure:

## VM Template Creation

### Prerequisites
- Parallels Desktop 26+ on Apple Silicon
- archboot aarch64 ISO downloaded
- macOS SSH public key available

### Step 1: Create VM in Parallels
Document prlctl commands to create VM with correct settings:
- Name: ArchBase-Template
- 4 CPU, 8GB RAM, 128GB disk
- Enable Rosetta BEFORE first boot (critical)
- Enable shared folders (home directory)
- Bridged networking

### Step 2: Boot and Partition
Document exact commands for:
- Boot from archboot ISO
- Create partition layout: EFI (512MB) + /boot (1GB) + LUKS (remaining)
- Use fdisk/gdisk commands from RESEARCH.md

### Step 3: LUKS Setup
Document cryptsetup commands:
- LUKS2 with argon2id (safe because /boot is unencrypted)
- Format root filesystem as ext4

### Step 4: Mount for archinstall
Document mounting sequence:
- Mount cryptroot to /mnt/archinstall
- Mount /boot and /boot/efi
- Verify mount layout

### Step 5: Run archinstall
Document archinstall invocation:
- Use pre_mounted_config mode
- GRUB bootloader
- NetworkManager
- SSH enabled
- Generic "user" account
- Include JSON config if helpful

### Step 6: Configure GRUB
Document post-archinstall GRUB configuration:
- Add cryptdevice to GRUB_CMDLINE_LINUX with LUKS UUID
- ARM kernel symlink (cp /boot/Image /boot/vmlinuz-linux)
- grub-install and grub-mkconfig commands
- mkinitcpio HOOKS verification

### Step 7: First Boot Verification
Document what to check after first boot:
- LUKS passphrase prompt appears
- System decrypts and boots
- Can login as user

Key references from RESEARCH.md:
- Partition layout diagram
- LUKS2 cryptsetup command with argon2id
- GRUB configuration for ARM64
- mkinitcpio HOOKS order (keyboard before encrypt)

Style: Conceptual explanation followed by exact commands. No screenshots.
  </action>
  <verify>
Read hosts/endurance/README.md and confirm:
- All 7 steps documented with commands
- LUKS2 argon2id syntax correct
- GRUB ARM64 commands present
- mkinitcpio HOOKS documented
  </verify>
  <done>Complete VM creation documentation from Parallels setup through first successful boot</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Execute documented VM creation process</name>
  <action-required>
Follow the documentation in hosts/endurance/README.md to create the VM template:

1. Create VM in Parallels with documented settings
2. Boot archboot ISO
3. Partition disk (EFI + /boot + LUKS)
4. Set up LUKS2 encryption (you'll create the passphrase)
5. Run archinstall with pre_mounted_config
6. Configure GRUB with encrypt hook
7. Reboot and verify LUKS passphrase prompt works
  </action-required>
  <how-to-verify>
After completing the steps:
1. VM should prompt for LUKS passphrase on boot
2. After entering passphrase, system should decrypt and boot
3. You should be able to login as the user account
4. Run: `lsblk` - should show encrypted root
5. Run: `cat /proc/cmdline` - should show cryptdevice=UUID=...
  </how-to-verify>
  <resume-signal>Type "base install complete" when VM boots successfully with LUKS, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
After human completes VM creation:
- [ ] VM exists in Parallels named ArchBase-Template (or chosen name)
- [ ] `prlctl list -a` shows the VM
- [ ] VM boots and prompts for LUKS passphrase
- [ ] After decryption, login works
- [ ] Documentation matches what was actually done (update if needed)
</verification>

<success_criteria>
1. hosts/endurance/README.md contains complete VM creation documentation
2. VM template exists with LUKS encryption working
3. GRUB bootloader successfully decrypts and boots system
4. Documentation is accurate and reproducible
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-01-SUMMARY.md`
</output>
