---
phase: 01-vm-template-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/arch-arm-encrypted-install.md
  - docs/omarchy-grub-install.md
  - docs/template-generalization.md
autonomous: true

must_haves:
  truths:
    - "LUKS+GRUB installation steps are in a standalone, followable doc"
    - "Omarchy installation with GRUB preservation is in its own doc"
    - "Template generalization and cloning steps are in their own doc"
    - "Each doc has clear prerequisites and verification steps"
  artifacts:
    - path: "docs/arch-arm-encrypted-install.md"
      provides: "LUKS + GRUB base installation guide"
      contains: "cryptsetup luksFormat"
    - path: "docs/omarchy-grub-install.md"
      provides: "Omarchy + GRUB preservation guide"
      contains: "armarchy"
    - path: "docs/template-generalization.md"
      provides: "Template cleanup and cloning guide"
      contains: "prlctl clone"
  key_links:
    - from: "docs/arch-arm-encrypted-install.md"
      to: "docs/omarchy-grub-install.md"
      via: "Next Steps section"
      pattern: "omarchy-grub-install"
    - from: "docs/omarchy-grub-install.md"
      to: "docs/template-generalization.md"
      via: "Next Steps section"
      pattern: "template-generalization"
---

<objective>
Split the monolithic docs/rocinante-encrypted-install.md into three focused, single-purpose documentation files that can be followed independently and tested sequentially.

Purpose: Docs-first approach validates documentation is complete and followable before attempting implementation. Smaller docs are easier to maintain and test.

Output:
- docs/arch-arm-encrypted-install.md (~250 lines) - LUKS + GRUB base
- docs/omarchy-grub-install.md (~150 lines) - Omarchy + GRUB preservation
- docs/template-generalization.md (~100 lines) - Generalization + cloning
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@docs/rocinante-encrypted-install.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create arch-arm-encrypted-install.md</name>
  <files>docs/arch-arm-encrypted-install.md</files>
  <action>
Extract Steps 1-7 from rocinante-encrypted-install.md and restructure into a focused LUKS + GRUB installation guide:

1. **Prerequisites section** - archboot ISO download, Parallels requirements
2. **Step 1: Create VM** - Use scripts/create-arch-vm.sh (reference, don't duplicate)
3. **Step 2: Verify Network** - ip link, ping
4. **Step 3: Partition Disk** - fdisk commands for EFI + LUKS (2-partition scheme per CONTEXT.md)
5. **Step 4: Setup LUKS** - cryptsetup luksFormat (argon2id is fine with unencrypted /boot)
6. **Step 5: Install Base System** - pacstrap, genfstab, arch-chroot
7. **Step 6: Configure PAM** - pwquality.conf for Intune compliance
8. **Step 7: Configure GRUB** - mkinitcpio hooks, kernel symlink, grub-install
9. **Verification section** - How to confirm LUKS boot works
10. **Troubleshooting section** - Common issues (extract relevant ones from source)
11. **Next Steps** - Link to omarchy-grub-install.md

Key content to include:
- Arch Linux ARM mirror format ($arch/$repo not $repo/os/$arch)
- ARM kernel naming quirk (Image -> vmlinuz-linux symlink)
- HOOKS order in mkinitcpio.conf (keyboard before encrypt)
- GRUB_CMDLINE_LINUX with cryptdevice UUID
- Template passphrase pattern: use known passphrase (4815162342) during template creation

Do NOT include:
- Steps 8-12 (Omarchy, Rosetta, Nix, home-manager, chezmoi) - those go in other docs or are Phase 2
- Post-install verification for Intune - that's Phase 6

Target: ~250 lines, self-contained, can be followed without reading other docs.
  </action>
  <verify>
- File exists at docs/arch-arm-encrypted-install.md
- Contains: "cryptsetup luksFormat", "grub-install", "mkinitcpio"
- Has Prerequisites, numbered steps (1-7), Verification, Troubleshooting, Next Steps sections
- Does NOT contain: "armarchy", "home-manager", "chezmoi"
  </verify>
  <done>
A developer can follow arch-arm-encrypted-install.md from VM creation through first LUKS-encrypted boot with GRUB bootloader.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create omarchy-grub-install.md</name>
  <files>docs/omarchy-grub-install.md</files>
  <action>
Create a new document for installing Omarchy on an encrypted Arch ARM system while preserving GRUB (since armarchy installs Limine by default):

1. **Prerequisites section**
   - Working LUKS+GRUB system from arch-arm-encrypted-install.md
   - VM boots and decrypts successfully

2. **Step 1: Create Pre-Omarchy Snapshot**
   - Commands to shutdown VM and create Parallels snapshot
   - Why: Omarchy installs Limine which may break GRUB boot

3. **Step 2: Backup GRUB Configuration**
   - Copy /boot/grub to safe location
   - Copy /boot/vmlinuz-linux and initramfs
   - Why: armarchy will overwrite bootloader

4. **Step 3: Run Armarchy Installer**
   - curl -fsSL hdwy.link/armarchy-3-x | bash
   - Document expected prompts (username, password requirements from CONTEXT.md)
   - Note: Password must meet Intune requirements (12+ chars, complexity)

5. **Step 4: Restore GRUB Bootloader**
   - Restore GRUB files from backup
   - Regenerate grub-mkconfig
   - Verify initrd is in grub.cfg

6. **Verification section**
   - Reboot and verify LUKS passphrase prompt appears
   - Login to Hyprland desktop
   - Verify shared folders mount at /mnt/psf/

7. **Troubleshooting section**
   - What to do if Limine boots instead of GRUB
   - How to restore from snapshot
   - GRUB recovery from archboot ISO

8. **Next Steps** - Link to template-generalization.md

Key insight from CONTEXT.md: "armarchy PR #1897 installs Limine by default - must backup/restore GRUB"

Target: ~150 lines.
  </action>
  <verify>
- File exists at docs/omarchy-grub-install.md
- Contains: "armarchy", "snapshot", "grub", "backup", "restore"
- Has Prerequisites (references arch-arm-encrypted-install.md), numbered steps, Verification, Troubleshooting, Next Steps
- Snapshot step comes BEFORE running armarchy installer
  </verify>
  <done>
A developer can follow omarchy-grub-install.md to install Omarchy desktop while preserving GRUB bootloader for LUKS decryption.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create template-generalization.md</name>
  <files>docs/template-generalization.md</files>
  <action>
Create a document for generalizing the VM into a template and testing the clone workflow:

1. **Prerequisites section**
   - Working Omarchy system with GRUB+LUKS from previous docs
   - SSH key authentication configured (optional, for prlctl exec)

2. **Step 1: Generalize the System**
   - Clear machine-id (truncate, not rm - regenerates on boot)
   - Clear hostname or set to generic "archbase"
   - Remove SSH host keys (regenerate on first boot)
   - Clear shell history and pacman cache
   - Reference existing Generalize section from rocinante-encrypted-install.md

3. **Step 2: Shutdown and Create Final Snapshot**
   - shutdown -h now
   - prlctl snapshot commands
   - Name convention: "Template-Ready-YYYY-MM-DD"

4. **Step 3: Clone from Template**
   - prlctl clone command
   - Explain --name and --linked vs full clone

5. **Step 4: Configure Clone**
   - Set new hostname
   - Generate new SSH host keys
   - Change LUKS passphrase: cryptsetup luksChangeKey

6. **Verification section**
   - Boot cloned VM
   - Verify new machine-id generated
   - Verify hostname is correct
   - Verify SSH keys are different from template

7. **Troubleshooting section**
   - Clone fails to boot
   - How to revert to template

Target: ~100 lines.
  </action>
  <verify>
- File exists at docs/template-generalization.md
- Contains: "machine-id", "prlctl clone", "luksChangeKey"
- Has Prerequisites (references omarchy-grub-install.md), numbered steps, Verification, Troubleshooting
- Generalization steps come BEFORE snapshot
  </verify>
  <done>
A developer can follow template-generalization.md to prepare a template VM and create working clones.
  </done>
</task>

</tasks>

<verification>
All three docs are coherent and form a complete flow:
1. arch-arm-encrypted-install.md ends with "Next Steps: omarchy-grub-install.md"
2. omarchy-grub-install.md prerequisites reference arch-arm-encrypted-install.md, ends with "Next Steps: template-generalization.md"
3. template-generalization.md prerequisites reference omarchy-grub-install.md
4. No circular dependencies, no missing steps between docs
</verification>

<success_criteria>
- Three new doc files exist in docs/
- Each doc is self-contained with Prerequisites, Steps, Verification, Troubleshooting
- Docs link to each other in correct order
- Combined docs cover all essential content from rocinante-encrypted-install.md Steps 1-7 plus generalization
- No duplication of steps between docs
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-01-SUMMARY.md`
</output>
