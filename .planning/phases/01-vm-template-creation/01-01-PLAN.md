---
phase: 01-vm-template-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hosts/endurance/README.md
autonomous: false

must_haves:
  truths:
    - "VM boots with LUKS passphrase prompt"
    - "After entering passphrase, system reaches login prompt"
    - "SSH accessible from macOS host"
    - "Rosetta binary exists at /mnt/psf/RosettaLinux/rosetta"
  artifacts:
    - path: "scripts/create-arch-vm.sh"
      provides: "VM creation automation"
      exists: true
    - path: "scripts/install-arch.sh"
      provides: "Arch installation automation"
      exists: true
    - path: "scripts/vm-type.sh"
      provides: "VM keyboard input helper"
      exists: true
  key_links:
    - from: "macOS terminal"
      to: "VM console"
      via: "prlctl start + Parallels GUI"
    - from: "install-arch.sh"
      to: "archinstall"
      via: "curl pipe to bash"
      verify: "/boot/grub/grub.cfg exists after completion"
  notes:
    - "GRUB chosen per RESEARCH.md: Only bootloader supporting LUKS decrypt at boot. Limine does not support dm-crypt/LUKS decryption."
---

<objective>
Create and boot an encrypted Arch Linux ARM VM using existing automation scripts.

Purpose: Establish the encrypted base system that Omarchy will be installed onto. LUKS encryption is required for Intune compliance.

Output: Running VM with LUKS-encrypted root, GRUB bootloader, SSH enabled, and Rosetta mount available.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md

@hosts/endurance/README.md
@scripts/create-arch-vm.sh
@scripts/install-arch.sh
@scripts/vm-type.sh
@scripts/VM-KEYBOARD.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download archboot ISO and create VM</name>
  <files>N/A - external downloads and prlctl commands</files>
  <action>
    1. Check if archboot ISO exists in ~/Downloads, if not provide download link:
       https://archboot.com/iso/aarch64/latest/

    2. Run create-arch-vm.sh to create and configure VM:
       ```
       cd ~/Documents/dotfiles
       ./scripts/create-arch-vm.sh ArchBase-Template
       ```
       This configures: 4 CPUs, 8GB RAM, 128GB disk, Rosetta ON, shared folders, bridged networking.

    3. Start the VM:
       ```
       prlctl start ArchBase-Template
       ```

    4. Wait for archboot to fully boot (1-2 minutes). Use `prlctl status ArchBase-Template` to verify running.
  </action>
  <verify>
    `prlctl list -a | grep ArchBase-Template` shows "running" state
  </verify>
  <done>VM is running with archboot live environment</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User opens VM console in Parallels</name>
  <action>Open Parallels Desktop GUI and double-click on ArchBase-Template to open console window</action>
  <instructions>
    The archboot ISO should have booted to a shell prompt. This typically takes 1-2 minutes.

    1. Open Parallels Desktop application
    2. Double-click "ArchBase-Template" to open its console window
    3. Wait until you see a shell prompt (root@archboot or similar)

    The VM console must be focused for keyboard input to work.
  </instructions>
  <resume-signal>Type "ready" when you see the archboot shell prompt</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Run automated installation script</name>
  <files>N/A - commands typed into VM via prlctl</files>
  <action>
    Use vm-type.sh to type the installation command into the VM console. The command fetches and runs install-arch.sh which handles:
    - Disk partitioning (EFI + /boot + LUKS)
    - LUKS2 encryption with argon2id
    - archinstall with pre_mounted_config
    - GRUB configuration with encrypt hook
    - SSH and NetworkManager enabled

    Type the command character by character using vm-type.sh (this is slow but reliable):
    ```
    cd ~/Documents/dotfiles
    ./scripts/vm-type.sh "curl -fsSL https://raw.githubusercontent.com/andrey-moor/dotfiles/main/scripts/install-arch.sh | bash"
    ```

    Then press Enter:
    ```
    prlctl send-key-event ArchBase-Template --scancode 28 --delay 100
    ```

    IMPORTANT: The script uses temppass for LUKS, user, and root passwords. These MUST be changed after first boot.

    The installation takes 5-10 minutes. archinstall will prompt for locale confirmation - press Enter to accept defaults when prompted.
  </action>
  <verify>
    Watch VM console for "Installation Complete!" message.
    The script ends with reboot instructions.
    Confirm archinstall completed by checking for /boot/grub/grub.cfg existence in the installed system (visible after reboot in Task 4).
  </verify>
  <done>Installation script completed successfully, archinstall ran and created GRUB configuration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify LUKS boot and SSH access</name>
  <what-built>Encrypted Arch Linux installation with GRUB bootloader and SSH</what-built>
  <how-to-verify>
    1. In VM console, type `reboot` and press Enter
    2. Watch for GRUB bootloader
    3. Verify LUKS passphrase prompt appears (enter: temppass)
    4. Verify system boots to login prompt
    5. Login as user (password: temppass)
    6. Verify archinstall completed properly:
       ```
       ls -la /boot/grub/grub.cfg  # Should exist
       cat /etc/fstab              # Should show cryptroot mount
       ```
    7. Get VM IP address: `ip addr | grep inet`
    8. From macOS terminal, test SSH: `ssh user@<VM_IP>` (password: temppass)
    9. Verify Rosetta mount: `ls /mnt/psf/RosettaLinux/rosetta`

    Expected outcomes:
    - LUKS passphrase prompt appears after GRUB
    - System boots after correct passphrase
    - /boot/grub/grub.cfg exists (confirms archinstall + GRUB setup worked)
    - SSH connection works from macOS
    - Rosetta binary exists at expected path
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe any issues</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 5: User changes default passwords</name>
  <action>User changes LUKS passphrase and user password from temppass to secure values</action>
  <instructions>
    SECURITY CRITICAL: Change the temporary passwords immediately!

    In the VM (logged in as user):

    1. Change LUKS passphrase:
       ```
       sudo cryptsetup luksChangeKey /dev/sda3
       ```
       - Enter current passphrase: temppass
       - Enter new passphrase: (your secure passphrase)
       - Verify new passphrase

    2. Change user password:
       ```
       passwd
       ```
       - Enter current password: temppass
       - Enter new password: (your secure password)

    3. Optionally change root password:
       ```
       sudo passwd root
       ```

    Requirements for Intune compliance (Phase 6):
    - 12+ characters
    - 1 uppercase, 1 lowercase, 1 number, 1 symbol
  </instructions>
  <resume-signal>Type "secured" when passwords have been changed</resume-signal>
</task>

</tasks>

<verification>
Phase 1 base installation verification:

```bash
# From macOS
prlctl list -a | grep ArchBase-Template  # Should show "running"
ssh user@<VM_IP> "lsblk"                  # Should show sda3 -> crypt -> cryptroot

# From VM
cat /proc/cmdline | grep cryptdevice      # Should show cryptdevice=UUID=...
ls -la /boot/grub/grub.cfg                # Should exist (confirms archinstall ran)
systemctl status sshd                     # Should be active
ls /mnt/psf/RosettaLinux/rosetta          # Should exist
```
</verification>

<success_criteria>
1. VM boots with LUKS passphrase prompt (GRUB + encrypt hook working)
2. System reaches login after correct passphrase
3. SSH accessible from macOS host
4. Rosetta binary exists at /mnt/psf/RosettaLinux/rosetta
5. Temporary passwords changed to secure values
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-01-SUMMARY.md`
</output>
