---
phase: 01-vm-template-creation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - hosts/endurance/README.md
autonomous: false

must_haves:
  truths:
    - "Omarchy desktop environment launches after login"
    - "Hyprland compositor is running"
    - "GRUB bootloader preserved (not replaced by Limine)"
    - "LUKS decryption still works at boot"
  artifacts:
    - path: "N/A - installed in VM"
      provides: "Omarchy desktop packages"
  key_links:
    - from: "greetd/tuigreet"
      to: "Hyprland"
      via: "session launch"
    - from: "armarchy installer"
      to: "Omarchy packages"
      via: "curl pipe to bash"
  notes:
    - "CRITICAL: armarchy PR #1897 installs Limine bootloader, which does NOT support LUKS decryption"
    - "We must preserve GRUB by backing up before armarchy and restoring after"
    - "The vmlinuz-linux -> Image symlink must also be preserved for grub-mkconfig"
---

<objective>
Install Omarchy desktop environment while preserving the GRUB bootloader required for LUKS decryption.

Purpose: Omarchy provides the Hyprland-based desktop environment. However, the armarchy installer replaces GRUB with Limine bootloader, which doesn't support LUKS. We must backup GRUB, run armarchy, then restore GRUB.

Output: VM with fully functional Omarchy desktop, graphical login, Hyprland compositor, AND working LUKS boot via GRUB.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md

@docs/arch-arm-encrypted-install.md (GRUB reference for backup/restore)
@docs/omarchy-grub-install.md (armarchy + GRUB preservation - will be created)
</context>

<tasks>

<task type="auto">
  <name>Task 1: SSH into VM and prepare for Omarchy</name>
  <files>N/A - commands in VM</files>
  <action>
    Get VM IP and SSH in:

    ```bash
    # From macOS - get VM IP
    VM_IP=$(prlctl exec ArchBase-Template "ip -4 addr show enp0s5 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1")
    echo "VM IP: $VM_IP"

    # If prlctl exec doesn't work (not fully booted), use VM console to run:
    # ip addr | grep inet

    # SSH into VM
    ssh root@$VM_IP
    ```

    If SSH fails, use VM console directly via Parallels.

    Update the system first:
    ```bash
    pacman -Syu --noconfirm
    pacman -S --noconfirm wget git
    ```
  </action>
  <verify>
    SSH connection established OR using VM console
    git is installed
  </verify>
  <done>Connected to VM and system updated</done>
</task>

<task type="auto">
  <name>Task 2: Backup GRUB bootloader before armarchy</name>
  <files>N/A - commands in VM</files>
  <action>
    CRITICAL: armarchy will install Limine and potentially remove GRUB.
    We must backup everything needed to restore GRUB.

    ```bash
    # Create backup directory
    mkdir -p /root/grub-backup

    # Backup GRUB directory
    cp -a /boot/grub /root/grub-backup/

    # Backup EFI GRUB entry
    cp -a /boot/EFI /root/grub-backup/

    # Backup GRUB default config
    cp /etc/default/grub /root/grub-backup/

    # Backup mkinitcpio config (has encrypt hook)
    cp /etc/mkinitcpio.conf /root/grub-backup/

    # Backup vconsole.conf
    cp /etc/vconsole.conf /root/grub-backup/

    # Backup the vmlinuz-linux symlink/copy
    ls -la /boot/vmlinuz-linux
    cp /boot/vmlinuz-linux /root/grub-backup/

    # Record what packages are installed for bootloader
    pacman -Q grub efibootmgr > /root/grub-backup/packages.txt

    # Verify backup
    ls -la /root/grub-backup/
    ```
  </action>
  <verify>
    /root/grub-backup/grub/ directory exists
    /root/grub-backup/EFI/ directory exists
    /root/grub-backup/grub (default config) exists
    /root/grub-backup/vmlinuz-linux exists
  </verify>
  <done>GRUB bootloader fully backed up</done>
</task>

<task type="auto">
  <name>Task 3: Run armarchy installer</name>
  <files>N/A - commands in VM</files>
  <action>
    Reference: docs/rocinante-encrypted-install.md Step 8

    Run armarchy. It will:
    - Create a non-root user with sudo
    - Install Hyprland desktop environment
    - Install Limine bootloader (we'll restore GRUB after)
    - Configure greetd login manager
    - Reboot

    ```bash
    # Run armarchy installer
    curl -fsSL hdwy.link/armarchy-3-x | bash
    ```

    Alternative if short URL fails:
    ```bash
    wget -qO- https://raw.githubusercontent.com/jondkinney/armarchy/armarchy-3-x/boot.sh | \
      OMARCHY_REPO=jondkinney/armarchy OMARCHY_REF=armarchy-3-x bash
    ```

    When prompted:
    - Enter username for new user
    - Enter password (must meet Intune requirements: 12+ chars, mixed case, number, symbol)
    - Answer any configuration questions

    NOTE: armarchy will reboot. That's OK - we'll restore GRUB after.
  </action>
  <verify>
    Installer runs without fatal errors
    User creation prompts appear
    System reboots (expected)
  </verify>
  <done>Armarchy installer completed and system rebooting</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 4: Handle potential Limine boot failure</name>
  <action>User intervenes if VM fails to boot with Limine</action>
  <instructions>
    After armarchy reboots, the VM may fail to boot because:
    - Limine was installed but doesn't support LUKS decryption
    - You won't see a passphrase prompt - just a boot failure

    **If boot fails (kernel panic, no passphrase prompt):**
    1. Power off the VM: From macOS: `prlctl stop ArchBase-Template --kill`
    2. Connect archboot ISO: `prlctl set ArchBase-Template --device-set cdrom0 --image ~/Downloads/archboot*.iso --connect`
    3. Start VM: `prlctl start ArchBase-Template`
    4. Boot from archboot ISO
    5. Continue to Task 5 to restore GRUB

    **If boot succeeds (shows LUKS passphrase prompt):**
    - armarchy may not have replaced the bootloader after all
    - Enter passphrase and login
    - Skip to Task 6 to verify Omarchy works

    Either way, we need to ensure GRUB is properly installed.
  </instructions>
  <resume-signal>Type "boot failed" if Limine failed, or "boot succeeded" if LUKS prompt appeared</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Restore GRUB bootloader from backup</name>
  <files>N/A - commands in VM (via archboot or SSH)</files>
  <action>
    This task runs if boot failed. Skip if LUKS prompt appeared.

    From archboot ISO:
    ```bash
    # Open LUKS partition
    cryptsetup open /dev/sda2 cryptroot
    # Enter passphrase

    # Mount filesystems
    mount /dev/mapper/cryptroot /mnt
    mount /dev/sda1 /mnt/boot

    # Chroot
    arch-chroot /mnt
    ```

    Restore GRUB from backup:
    ```bash
    # Reinstall grub and efibootmgr if removed
    pacman -S --noconfirm grub efibootmgr

    # Restore mkinitcpio config (encrypt hook)
    cp /root/grub-backup/mkinitcpio.conf /etc/mkinitcpio.conf
    cp /root/grub-backup/vconsole.conf /etc/vconsole.conf

    # Regenerate initramfs with encrypt hook
    mkinitcpio -P

    # Restore vmlinuz-linux (ARM kernel copy)
    cp /root/grub-backup/vmlinuz-linux /boot/vmlinuz-linux

    # Restore GRUB default config
    cp /root/grub-backup/grub /etc/default/grub

    # Reinstall GRUB to EFI
    grub-install --target=arm64-efi --efi-directory=/boot --bootloader-id=GRUB

    # Regenerate GRUB config
    grub-mkconfig -o /boot/grub/grub.cfg
    # Verify: "Found linux image" AND "Found initrd image"

    # Verify initrd in config
    grep "initrd" /boot/grub/grub.cfg

    # Remove Limine from EFI if it exists
    rm -rf /boot/EFI/BOOT 2>/dev/null || true
    rm -rf /boot/EFI/limine 2>/dev/null || true
    rm -f /boot/limine* 2>/dev/null || true

    # Exit chroot
    exit

    # Unmount
    umount -R /mnt

    # Disconnect ISO
    # From macOS: prlctl set ArchBase-Template --device-set cdrom0 --disconnect

    # Reboot
    reboot
    ```
  </action>
  <verify>
    grub-install succeeds
    grub-mkconfig shows both linux image and initrd
    Limine files removed from /boot
  </verify>
  <done>GRUB restored and Limine removed</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 6: Verify LUKS boot and Omarchy desktop</name>
  <what-built>Omarchy desktop with preserved GRUB bootloader</what-built>
  <how-to-verify>
    1. VM should boot with GRUB menu
    2. LUKS passphrase prompt appears
    3. Enter passphrase
    4. greetd/tuigreet login screen appears
    5. Login with the user created by armarchy
    6. Hyprland desktop should launch

    Test Omarchy functionality:
    - Super+Enter: Opens Alacritty terminal
    - Super+D: Opens rofi application launcher
    - Super+Q: Closes focused window

    In terminal, verify:
    ```bash
    # Check Hyprland is running
    pgrep -x Hyprland

    # Check session type
    echo $XDG_SESSION_TYPE
    # Should show: wayland

    # Check greetd is enabled
    systemctl is-enabled greetd

    # Verify GRUB is the bootloader (not Limine)
    ls /boot/EFI/
    # Should show GRUB directory, NOT limine

    # Verify LUKS is still working
    lsblk -f | grep crypt
    ```
  </how-to-verify>
  <resume-signal>Type "omarchy works" if desktop and LUKS boot both work, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 7: Final verification and cleanup</name>
  <files>N/A - commands in VM</files>
  <action>
    SSH into VM and run final checks:

    ```bash
    ssh user@$VM_IP
    ```

    Verify all components:
    ```bash
    # Desktop packages
    pacman -Q hyprland waybar rofi dunst alacritty

    # Bootloader is GRUB (not Limine)
    ls /boot/EFI/GRUB/
    [ ! -d /boot/EFI/limine ] && echo "Limine not present - good"

    # Encryption working
    sudo cryptsetup status cryptroot

    # greetd enabled
    systemctl is-enabled greetd

    # Clean up backup (optional - keep for safety)
    # sudo rm -rf /root/grub-backup
    ```

    Keep the GRUB backup for now - useful if future updates break boot.
  </action>
  <verify>
    All Omarchy packages installed
    GRUB present in /boot/EFI/GRUB/
    Limine NOT present in /boot/EFI/
    cryptroot active
    greetd enabled
  </verify>
  <done>Omarchy installed with GRUB preserved</done>
</task>

</tasks>

<verification>
Omarchy installation with GRUB preservation verification:

```bash
# From VM terminal (logged in as user)
pacman -Q hyprland waybar rofi alacritty  # All installed
systemctl is-enabled greetd               # enabled
echo $XDG_SESSION_TYPE                    # wayland
pgrep -x Hyprland                         # Returns PID

# Bootloader verification
ls /boot/EFI/GRUB/grubaa64.efi           # Exists
[ ! -f /boot/limine.conf ] && echo "No Limine"

# Encryption verification
sudo cryptsetup status cryptroot          # Shows active LUKS2
```
</verification>

<success_criteria>
1. Omarchy desktop environment launches after login
2. Hyprland compositor is running
3. GRUB bootloader preserved (LUKS passphrase prompt at boot)
4. greetd login manager enabled
5. Standard Omarchy keybindings work
6. No Limine bootloader files in /boot
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-02-SUMMARY.md`
</output>
