---
phase: 01-vm-template-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hosts/endurance/README.md
autonomous: false

must_haves:
  truths:
    - "VM boots with LUKS passphrase prompt"
    - "After entering passphrase, system reaches login prompt"
    - "GRUB bootloader installed with encrypt hook"
    - "Rosetta binary exists at /mnt/psf/RosettaLinux/rosetta"
    - "Shared folders mount dotfiles at /mnt/psf/Home/Documents/dotfiles"
  artifacts:
    - path: "scripts/create-arch-vm.sh"
      provides: "VM creation automation"
      exists: true
    - path: "scripts/prl-type.sh"
      provides: "VM keyboard input helper"
      exists: true
    - path: "docs/arch-arm-encrypted-install.md"
      provides: "Manual installation reference"
      exists: false
      note: "Will be created from rocinante-encrypted-install.md Steps 1-7"
  key_links:
    - from: "macOS terminal"
      to: "VM console"
      via: "prlctl start + Parallels GUI"
    - from: "pacstrap"
      to: "base system"
      via: "manual installation"
      verify: "/boot/grub/grub.cfg exists after completion"
  notes:
    - "GRUB chosen per RESEARCH.md: Only bootloader supporting LUKS decrypt at boot. Limine does not support dm-crypt/LUKS decryption."
    - "Manual pacstrap approach proven in docs/arch-arm-encrypted-install.md - archinstall approach failed during previous attempt"
    - "ARM kernel naming: 'Image' not 'vmlinuz-linux' - requires copy for grub-mkconfig to find initramfs"
---

<objective>
Create and boot an encrypted Arch Linux ARM VM using manual pacstrap installation.

Purpose: Establish the encrypted base system with GRUB bootloader that Omarchy will be installed onto. LUKS encryption is required for Intune compliance. GRUB is required because Limine does not support LUKS decryption at boot.

Output: Running VM with LUKS-encrypted root, GRUB bootloader with encrypt hook, and Rosetta mount available.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md

@docs/arch-arm-encrypted-install.md (LUKS + GRUB base installation)
@scripts/create-arch-vm.sh
@scripts/prl-type.sh
@scripts/VM-KEYBOARD.md
</context>

<tasks>

<task type="auto">
  <name>Task 0: Verify prl-type.sh works correctly</name>
  <files>scripts/prl-type.sh</files>
  <action>
    Before using prl-type.sh extensively, verify it works with shifted characters.

    1. Ensure VM is running with a shell prompt visible
    2. Test the script:
       ```bash
       cd ~/Documents/dotfiles
       ./scripts/prl-type.sh "TEST: @#$ /dev/sda2"
       ```
    3. Capture screenshot to verify:
       ```bash
       prlctl capture ArchBase-Template --file /tmp/vmtype-test.png
       open /tmp/vmtype-test.png
       ```
    4. Verify colons, uppercase, and symbols appear correctly

    If characters are garbled, check the shift timing fix in send_shifted_key().

    **Alternative:** Skip this task and type commands manually in Parallels console.
  </action>
  <verify>
    Screenshot shows "TEST: @#$ /dev/sda2" with correct characters
  </verify>
  <done>prl-type.sh verified working OR decided to use manual typing</done>
</task>

<task type="auto">
  <name>Task 1: Download archboot ISO and create VM</name>
  <files>N/A - external downloads and prlctl commands</files>
  <action>
    1. Check if archboot ISO exists in ~/Downloads, if not provide download link:
       https://archboot.com/iso/aarch64/latest/

    2. Run create-arch-vm.sh to create and configure VM:
       ```
       cd ~/Documents/dotfiles
       ./scripts/create-arch-vm.sh ArchBase-Template
       ```
       This configures: 4 CPUs, 8GB RAM, 128GB disk, Rosetta ON, shared folders, bridged networking.

    3. Start the VM:
       ```
       prlctl start ArchBase-Template
       ```

    4. Wait for archboot to fully boot (1-2 minutes). Use `prlctl status ArchBase-Template` to verify running.
  </action>
  <verify>
    `prlctl list -a | grep ArchBase-Template` shows "running" state
  </verify>
  <done>VM is running with archboot live environment</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User opens VM console in Parallels</name>
  <action>Open Parallels Desktop GUI and double-click on ArchBase-Template to open console window</action>
  <instructions>
    The archboot ISO should have booted to a shell prompt. This typically takes 1-2 minutes.

    1. Open Parallels Desktop application
    2. Double-click "ArchBase-Template" to open its console window
    3. Wait until you see a shell prompt (root@archboot or similar)

    The VM console must be focused for keyboard input to work.
  </instructions>
  <resume-signal>Type "ready" when you see the archboot shell prompt</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify network connectivity</name>
  <files>N/A - commands typed into VM via prlctl</files>
  <action>
    Use prl-type.sh to type commands. Reference: docs/rocinante-encrypted-install.md Step 2

    ```bash
    cd ~/Documents/dotfiles
    ./scripts/prl-type.sh "ip link"
    prlctl send-key-event ArchBase-Template --scancode 28 --delay 100  # Enter

    ./scripts/prl-type.sh "ping -c 3 archlinux.org"
    prlctl send-key-event ArchBase-Template --scancode 28 --delay 100  # Enter
    ```

    If network not working, type: `dhcpcd enp0s5`
  </action>
  <verify>
    Ping to archlinux.org succeeds (visible in VM console)
  </verify>
  <done>Network connectivity verified</done>
</task>

<task type="auto">
  <name>Task 4: Partition disk with fdisk</name>
  <files>N/A - commands typed into VM</files>
  <action>
    Reference: docs/rocinante-encrypted-install.md Step 3

    Two partitions needed:
    - Partition 1: EFI System Partition (512MB) - /boot
    - Partition 2: LUKS encrypted root (rest of disk)

    Type commands using prl-type.sh:

    ```bash
    # List block devices to confirm disk name
    ./scripts/prl-type.sh "lsblk"
    prlctl send-key-event ArchBase-Template --scancode 28 --delay 100

    # Start fdisk
    ./scripts/prl-type.sh "fdisk /dev/sda"
    prlctl send-key-event ArchBase-Template --scancode 28 --delay 100
    ```

    In fdisk (type each command then Enter):
    - `g` (create GPT table)
    - `n`, Enter, Enter, `+512M` (EFI partition)
    - `t`, `1` (change type to EFI System)
    - `n`, Enter, Enter, Enter (root partition - rest of disk)
    - `w` (write and exit)

    ```bash
    # Format EFI partition
    ./scripts/prl-type.sh "mkfs.fat -F32 /dev/sda1"
    prlctl send-key-event ArchBase-Template --scancode 28 --delay 100
    ```
  </action>
  <verify>
    `lsblk` shows sda1 (512M) and sda2 (remaining)
  </verify>
  <done>Disk partitioned for EFI + LUKS</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 5: Setup LUKS encryption (requires passphrase entry)</name>
  <action>User types LUKS passphrase in VM console</action>
  <instructions>
    LUKS setup requires manual passphrase entry. Reference: docs/rocinante-encrypted-install.md Step 4

    In the VM console, run these commands:

    ```bash
    # Setup LUKS2 encryption
    cryptsetup luksFormat --type luks2 \
      --cipher aes-xts-plain64 \
      --key-size 512 \
      --hash sha512 \
      --iter-time 5000 \
      /dev/sda2
    ```

    - Type YES (uppercase) when prompted
    - Enter your LUKS passphrase (use a STRONG one - you'll need it every boot)
    - Confirm the passphrase

    Then open the encrypted partition:

    ```bash
    cryptsetup open /dev/sda2 cryptroot
    # Enter passphrase again
    ```

    Then format and mount:

    ```bash
    mkfs.btrfs /dev/mapper/cryptroot
    mount /dev/mapper/cryptroot /mnt
    mkdir -p /mnt/boot
    mount /dev/sda1 /mnt/boot
    ```

    Requirements for Intune compliance (Phase 6):
    - 12+ characters recommended
    - Mix of uppercase, lowercase, numbers, symbols
  </instructions>
  <resume-signal>Type "encrypted" when cryptroot is mounted at /mnt</resume-signal>
</task>

<task type="auto">
  <name>Task 6: Configure mirrors and pacstrap base system</name>
  <files>N/A - commands in VM</files>
  <action>
    Reference: docs/rocinante-encrypted-install.md Step 5

    Type commands in VM (or use prl-type.sh for simple commands):

    ```bash
    # Configure Arch Linux ARM mirrors
    cat > /etc/pacman.d/mirrorlist << 'EOF'
    Server = http://ca.us.mirror.archlinuxarm.org/$arch/$repo
    Server = http://fl.us.mirror.archlinuxarm.org/$arch/$repo
    Server = http://mirror.archlinuxarm.org/$arch/$repo
    EOF

    # Verify mirror works
    curl -I http://ca.us.mirror.archlinuxarm.org/aarch64/core/core.db

    # Install base packages
    pacstrap /mnt base linux linux-firmware btrfs-progs sudo networkmanager libpwquality

    # Generate fstab
    genfstab -U /mnt >> /mnt/etc/fstab
    ```
  </action>
  <verify>
    pacstrap completes without error
    /mnt/etc/fstab exists and shows cryptroot mount
  </verify>
  <done>Base system installed via pacstrap</done>
</task>

<task type="auto">
  <name>Task 7: Chroot and configure system basics</name>
  <files>N/A - commands in VM</files>
  <action>
    Reference: docs/rocinante-encrypted-install.md Step 5 (continued)

    ```bash
    # Chroot into new system
    arch-chroot /mnt

    # Set timezone
    ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
    hwclock --systohc

    # Set locale
    echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
    locale-gen
    echo "LANG=en_US.UTF-8" > /etc/locale.conf

    # Set hostname (temporary - will be cleared during generalization)
    echo "archbase" > /etc/hostname

    # Set root password (temporary)
    passwd
    # Enter a temporary password
    ```
  </action>
  <verify>
    Running inside chroot (prompt shows /mnt root)
    /etc/hostname contains "archbase"
  </verify>
  <done>System basics configured in chroot</done>
</task>

<task type="auto">
  <name>Task 8: Configure PAM password policy</name>
  <files>N/A - commands in VM</files>
  <action>
    Reference: docs/rocinante-encrypted-install.md Step 6

    ```bash
    # Create password quality config for Intune compliance
    cat > /etc/security/pwquality.conf << 'EOF'
    # Microsoft Intune compliance requirements
    minlen = 12
    dcredit = -1
    ucredit = -1
    lcredit = -1
    ocredit = -1
    EOF
    ```
  </action>
  <verify>
    /etc/security/pwquality.conf exists
  </verify>
  <done>Password policy configured for Intune compliance</done>
</task>

<task type="auto">
  <name>Task 9: Install and configure GRUB with LUKS support</name>
  <files>N/A - commands in VM</files>
  <action>
    Reference: docs/rocinante-encrypted-install.md Step 7

    CRITICAL: This is where the archinstall approach failed. Follow exactly:

    ```bash
    # Install bootloader packages
    pacman -S grub efibootmgr

    # Configure mkinitcpio for encryption (order matters!)
    sed -i 's/^HOOKS=.*/HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block encrypt filesystems fsck)/' /etc/mkinitcpio.conf

    # Create vconsole.conf (required by consolefont hook)
    echo "KEYMAP=us" > /etc/vconsole.conf

    # Regenerate initramfs
    mkinitcpio -P

    # CRITICAL: ARM kernel is 'Image' not 'vmlinuz-linux'
    # Without this copy, grub-mkconfig won't find initramfs!
    cp /boot/Image /boot/vmlinuz-linux

    # Get UUID of encrypted partition
    blkid -s UUID -o value /dev/sda2
    # Note this UUID!

    # Configure GRUB - replace <UUID> with actual value
    sed -i 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX="cryptdevice=UUID=<UUID>:cryptroot root=\/dev\/mapper\/cryptroot"/' /etc/default/grub

    # Install GRUB
    grub-install --target=arm64-efi --efi-directory=/boot --bootloader-id=GRUB

    # Generate GRUB config
    grub-mkconfig -o /boot/grub/grub.cfg
    # MUST show: Found linux image AND Found initrd image

    # Verify initrd is in config
    grep "initrd" /boot/grub/grub.cfg
    # Must show: initrd /initramfs-linux.img

    # Enable NetworkManager
    systemctl enable NetworkManager
    ```
  </action>
  <verify>
    grub-install succeeds
    grub-mkconfig shows "Found linux image" AND "Found initrd image"
    grep "initrd" /boot/grub/grub.cfg returns results
  </verify>
  <done>GRUB installed with LUKS support</done>
</task>

<task type="auto">
  <name>Task 10: Exit chroot and reboot</name>
  <files>N/A - commands in VM</files>
  <action>
    ```bash
    # Exit chroot
    exit

    # Unmount
    umount -R /mnt

    # Disconnect ISO from VM (from macOS)
    prlctl set ArchBase-Template --device-set cdrom0 --disconnect

    # Reboot
    reboot
    ```
  </action>
  <verify>
    VM reboots without ISO
  </verify>
  <done>System rebooting to installed GRUB</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 11: Verify LUKS boot works</name>
  <what-built>Encrypted Arch Linux base system with GRUB bootloader</what-built>
  <how-to-verify>
    1. Watch VM console for GRUB bootloader menu
    2. Verify LUKS passphrase prompt appears
    3. Enter your LUKS passphrase
    4. Verify system boots to login prompt

    If boot fails with kernel panic:
    - Boot from archboot ISO
    - Follow troubleshooting in docs/rocinante-encrypted-install.md
    - Check if /boot/vmlinuz-linux exists (ARM kernel copy)
    - Check if initrd is in grub.cfg

    After login as root, verify:
    ```bash
    # Check LUKS status
    cryptsetup status cryptroot

    # Check GRUB config has encryption
    cat /proc/cmdline | grep cryptdevice

    # Check shared folders mount (VM-03, VM-06)
    ls /mnt/psf/
    ls /mnt/psf/Home/Documents/dotfiles  # Dotfiles should be accessible

    # Check Rosetta mount (VM-04)
    ls /mnt/psf/RosettaLinux/rosetta
    ```
  </how-to-verify>
  <resume-signal>Type "boots" if LUKS decrypt and login work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Plan 01 verification:

```bash
# From VM (logged in as root)
cryptsetup status cryptroot        # Shows LUKS2 active
cat /proc/cmdline | grep cryptdevice  # Shows cryptdevice=UUID=...
ls -la /boot/grub/grub.cfg         # Exists
ls -la /boot/vmlinuz-linux         # Exists (copy of Image)
systemctl is-enabled NetworkManager # Shows enabled
```
</verification>

<success_criteria>
1. VM boots with LUKS passphrase prompt (GRUB + encrypt hook working)
2. System reaches login after correct passphrase
3. GRUB properly configured with initramfs loading
4. Base system ready for Omarchy installation
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-01-SUMMARY.md`
</output>
