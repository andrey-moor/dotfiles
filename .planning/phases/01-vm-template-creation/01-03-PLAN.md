---
phase: 01-vm-template-creation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - hosts/endurance/README.md
  - scripts/generalize-template.sh
autonomous: false

must_haves:
  truths:
    - "Template can be cloned to create new VM"
    - "Cloned VM boots with unique identifiers"
    - "SSH host keys regenerate on first boot of clone"
    - "Documentation covers entire template creation process"
  artifacts:
    - path: "scripts/generalize-template.sh"
      provides: "Template generalization automation"
    - path: "hosts/endurance/README.md"
      provides: "Complete setup documentation"
      contains: "Template Generalization"
  key_links:
    - from: "prlctl clone"
      to: "new VM"
      via: "Parallels cloning"
    - from: "machine-id"
      to: "first boot"
      via: "systemd regeneration"
---

<objective>
Generalize the VM template for cloning and document the complete process.

Purpose: A template must be generalized (machine-specific data removed) before cloning, otherwise all clones share SSH keys, machine IDs, and other unique identifiers. Documentation ensures the process can be repeated.

Output: Clean template ready for cloning, tested clone workflow, and updated README documentation.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md

@hosts/endurance/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template generalization script</name>
  <files>scripts/generalize-template.sh</files>
  <action>
    Create a script that removes machine-specific data from the VM before converting to template.

    The script should be run inside the VM (via SSH or console) and cleans:
    - machine-id (regenerates on first boot)
    - SSH host keys (regenerate on first boot)
    - hostname (set during clone customization)
    - shell history
    - systemd journal logs
    - any temporary files

    Create the script at scripts/generalize-template.sh:

    ```bash
    #!/usr/bin/env bash
    # Generalize Arch Linux VM for use as template
    # Run inside VM before shutting down for template conversion
    #
    # Usage: sudo ./generalize-template.sh

    set -euo pipefail

    if [[ $EUID -ne 0 ]]; then
        echo "This script must be run as root" >&2
        exit 1
    fi

    echo "Generalizing VM for template use..."

    # Clear machine ID (systemd regenerates on first boot)
    echo "Clearing machine-id..."
    truncate -s 0 /etc/machine-id
    rm -f /var/lib/dbus/machine-id
    ln -sf /etc/machine-id /var/lib/dbus/machine-id

    # Clear hostname (set during clone personalization)
    echo "Clearing hostname..."
    truncate -s 0 /etc/hostname

    # Remove SSH host keys (sshd regenerates on first start)
    echo "Removing SSH host keys..."
    rm -f /etc/ssh/ssh_host_*

    # Clear shell history for all users
    echo "Clearing shell history..."
    rm -f /root/.bash_history /root/.zsh_history
    for home in /home/*; do
        rm -f "$home/.bash_history" "$home/.zsh_history" 2>/dev/null || true
    done

    # Clear systemd journal
    echo "Clearing journal logs..."
    journalctl --rotate 2>/dev/null || true
    journalctl --vacuum-time=1s 2>/dev/null || true

    # Clear temporary files
    echo "Clearing temporary files..."
    rm -rf /tmp/* /var/tmp/* 2>/dev/null || true

    # Clear package cache (optional, saves space)
    echo "Clearing package cache..."
    pacman -Scc --noconfirm 2>/dev/null || true

    echo ""
    echo "Generalization complete!"
    echo ""
    echo "Next steps:"
    echo "  1. Shutdown VM: sudo poweroff"
    echo "  2. In macOS: prlctl set ArchBase-Template --template on"
    echo "  3. Clone: prlctl clone ArchBase-Template --name NewVM"
    echo ""
    ```

    Make it executable and copy to VM for later use.
  </action>
  <verify>
    File exists at scripts/generalize-template.sh
    File is executable (chmod +x)
  </verify>
  <done>Generalization script created and ready</done>
</task>

<task type="auto">
  <name>Task 2: Run generalization and shut down template</name>
  <files>N/A - commands in VM</files>
  <action>
    Copy the generalization script to the VM and run it.

    From macOS:
    ```bash
    # Get VM IP (if not known)
    VM_IP=$(prlctl exec ArchBase-Template ip -4 addr show enp0s5 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)

    # Copy script to VM
    scp ~/Documents/dotfiles/scripts/generalize-template.sh user@$VM_IP:/tmp/

    # SSH into VM
    ssh user@$VM_IP
    ```

    In the VM:
    ```bash
    # Run generalization
    sudo bash /tmp/generalize-template.sh

    # Shut down cleanly
    sudo poweroff
    ```

    Wait for VM to fully shut down:
    ```bash
    # From macOS, wait until status is "stopped"
    while prlctl status ArchBase-Template | grep -q running; do
      sleep 2
    done
    echo "VM stopped"
    ```
  </action>
  <verify>
    `prlctl status ArchBase-Template` shows "stopped"
    Generalization script ran without errors
  </verify>
  <done>Template generalized and shut down</done>
</task>

<task type="auto">
  <name>Task 3: Convert to template and test clone</name>
  <files>N/A - prlctl commands</files>
  <action>
    Convert the VM to a template and test the cloning process.

    From macOS:
    ```bash
    # Convert to template
    prlctl set ArchBase-Template --template on

    # Verify template status
    prlctl list -t | grep ArchBase-Template

    # Clone the template to create a test VM
    prlctl clone ArchBase-Template --name TestClone

    # Start the cloned VM
    prlctl start TestClone
    ```

    The cloned VM should:
    - Boot with LUKS passphrase prompt (same passphrase as template)
    - Generate new SSH host keys on first boot
    - Have empty machine-id that gets regenerated
    - Reach graphical login (greetd)
  </action>
  <verify>
    `prlctl list -t` shows ArchBase-Template as template
    `prlctl list -a` shows TestClone as running
  </verify>
  <done>Template created and clone boots successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify cloned VM has unique identifiers</name>
  <what-built>Template cloning workflow with proper identifier regeneration</what-built>
  <how-to-verify>
    1. Enter LUKS passphrase when TestClone prompts (same as template)
    2. Login to the cloned VM
    3. Verify unique identifiers regenerated:

    ```bash
    # Machine ID should be populated (not empty)
    cat /etc/machine-id
    # Should show a 32-character hex string

    # SSH host keys should exist
    ls -la /etc/ssh/ssh_host_*
    # Should show multiple key files with current date

    # Compare with template (if you can boot it again)
    # Machine IDs and host keys should be DIFFERENT
    ```

    4. Verify Omarchy desktop works in clone
    5. Set a hostname for the clone:
    ```bash
    sudo hostnamectl set-hostname testclone
    ```

    From macOS, verify SSH works to clone with new host keys:
    ```bash
    ssh user@<CLONE_IP>
    ```
    (You may need to remove old host key from known_hosts if IP was reused)
  </how-to-verify>
  <resume-signal>Type "clone verified" if identifiers are unique and VM works, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Clean up test clone and update documentation</name>
  <files>hosts/endurance/README.md</files>
  <action>
    Delete the test clone (it was just for verification) and update documentation.

    Clean up:
    ```bash
    prlctl stop TestClone --kill 2>/dev/null || true
    prlctl delete TestClone
    ```

    Update hosts/endurance/README.md to add a "Template Generalization" section if not already present. The section should document:

    1. When to generalize (before converting to template)
    2. What the generalization script does
    3. How to convert VM to template
    4. How to clone template for new VMs

    Add after the "Verification" section and before "Prerequisites":

    ```markdown
    ---

    ## Template Generalization

    Before converting the VM to a template for cloning, remove machine-specific data:

    ### Generalize the VM

    ```bash
    # Copy generalization script to VM
    scp ~/Documents/dotfiles/scripts/generalize-template.sh user@<VM_IP>:/tmp/

    # Run inside VM
    ssh user@<VM_IP>
    sudo bash /tmp/generalize-template.sh
    sudo poweroff
    ```

    The script removes: machine-id, SSH host keys, hostname, shell history, and logs.

    ### Convert to Template

    ```bash
    # Convert VM to template (must be stopped)
    prlctl set ArchBase-Template --template on

    # Verify
    prlctl list -t
    ```

    ### Clone Template

    ```bash
    # Create new VM from template
    prlctl clone ArchBase-Template --name NewVMName

    # Start and personalize
    prlctl start NewVMName
    # Enter LUKS passphrase, login, then:
    sudo hostnamectl set-hostname newvmname
    ```

    Each clone gets unique machine-id and SSH host keys on first boot.
    ```

    Integrate this into the existing README structure.
  </action>
  <verify>
    `prlctl list -a | grep TestClone` returns empty (clone deleted)
    hosts/endurance/README.md contains "Template Generalization" section
    scripts/generalize-template.sh is committed to repo
  </verify>
  <done>Test clone removed and documentation updated</done>
</task>

</tasks>

<verification>
Final phase verification:

```bash
# Template exists and is marked as template
prlctl list -t | grep ArchBase-Template

# Generalization script exists
ls -la ~/Documents/dotfiles/scripts/generalize-template.sh

# Documentation updated
grep -q "Template Generalization" ~/Documents/dotfiles/hosts/endurance/README.md

# No stray test VMs
prlctl list -a | grep -v Template
```
</verification>

<success_criteria>
1. Generalization script created and documented
2. VM converted to Parallels template
3. Cloned VM boots with unique machine-id and SSH host keys
4. Cloned VM has working LUKS encryption (same passphrase)
5. Cloned VM has working Omarchy desktop
6. hosts/endurance/README.md updated with template/clone documentation
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-03-SUMMARY.md`
</output>
