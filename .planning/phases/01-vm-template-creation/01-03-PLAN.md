---
phase: 01-vm-template-creation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - hosts/endurance/README.md
autonomous: false

must_haves:
  truths:
    - "Template is generalized (no machine-specific data)"
    - "SSH host keys cleared (regenerate on clone)"
    - "Machine ID cleared (regenerate on first boot)"
    - "Hostname cleared (set during clone)"
    - "Template can be cloned to create new VMs"
    - "Documentation covers full process from start to finish"
  artifacts:
    - path: "hosts/endurance/README.md"
      provides: "Complete VM template creation documentation"
      contains: "Template Generalization"
  key_links:
    - from: "Template VM"
      to: "Cloned VMs"
      via: "prlctl clone command"
---

<objective>
Document and execute template generalization, then verify the complete template creation process.

Purpose: Prepare the VM for cloning by removing machine-specific data, and ensure the documentation is complete and accurate for future template creation.

Output: Generalized VM template ready for cloning, plus finalized documentation.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@.planning/phases/01-vm-template-creation/01-01-SUMMARY.md
@.planning/phases/01-vm-template-creation/01-02-SUMMARY.md
@hosts/endurance/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document template generalization process</name>
  <files>hosts/endurance/README.md</files>
  <action>
Add to hosts/endurance/README.md after Omarchy installation:

## Template Generalization

### Step 11: Clean Machine-Specific Data

Before converting to a template, remove data that should be unique per VM:

```bash
# Clear machine ID (regenerates on first boot)
sudo truncate -s 0 /etc/machine-id
sudo rm -f /var/lib/dbus/machine-id
sudo ln -sf /etc/machine-id /var/lib/dbus/machine-id

# Clear hostname (set during clone configuration)
sudo truncate -s 0 /etc/hostname

# Remove SSH host keys (regenerate on first boot)
sudo rm -f /etc/ssh/ssh_host_*

# Clear shell history
rm -f ~/.bash_history ~/.zsh_history
sudo rm -f /root/.bash_history

# Clear logs
sudo journalctl --rotate
sudo journalctl --vacuum-time=1s

# Remove user SSH authorized_keys (add back during clone setup)
rm -f ~/.ssh/authorized_keys
```

### Step 12: Shutdown for Template

```bash
# Clean shutdown
sudo poweroff
```

### Step 13: Mark as Template (optional)

In Parallels, you can rename the VM to indicate it's a template:
```bash
# From macOS
prlctl set "ArchBase-Template" --name "ArchBase-Template"
```

Or use Parallels GUI to convert to template format.

## Using the Template

### Clone for New VM

```bash
# Clone template to new VM
prlctl clone "ArchBase-Template" --name "NewVMName"

# Start the clone
prlctl start "NewVMName"
```

### Post-Clone Configuration

After cloning and first boot:
1. Enter LUKS passphrase
2. Set hostname: `sudo hostnamectl set-hostname newname`
3. Add SSH keys: `echo "ssh-..." >> ~/.ssh/authorized_keys`
4. Continue with Phase 2 (Rosetta/Nix infrastructure)

Document that the clone inherits:
- LUKS encryption (same passphrase as template)
- Omarchy desktop
- SSH server (but needs new keys added)
- Parallels integration (Rosetta, shared folders)
  </action>
  <verify>
Read hosts/endurance/README.md and confirm:
- Template generalization commands present (machine-id, hostname, SSH keys, history, logs)
- Shutdown command documented
- Clone instructions present
- Post-clone steps documented
  </verify>
  <done>Documentation complete for Steps 11-13 plus clone usage instructions</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Execute template generalization</name>
  <action-required>
Follow Steps 11-12 in hosts/endurance/README.md:

1. SSH into the VM (or use Parallels console)
2. Run the cleanup commands to clear machine-specific data
3. Verify the cleanup worked:
   - `cat /etc/machine-id` should be empty
   - `cat /etc/hostname` should be empty
   - `ls /etc/ssh/ssh_host_*` should show no files
4. Shutdown the VM cleanly
  </action-required>
  <how-to-verify>
After shutdown:
1. VM should be stopped in Parallels
2. Ready for cloning or template conversion

Optional verification (after generalization, before shutdown):
- `cat /etc/machine-id` returns empty
- `ls /etc/ssh/ssh_host_*` returns "No such file"
- `cat /etc/hostname` returns empty
  </how-to-verify>
  <resume-signal>Type "template ready" when VM is generalized and shut down, or describe any issues</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete template and documentation</name>
  <what-built>Complete VM template creation process with documentation</what-built>
  <how-to-verify>
Final verification of the template:

1. **Test clone creation** (from macOS):
   ```bash
   prlctl clone "ArchBase-Template" --name "TestClone"
   prlctl start "TestClone"
   ```

2. **Verify clone boots correctly:**
   - LUKS passphrase prompt appears
   - System decrypts and boots
   - New machine-id generated: `cat /etc/machine-id` (should have content now)
   - New SSH host keys: `ls /etc/ssh/ssh_host_*` (should exist)

3. **Verify Parallels integration on clone:**
   - Rosetta: `ls /mnt/psf/RosettaLinux/rosetta`
   - Shared folders: `ls /mnt/psf/Home/Documents/dotfiles`
   - SSH accessible after adding key

4. **Review documentation accuracy:**
   - Read through hosts/endurance/README.md
   - Compare against what you actually did
   - Note any discrepancies or improvements

5. **Cleanup test clone:**
   ```bash
   prlctl stop "TestClone" --kill
   prlctl delete "TestClone"
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if template clones correctly and documentation is accurate, or describe issues/improvements needed</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria (from ROADMAP.md):
- [ ] VM boots with LUKS passphrase prompt and decrypts successfully
- [ ] Rosetta is enabled in Parallels settings and /mnt/psf/RosettaLinux/rosetta exists
- [ ] Shared folders mount dotfiles at expected path (/mnt/psf/Home/Documents/dotfiles)
- [ ] SSH access works from macOS host using key authentication
- [ ] Template creation process is documented and can be followed by a new developer
</verification>

<success_criteria>
1. Template is generalized (no machine-specific data)
2. Clone test succeeds with all features working
3. Documentation in hosts/endurance/README.md is complete and accurate
4. Another developer could follow the docs to recreate the template
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-03-SUMMARY.md`
</output>
