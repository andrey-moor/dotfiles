---
phase: 01-vm-template-creation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Omarchy/Hyprland desktop is installed and working"
    - "GRUB bootloader still prompts for LUKS passphrase at boot"
    - "User can login to graphical desktop"
    - "Shared folders mount at /mnt/psf/"
  artifacts:
    - path: "VM: ArchBase-Template (Parallels)"
      provides: "Encrypted Arch ARM VM with Omarchy desktop"
    - path: "Snapshot: Omarchy-Ready (Parallels)"
      provides: "Recovery point after successful Omarchy installation"
  key_links:
    - from: "GRUB bootloader"
      to: "LUKS decryption"
      via: "encrypt hook in initramfs"
      pattern: "LUKS passphrase prompt at boot"
    - from: "Omarchy installer"
      to: "Hyprland desktop"
      via: "armarchy script"
      pattern: "graphical login after reboot"
---

<objective>
Follow docs/omarchy-grub-install.md to install Omarchy desktop while preserving GRUB bootloader. The existing snapshot from Plan 02 provides recovery if GRUB is broken.

Purpose: Test that omarchy-grub-install.md correctly documents the GRUB backup/restore workflow needed because armarchy installs Limine by default.

Output:
- VM with working Omarchy/Hyprland desktop
- GRUB bootloader preserved (LUKS passphrase prompt still works)
- New snapshot after successful installation
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md
@docs/omarchy-grub-install.md
@scripts/prl-type.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start VM and verify GRUB boot</name>
  <files></files>
  <action>
Start the VM from the EncryptedBase-GRUB snapshot state:

```bash
# Start VM
prlctl start ArchBase-Template

# Take a screenshot to verify GRUB appears
sleep 30
prlctl capture ArchBase-Template --file /tmp/grub-boot.png
open /tmp/grub-boot.png
```

User enters LUKS passphrase to boot.
  </action>
  <verify>
- VM is running: `prlctl list | grep ArchBase-Template` shows "running"
- Screenshot shows GRUB menu or LUKS passphrase prompt
  </verify>
  <done>
VM is running from GRUB with LUKS encryption active.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Backup GRUB and run Omarchy installer</name>
  <action>
Human enters LUKS passphrase to boot, then runs installer with password creation.
  </action>
  <what-to-do>
Follow docs/omarchy-grub-install.md:

1. **Login as root** (the only user at this point)

2. **Backup GRUB before running armarchy:**
```bash
# Create backup directory
mkdir -p /root/grub-backup

# Backup GRUB installation
cp -a /boot/grub /root/grub-backup/
cp /boot/vmlinuz-linux /root/grub-backup/
cp /boot/initramfs-linux.img /root/grub-backup/
cp /boot/initramfs-linux-fallback.img /root/grub-backup/ 2>/dev/null || true

# Verify backup
ls -la /root/grub-backup/
```

3. **Run armarchy installer:**
```bash
pacman -S wget
curl -fsSL hdwy.link/armarchy-3-x | bash
```

4. **When prompted for username/password:**
   - Username: Can use generic like "user" (personalize after cloning)
   - Password: MUST meet Intune requirements:
     - 12+ characters
     - At least 1 uppercase, 1 lowercase, 1 digit, 1 symbol
     - Example: "Template#Pass1234"

5. **After installer completes but BEFORE rebooting:**
   - Installer will say it's going to reboot
   - Note: armarchy installs Limine, which will break LUKS boot!
  </what-to-do>
  <resume-signal>Type "installer-done" when armarchy installer completes (before reboot happens)</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Restore GRUB bootloader</name>
  <action>
Human must act quickly to restore GRUB before Limine boot fails.
  </action>
  <what-to-do>
IMMEDIATELY after installer completes, restore GRUB:

```bash
# Restore GRUB files
cp -a /root/grub-backup/grub /boot/
cp /root/grub-backup/vmlinuz-linux /boot/
cp /root/grub-backup/initramfs-linux.img /boot/
cp /root/grub-backup/initramfs-linux-fallback.img /boot/ 2>/dev/null || true

# Regenerate GRUB config (picks up any new kernels)
grub-mkconfig -o /boot/grub/grub.cfg

# Verify output shows:
#   Found linux image: /boot/vmlinuz-linux
#   Found initrd image: /boot/initramfs-linux.img

# Verify initrd is in config
grep initrd /boot/grub/grub.cfg

# Now safe to reboot
reboot
```

At boot:
- GRUB menu should appear
- LUKS passphrase prompt should appear
- After decryption, should reach Omarchy graphical login
  </what-to-do>
  <resume-signal>Type "grub-restored" when you've rebooted and see LUKS passphrase prompt (GRUB not Limine)</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify Omarchy desktop and shared folders</name>
  <what-built>
Omarchy desktop with GRUB bootloader preserved.
  </what-built>
  <how-to-verify>
1. **Login to Hyprland desktop** with the user created during armarchy installation

2. **Verify desktop works:**
   - Open a terminal (Super+Enter or right-click)
   - Run: `hyprctl version` to confirm Hyprland is running

3. **Verify shared folders:**
   - Check mount: `ls /mnt/psf/`
   - Should see macOS home directory contents
   - Specifically: `ls /mnt/psf/Home/Documents/dotfiles` should show this repo

4. **Verify network:**
   - `ping -c 3 archlinux.org`

5. **Verify Rosetta is available:**
   - `ls /mnt/psf/RosettaLinux/rosetta`
   - Should exist (binary for x86_64 emulation)

If shared folders don't mount:
- Check Parallels VM settings: Options > Sharing > Share Mac folders
- Try: `sudo mount -t prl_fs none /mnt/psf` (may need Parallels tools)
  </how-to-verify>
  <resume-signal>Type "desktop-verified" or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Create post-Omarchy snapshot</name>
  <files></files>
  <action>
After successful Omarchy verification, create another snapshot:

```bash
# Shutdown the VM cleanly
prlctl stop ArchBase-Template

# Create snapshot
prlctl snapshot ArchBase-Template -n "Omarchy-Ready" -d "Omarchy desktop installed with GRUB preserved"

# Verify snapshot exists
prlctl snapshot-list ArchBase-Template
```

This snapshot represents a working Omarchy system ready for generalization.
  </action>
  <verify>
- VM is stopped: `prlctl list | grep ArchBase-Template` shows "stopped"
- Snapshot exists: `prlctl snapshot-list ArchBase-Template | grep "Omarchy-Ready"`
  </verify>
  <done>
Snapshot "Omarchy-Ready" exists as recovery point for generalization phase.
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria progress:
- [x] VM boots with LUKS passphrase prompt and decrypts successfully
- [x] Rosetta binary exists at /mnt/psf/RosettaLinux/rosetta
- [x] Shared folders mount dotfiles at expected path
- [ ] SSH access works (configure in next plan or defer to Phase 2)
- [x] Template creation process documented (via docs/)
</verification>

<success_criteria>
- VM boots with GRUB (not Limine)
- LUKS passphrase prompt appears at boot
- After decryption, Omarchy/Hyprland desktop loads
- User can login with password created during installation
- Shared folders accessible at /mnt/psf/
- Rosetta binary exists
- Snapshot "Omarchy-Ready" created
- omarchy-grub-install.md was followable (note any issues for doc updates)
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-03-SUMMARY.md`

Include in summary:
- Any issues encountered following the doc
- Whether GRUB backup/restore worked as documented
- Exact username created (for template documentation)
- Shared folder mount path confirmed
</output>
