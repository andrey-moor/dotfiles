---
phase: 01-vm-template-creation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - hosts/endurance/README.md
autonomous: false

must_haves:
  truths:
    - "Omarchy desktop environment launches after login"
    - "Hyprland compositor is running"
    - "User can interact with graphical applications"
  artifacts:
    - path: "N/A - installed in VM"
      provides: "Omarchy desktop packages"
  key_links:
    - from: "greetd/tuigreet"
      to: "Hyprland"
      via: "session launch"
    - from: "armarchy installer"
      to: "Omarchy packages"
      via: "curl pipe to bash"
---

<objective>
Install Omarchy desktop environment on the encrypted base VM.

Purpose: Omarchy provides the Hyprland-based desktop environment that makes the VM usable as a workstation. Installing it in the template means all cloned VMs get it automatically.

Output: VM with fully functional Omarchy desktop, graphical login, and Hyprland compositor.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-RESEARCH.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md

@hosts/endurance/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prepare VM for Omarchy installation</name>
  <files>N/A - commands in VM</files>
  <action>
    SSH into the VM and prepare for Omarchy installation:

    ```bash
    ssh user@<VM_IP>
    ```

    Once connected, update the system and install prerequisites:

    ```bash
    # Update package database and system
    sudo pacman -Syu --noconfirm

    # Install git (needed by Omarchy installer)
    sudo pacman -S --noconfirm git

    # Verify network connectivity (Omarchy needs to download many packages)
    ping -c 1 github.com
    ```

    The Omarchy installer (armarchy) must run as root but creates a user environment.
  </action>
  <verify>
    `pacman -Q git` shows git is installed
    `ping -c 1 github.com` succeeds
  </verify>
  <done>VM is updated and ready for Omarchy installation</done>
</task>

<task type="auto">
  <name>Task 2: Run Omarchy ARM64 installer</name>
  <files>N/A - commands in VM</files>
  <action>
    Run the armarchy installer from PR #1897. This installs:
    - Hyprland compositor
    - greetd + tuigreet login manager
    - Waybar, rofi, dunst
    - Alacritty terminal
    - Standard Omarchy configuration

    SSH into VM and run:

    ```bash
    ssh user@<VM_IP>
    ```

    Then run the installer as root:

    ```bash
    # Use the short URL from the armarchy PR
    # This is the jondkinney fork with ARM64 support
    curl -fsSL hdwy.link/armarchy-3-x | sudo bash
    ```

    Alternative if short URL fails:
    ```bash
    sudo bash -c 'wget -qO- https://raw.githubusercontent.com/jondkinney/armarchy/amarchy-3-x/boot.sh | OMARCHY_REPO=jondkinney/armarchy OMARCHY_REF=amarchy-3-x bash'
    ```

    The installer is interactive and may ask questions. Document any prompts encountered.

    Installation takes 10-20 minutes depending on network speed.
  </action>
  <verify>
    Installer completes without errors.
    `pacman -Q hyprland` shows hyprland is installed.
    `systemctl status greetd` shows greetd service exists (may not be active yet).
  </verify>
  <done>Omarchy packages installed via armarchy installer</done>
</task>

<task type="auto">
  <name>Task 3: Enable greetd and configure for user</name>
  <files>N/A - commands in VM</files>
  <action>
    Enable the graphical login manager and ensure Hyprland is the default session:

    ```bash
    ssh user@<VM_IP>
    ```

    Enable greetd:
    ```bash
    sudo systemctl enable greetd
    ```

    Verify greetd configuration points to Hyprland:
    ```bash
    cat /etc/greetd/config.toml
    ```

    The command should show tuigreet with Hyprland as the default session.

    If not configured correctly, create/update the config:
    ```bash
    sudo tee /etc/greetd/config.toml << 'EOF'
    [terminal]
    vt = 1

    [default_session]
    command = "tuigreet --time --remember --remember-session --cmd Hyprland"
    user = "greeter"
    EOF
    ```

    Reboot to test graphical login:
    ```bash
    sudo reboot
    ```
  </action>
  <verify>
    After reboot:
    - LUKS passphrase prompt appears
    - After unlock, greetd/tuigreet login screen appears (not TTY login)
    - User list or username prompt is visible
  </verify>
  <done>greetd enabled and configured for Hyprland session</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify Omarchy desktop functionality</name>
  <what-built>Complete Omarchy desktop environment with Hyprland compositor</what-built>
  <how-to-verify>
    1. In Parallels console, enter LUKS passphrase when prompted
    2. At greetd login screen, enter username and password
    3. Verify Hyprland desktop appears (wallpaper, waybar at top)
    4. Test keyboard shortcuts:
       - Super+Enter: Opens Alacritty terminal
       - Super+D: Opens rofi application launcher
       - Super+Q: Closes focused window
    5. Verify mouse/trackpad works for window movement
    6. Open a terminal and verify commands work:
       ```
       neofetch  # or hostnamectl
       ```

    Expected outcomes:
    - Desktop environment fully functional
    - Terminal opens and responds to commands
    - Application launcher works
    - No GPU errors in journal (Hyprland should use software rendering in VM)

    Check for errors:
    ```
    journalctl --user -u hyprland --since "5 minutes ago"
    ```
  </how-to-verify>
  <resume-signal>Type "desktop works" if Omarchy is functional, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Omarchy installation verification:

```bash
# From VM terminal
pacman -Q hyprland waybar rofi dunst alacritty  # All should be installed
systemctl status greetd                          # Should be active
echo $XDG_SESSION_TYPE                           # Should be "wayland"
pgrep -x Hyprland                                # Should return PID
```
</verification>

<success_criteria>
1. Omarchy desktop environment launches after login
2. Hyprland compositor is running
3. Standard Omarchy keybindings work (Super+Enter for terminal)
4. greetd login manager enabled and working
5. No critical errors in Hyprland logs
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-02-SUMMARY.md`
</output>
