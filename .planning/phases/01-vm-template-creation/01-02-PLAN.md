---
phase: 01-vm-template-creation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "VM boots with LUKS passphrase prompt"
    - "GRUB decrypts and mounts encrypted root"
    - "Network connectivity works (DHCP)"
    - "Snapshot exists for recovery if Omarchy breaks boot"
  artifacts:
    - path: "VM: ArchBase-Template (Parallels)"
      provides: "Running encrypted Arch ARM VM"
    - path: "Snapshot: EncryptedBase-GRUB (Parallels)"
      provides: "Recovery point before Omarchy installation"
  key_links:
    - from: "docs/arch-arm-encrypted-install.md"
      to: "VM boot"
      via: "Following documented steps"
      pattern: "LUKS passphrase prompt appears"
---

<objective>
Follow docs/arch-arm-encrypted-install.md to create an encrypted Arch Linux ARM VM with GRUB bootloader. Create a Parallels snapshot after successful LUKS boot for recovery.

Purpose: Test that arch-arm-encrypted-install.md is complete and followable. The snapshot provides a recovery point if Plan 03 (Omarchy) breaks the bootloader.

Output:
- Running VM with LUKS encryption and GRUB bootloader
- Parallels snapshot named "EncryptedBase-GRUB" for recovery
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-vm-template-creation/01-CONTEXT.md
@docs/arch-arm-encrypted-install.md
@scripts/create-arch-vm.sh
@scripts/prl-type.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VM with Rosetta enabled</name>
  <files></files>
  <action>
Use scripts/create-arch-vm.sh to create the VM with proper settings:

```bash
# Download archboot ISO if not present
# Check https://release.archboot.com/aarch64/latest/iso/ for current version
cd /Users/andreym/Documents/dotfiles/scripts
./create-arch-vm.sh ArchBase-Template 4 8192 131072 ~/Downloads/archboot-*.iso
```

If script fails or ISO not found:
1. Download archboot ISO manually from https://release.archboot.com/aarch64/latest/iso/
2. Run script with explicit ISO path

Verify Rosetta is enabled BEFORE first boot:
```bash
prlctl list -i ArchBase-Template | grep -i rosetta
```

Start the VM:
```bash
prlctl start ArchBase-Template
```
  </action>
  <verify>
- VM "ArchBase-Template" exists: `prlctl list -a | grep ArchBase-Template`
- Rosetta enabled: `prlctl list -i ArchBase-Template | grep -i rosetta` shows "on"
- VM is running: `prlctl list | grep ArchBase-Template` shows "running"
  </verify>
  <done>
VM is created, Rosetta is enabled, archboot ISO is booted.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Follow arch-arm-encrypted-install.md through LUKS setup</name>
  <action>
Human must enter LUKS passphrase during cryptsetup luksFormat - cannot be automated.
  </action>
  <what-to-do>
Follow docs/arch-arm-encrypted-install.md Steps 1-4:
1. Verify network (ping archlinux.org)
2. Partition disk with fdisk (EFI + LUKS partitions)
3. Setup LUKS encryption

For the LUKS passphrase, use: 4815162342 (template passphrase, change after cloning)

Claude can assist by typing commands via prl-type.sh when requested.
Example: `VM=ArchBase-Template ./scripts/prl-type.sh "fdisk /dev/sda"`

After LUKS setup, cryptsetup open /dev/sda2 cryptroot should succeed with the passphrase.
  </what-to-do>
  <resume-signal>Type "luks-ready" when cryptsetup open succeeds and you've mounted /mnt</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Complete base system installation</name>
  <action>
Human monitors installation and enters passphrase at first boot.
  </action>
  <what-to-do>
Continue with docs/arch-arm-encrypted-install.md Steps 5-7:
1. Configure mirrors and pacstrap base system
2. Configure PAM password policy
3. Configure GRUB bootloader with LUKS support

Critical checkpoints:
- After mkinitcpio -P: Verify "encrypt" hook message
- After grub-mkconfig: Verify BOTH "Found linux image" AND "Found initrd image" in output
- After grub-mkconfig: Run `grep initrd /boot/grub/grub.cfg` to confirm initrd is included

Exit chroot, unmount, and reboot:
```bash
exit
umount -R /mnt
reboot
```

At reboot, you should see GRUB menu, then LUKS passphrase prompt.
  </what-to-do>
  <resume-signal>Type "boot-success" when VM boots, prompts for LUKS passphrase, decrypts, and reaches login prompt</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create recovery snapshot</name>
  <files></files>
  <action>
After successful LUKS boot is verified, create a Parallels snapshot for recovery:

```bash
# Shutdown the VM cleanly (from inside VM or via prlctl)
prlctl stop ArchBase-Template

# Create snapshot
prlctl snapshot ArchBase-Template -n "EncryptedBase-GRUB" -d "Clean LUKS+GRUB base before Omarchy installation"

# Verify snapshot exists
prlctl snapshot-list ArchBase-Template
```

This snapshot allows recovery if Omarchy installation (Plan 03) breaks the GRUB bootloader.
  </action>
  <verify>
- VM is stopped: `prlctl list | grep ArchBase-Template` shows "stopped"
- Snapshot exists: `prlctl snapshot-list ArchBase-Template | grep "EncryptedBase-GRUB"`
  </verify>
  <done>
Snapshot "EncryptedBase-GRUB" exists, VM can be restored to pre-Omarchy state if needed.
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria partially met:
- [x] VM boots with LUKS passphrase prompt and decrypts successfully
- [ ] Rosetta enabled (configured, not yet tested with x86_64 binary)
- [ ] Shared folders accessible (will verify after Omarchy)
- [ ] SSH access (will configure after Omarchy)
- [ ] Template creation documented (docs created in Plan 01)

Snapshot ready for Plan 03 (Omarchy installation).
</verification>

<success_criteria>
- VM "ArchBase-Template" exists and boots
- LUKS passphrase prompt appears during boot
- After entering passphrase, system reaches login prompt
- Snapshot "EncryptedBase-GRUB" exists in Parallels
- arch-arm-encrypted-install.md was followable (note any issues for doc updates)
</success_criteria>

<output>
After completion, create `.planning/phases/01-vm-template-creation/01-02-SUMMARY.md`

Include in summary:
- Any issues encountered following the doc (for future doc improvements)
- Exact VM name and snapshot name created
- Time taken for installation (for future estimates)
</output>
