---
phase: 03-vm-automation-scripts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/clone-encrypted-vm.sh
  - scripts/setup-clone.sh
  - docs/template-generalization.md
autonomous: false

must_haves:
  truths:
    - "User can clone encrypted template with one command from macOS"
    - "User can run post-clone setup with one command inside VM"
    - "Clone workflow completes without manual VM console access for prlctl operations"
    - "Scripts guide user through manual steps (LUKS passphrase, armarchy prompts)"
  artifacts:
    - path: "scripts/clone-encrypted-vm.sh"
      provides: "macOS clone and configure script"
      min_lines: 60
      exports: []
    - path: "scripts/setup-clone.sh"
      provides: "VM post-clone setup script"
      min_lines: 50
      exports: []
  key_links:
    - from: "scripts/clone-encrypted-vm.sh"
      to: "ArchBase-Template VM"
      via: "prlctl clone command"
      pattern: "prlctl clone.*ArchBase-Template"
    - from: "scripts/setup-clone.sh"
      to: "scripts/prerequisites.sh"
      via: "documentation reference"
      pattern: "prerequisites\\.sh"
    - from: "scripts/setup-clone.sh"
      to: "/boot/EFI/GRUB/grubaa64.efi"
      via: "GRUB fix command"
      pattern: "cp.*grubaa64\\.efi.*BOOTAA64\\.EFI"
---

<objective>
Create VM automation scripts for cloning the encrypted Arch Linux template and running post-clone setup.

Purpose: Enable reproducible VM creation from macOS with minimal manual intervention. Scripts automate the error-prone parts (prlctl commands, GRUB fix) while guiding users through necessarily interactive parts (LUKS passphrase, armarchy installer).

Output:
- scripts/clone-encrypted-vm.sh (macOS: clone, configure)
- scripts/setup-clone.sh (VM: armarchy, GRUB fix, next steps)
- Updated docs/template-generalization.md (reference scripts)
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vm-automation-scripts/03-RESEARCH.md

# Existing scripts to follow patterns from
@scripts/create-arch-vm.sh
@scripts/prerequisites.sh

# Documentation to update
@docs/template-generalization.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clone-encrypted-vm.sh</name>
  <files>scripts/clone-encrypted-vm.sh</files>
  <action>
Create the macOS clone script based on research example. The script:

1. Accepts VM_NAME as required arg, optional CPUS (default 4) and MEMORY (default 8192)
2. Validates prerequisites:
   - prlctl command exists
   - Source VM "ArchBase-Template" exists
   - Target VM doesn't already exist
3. Stops source VM if running (prlctl stop, ignore errors)
4. Finds and switches to "EncryptedBase-GRUB" snapshot using prlctl snapshot-list + snapshot-switch
5. Clones VM with prlctl clone
6. Configures clone:
   - Set CPUs and memory
   - Ensure rosetta-linux on
   - Ensure shf-host on
7. Prints clear next steps:
   - Start VM command
   - LUKS passphrase (temppass)
   - Login as root
   - Path to setup-clone.sh

Use same color/logging pattern as create-arch-vm.sh (log/warn/error functions).

Include the snapshot-switch approach from research to ensure clone is from correct state, not current VM state.
  </action>
  <verify>
bash -n scripts/clone-encrypted-vm.sh  # syntax check
chmod +x scripts/clone-encrypted-vm.sh
scripts/clone-encrypted-vm.sh --help 2>&1 | grep -q "Usage" || scripts/clone-encrypted-vm.sh 2>&1 | grep -q "Usage"  # shows usage when no args
  </verify>
  <done>Script exists, is executable, shows usage when run without arguments</done>
</task>

<task type="auto">
  <name>Task 2: Create setup-clone.sh</name>
  <files>scripts/setup-clone.sh</files>
  <action>
Create the VM-side setup script based on research example. The script:

1. Checks it's running as root (required for armarchy)
2. Checks for existing home directory users (warn if Omarchy may already be installed)
3. Waits for shared folders mount (retry loop for /mnt/psf/Home, up to 30s)
4. Displays what will happen:
   - armarchy installer will prompt for name, email, username, password
   - Password requirements for Intune (12+ chars, upper, lower, digit, symbol)
5. Pauses for user confirmation before starting armarchy
6. Installs wget if needed
7. Runs armarchy: curl -fsSL hdwy.link/armarchy-3-x | bash
8. CRITICAL: After armarchy completes, applies GRUB fix:
   - cp /boot/EFI/GRUB/grubaa64.efi /boot/EFI/BOOT/BOOTAA64.EFI
   - Verify file exists and is correct size (~160KB)
9. Prints post-reboot next steps:
   - Login as new user (not root)
   - Run prerequisites.sh
   - Run home-manager switch
   - Pointer to hosts/endurance/README.md for remaining steps
10. Offers to reboot (with 10s countdown, Ctrl+C to cancel)

Use same logging functions for consistency.
  </action>
  <verify>
bash -n scripts/setup-clone.sh  # syntax check
chmod +x scripts/setup-clone.sh
grep -q "BOOTAA64.EFI" scripts/setup-clone.sh  # GRUB fix present
grep -q "prerequisites.sh" scripts/setup-clone.sh  # references next script
  </verify>
  <done>Script exists, is executable, contains GRUB fix and prerequisites reference</done>
</task>

<task type="auto">
  <name>Task 3: Update template-generalization.md</name>
  <files>docs/template-generalization.md</files>
  <action>
Update the documentation to reference the new scripts:

1. In "Quick Clone Script" section, replace the inline script with reference to scripts/clone-encrypted-vm.sh
2. Add new "Automation Scripts" section after Overview:
   - List scripts/clone-encrypted-vm.sh and scripts/setup-clone.sh
   - Brief description of each
   - Example usage
3. In "Step 3: Start and Install Omarchy" section, add reference to setup-clone.sh as alternative to manual steps
4. Keep existing manual steps intact (some users may want to understand/modify)

Don't remove existing content - augment with script references.
  </action>
  <verify>
grep -q "clone-encrypted-vm.sh" docs/template-generalization.md
grep -q "setup-clone.sh" docs/template-generalization.md
  </verify>
  <done>Documentation references both automation scripts</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
VM clone and setup automation scripts:
- scripts/clone-encrypted-vm.sh (macOS: clone template to new VM)
- scripts/setup-clone.sh (VM: armarchy + GRUB fix)
- Updated docs/template-generalization.md
  </what-built>
  <how-to-verify>
Test complete clone workflow:

1. From macOS, run clone script:
   ```bash
   ./scripts/clone-encrypted-vm.sh TestClone
   ```
   Expected: Clone created, instructions printed

2. Start clone and boot:
   ```bash
   prlctl start TestClone
   ```
   Expected: VM boots, LUKS passphrase prompt appears

3. Enter LUKS passphrase (temppass), login as root

4. Run setup script:
   ```bash
   /mnt/psf/Home/Documents/dotfiles/scripts/setup-clone.sh
   ```
   Expected: armarchy prompts appear, after completion GRUB fix is applied

5. After reboot, verify GRUB appears (not Limine), LUKS decrypts

6. (Optional) Login as new user, run prerequisites.sh, verify Rosetta/Nix work

Cleanup after testing:
```bash
prlctl stop TestClone --kill
prlctl delete TestClone
```
  </how-to-verify>
  <resume-signal>Type "verified" if workflow completes successfully, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Phase verification commands:

```bash
# Scripts exist and are executable
ls -la scripts/clone-encrypted-vm.sh scripts/setup-clone.sh

# Syntax validation
bash -n scripts/clone-encrypted-vm.sh
bash -n scripts/setup-clone.sh

# Key patterns present
grep -q "prlctl clone" scripts/clone-encrypted-vm.sh
grep -q "snapshot-switch" scripts/clone-encrypted-vm.sh
grep -q "BOOTAA64.EFI" scripts/setup-clone.sh
grep -q "armarchy" scripts/setup-clone.sh

# Documentation updated
grep -q "clone-encrypted-vm.sh" docs/template-generalization.md
```
</verification>

<success_criteria>
- clone-encrypted-vm.sh clones template with correct settings from macOS
- setup-clone.sh runs armarchy and applies critical GRUB fix inside VM
- Scripts have clear error handling and helpful output
- Documentation points to scripts for automation
- Full workflow tested: clone -> boot -> LUKS -> armarchy -> GRUB fix -> reboot -> working VM
</success_criteria>

<output>
After completion, create `.planning/phases/03-vm-automation-scripts/03-01-SUMMARY.md`
</output>
