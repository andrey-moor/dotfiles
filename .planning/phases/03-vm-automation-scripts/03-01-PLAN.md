---
phase: 03-vm-automation-scripts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hosts/stargazer/README.md
autonomous: false

must_haves:
  truths:
    - "User can create stargazer VM from .pvmp template following README"
    - "README covers full workflow: import → boot → armarchy → GRUB fix → Nix → Intune"
    - "LUKS passphrase (4815162342) and change instructions are documented"
    - "GRUB fix after armarchy is prominently documented with warning"
    - "prl-type.sh examples shown for typing commands into VM"
  artifacts:
    - path: "hosts/stargazer/README.md"
      provides: "Comprehensive single-source-of-truth setup guide"
      min_lines: 300
      exports: []
  key_links:
    - from: "hosts/stargazer/README.md"
      to: "scripts/prerequisites.sh"
      via: "documentation reference"
      pattern: "scripts/prerequisites\\.sh"
    - from: "hosts/stargazer/README.md"
      to: "scripts/prl-type.sh"
      via: "command examples"
      pattern: "prl-type\\.sh"
    - from: "hosts/stargazer/README.md"
      to: "/boot/EFI/GRUB/grubaa64.efi"
      via: "GRUB fix command"
      pattern: "cp.*grubaa64\\.efi.*BOOTAA64\\.EFI"
---

<objective>
Restructure hosts/stargazer/README.md to be the single source of truth for creating an Intune-compliant Arch Linux VM on Apple Silicon.

Purpose: One well-structured document that covers the entire workflow from importing the .pvmp template through Intune enrollment. No scattered docs, no unnecessary scripts - just clear documentation with prl-type.sh examples for typing commands into the VM.

Output:
- Comprehensive hosts/stargazer/README.md covering full workflow
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vm-automation-scripts/03-RESEARCH.md

# Current README to restructure
@hosts/stargazer/README.md

# Existing scripts to reference
@scripts/prerequisites.sh
@scripts/prl-type.sh

# Other docs to consolidate from (content reference, don't modify)
@docs/template-generalization.md
@docs/arch-arm-encrypted-install.md
@docs/omarchy-grub-install.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure stargazer README.md</name>
  <files>hosts/stargazer/README.md</files>
  <action>
Rewrite hosts/stargazer/README.md as the single comprehensive guide. Structure:

## 1. Overview
- What stargazer is (Intune-compliant Arch Linux ARM VM)
- Prerequisites (macOS with Parallels Desktop, .pvmp template file)

## 2. Import Template
- Download .pvmp from [location TBD - user will fill in]
- Import into Parallels:
  ```bash
  # Import the .pvmp template
  prlctl import ~/Downloads/ArchBase-LUKS-GRUB.pvmp --name stargazer

  # Or via Parallels GUI: File > Open > select .pvmp
  ```
- Configure VM settings:
  ```bash
  prlctl set stargazer --cpus 4 --memsize 8192
  prlctl set stargazer --rosetta-linux on
  prlctl set stargazer --shf-host on
  ```
- Note: Can also use Parallels GUI for import and configuration

## 3. First Boot
- Start VM: `prlctl start stargazer`
- Enter LUKS passphrase: `4815162342`
- Login as root (password: `481516`)

## 4. Change LUKS Passphrase (Security)
⚠️ **Important: Change the default passphrase before proceeding**
```bash
cryptsetup luksChangeKey /dev/vda2
# Enter current: 4815162342
# Enter new passphrase (strong, you'll need it at every boot)
```

## 5. Install Omarchy (armarchy)
Explain what armarchy does, then show the command with prl-type.sh option:

From inside VM:
```bash
curl -fsSL hdwy.link/armarchy-3-x | bash
```

Or from macOS (types into VM console):
```bash
./scripts/prl-type.sh stargazer "curl -fsSL hdwy.link/armarchy-3-x | bash"
```

Note: armarchy will prompt for name, email, username, password.
Password must meet Intune requirements: 12+ chars, uppercase, lowercase, digit, symbol.

## 6. Restore GRUB Bootloader (Critical!)
⚠️ **CRITICAL: armarchy installs Limine which breaks LUKS boot. You MUST restore GRUB.**

```bash
sudo cp /boot/EFI/GRUB/grubaa64.efi /boot/EFI/BOOT/BOOTAA64.EFI
```

Verify: File should be ~160KB. If you see ~90KB, that's Limine (wrong).

Then reboot:
```bash
sudo reboot
```

After reboot, you should see GRUB menu, then LUKS passphrase prompt.

## 7. Run Prerequisites Script
After logging in as your new user (not root):

```bash
/mnt/psf/Home/Documents/dotfiles/scripts/prerequisites.sh
```

Or from macOS:
```bash
./scripts/prl-type.sh stargazer "/mnt/psf/Home/Documents/dotfiles/scripts/prerequisites.sh"
```

This script sets up: Rosetta binfmt, Nix x86_64 platform, dynamic linker symlink, os-release spoof.

## 8. Apply Home-Manager Configuration
```bash
cd /mnt/psf/Home/Documents/dotfiles
nix run home-manager -- switch --flake .#stargazer -b backup
```

## 9. Intune Setup
Keep the existing sections 7-12 from current README (D-Bus, pcscd, keyring, PAM, intune-agent, chezmoi) but renumber them as subsections under "Intune Setup".

## 10. Verify
Keep existing verify section.

## 11. Troubleshooting
Keep existing troubleshooting section, add:
- "No LUKS passphrase prompt after reboot" → GRUB fix was missed, boot from snapshot and redo

## Appendix A: Creating the .pvmp Template
Document how to export the template for sharing:
```bash
# From macOS, with ArchBase-Template VM stopped
prlctl snapshot-switch ArchBase-Template --id EncryptedBase-GRUB
prlctl pack ArchBase-Template --output ~/ArchBase-LUKS-GRUB.pvmp
```

## Appendix B: Manual prlctl Commands Reference
Quick reference for common operations (start, stop, snapshot, etc.)

---

Key principles:
- Use prl-type.sh examples for commands that run inside VM
- Keep warnings prominent (⚠️) for critical steps like GRUB fix
- Cross-reference scripts/prerequisites.sh, don't duplicate its content
- Consolidate relevant content from docs/*.md but don't copy verbatim
  </action>
  <verify>
# Check README exists and has expected sections
grep -q "Import Template" hosts/stargazer/README.md
grep -q "GRUB" hosts/stargazer/README.md
grep -q "4815162342" hosts/stargazer/README.md
grep -q "prl-type.sh" hosts/stargazer/README.md
grep -q "prerequisites.sh" hosts/stargazer/README.md
grep -q "BOOTAA64.EFI" hosts/stargazer/README.md
wc -l hosts/stargazer/README.md | awk '{print ($1 >= 300) ? "OK: " $1 " lines" : "WARN: only " $1 " lines"}'
  </verify>
  <done>README restructured with full workflow, GRUB fix prominent, prl-type.sh examples included</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Comprehensive hosts/stargazer/README.md covering:
- .pvmp import workflow
- LUKS passphrase change
- Omarchy/armarchy installation
- Critical GRUB fix
- Prerequisites script
- Home-manager setup
- Intune configuration
- prl-type.sh examples throughout
  </what-built>
  <how-to-verify>
1. Review the README structure - does it flow logically?
2. Check GRUB fix is prominent with warning
3. Verify prl-type.sh examples are useful
4. Confirm LUKS passphrase is correct (4815162342)
5. (Optional) Follow the guide on a fresh .pvmp import to verify accuracy

Note: Full end-to-end testing can happen when you next create a VM from template.
  </how-to-verify>
  <resume-signal>Type "approved" if README looks good, or describe changes needed</resume-signal>
</task>

</tasks>

<verification>
Phase verification:

```bash
# README exists with comprehensive content
test -f hosts/stargazer/README.md && echo "README exists"

# Key sections present
grep -c "## " hosts/stargazer/README.md  # Should have 10+ sections

# Critical content present
grep -q "BOOTAA64.EFI" hosts/stargazer/README.md && echo "GRUB fix documented"
grep -q "4815162342" hosts/stargazer/README.md && echo "LUKS passphrase documented"
grep -q "prl-type.sh" hosts/stargazer/README.md && echo "prl-type examples included"
grep -q "prerequisites.sh" hosts/stargazer/README.md && echo "Prerequisites referenced"
```
</verification>

<success_criteria>
- hosts/stargazer/README.md is the single source of truth for VM setup
- Full workflow documented: import → boot → LUKS change → armarchy → GRUB fix → prerequisites → home-manager → Intune
- GRUB fix is prominently documented with warning
- prl-type.sh examples provided for VM commands
- Correct LUKS passphrase (4815162342) documented
- User can follow README to create working Intune-compliant VM
</success_criteria>

<output>
After completion, create `.planning/phases/03-vm-automation-scripts/03-01-SUMMARY.md`
</output>
