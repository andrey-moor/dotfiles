# Plan 06-01: Fresh VM Creation with Snapshot Milestones

---
wave: 1
depends_on: []
files_modified:
  - (none - infrastructure validation, no code changes)
autonomous: false
---

## Context

This plan creates a fresh test VM from the ArchBase-Template to validate the complete end-to-end workflow from Phases 1-5. The VM will be used for enrollment testing in subsequent plans and becomes a long-term reference VM.

**User decisions:**
- Fresh clone from ArchBase-Template (not .pvmp import)
- Three snapshots: NixInstalled, PreIntune, Enrolled
- Reference VM becomes permanent testing asset
- Validates entire documented workflow on truly fresh clone

## Goal

Create a fresh VM from ArchBase-Template, complete the documented setup workflow (Omarchy, GRUB fix, prerequisites, home-manager), and create milestone snapshots. The VM must have `intune-health` passing before proceeding to enrollment.

## Tasks

<task id="1">
Clone a fresh VM from ArchBase-Template using prlctl. Name the VM something distinctive like "IntuneFreshTest" or similar (Claude's discretion on exact naming). Configure with 4 CPUs, 8GB RAM, Rosetta enabled, and shared folders enabled.

Commands to use:
```bash
# From macOS terminal
prlctl stop ArchBase-Template 2>/dev/null || true
prlctl clone ArchBase-Template --name <vm-name>
prlctl set <vm-name> --cpus 4 --memsize 8192
prlctl set <vm-name> --rosetta-linux on
prlctl set <vm-name> --shf-host on
prlctl start <vm-name>
```

Wait for VM to start. User will need to enter LUKS passphrase (4815162342 if using template default).
</task>

<task id="2">
After VM boots and user logs in as root, change the LUKS passphrase for security.

In VM console (or use prl-type.sh from macOS):
```bash
cryptsetup luksChangeKey /dev/vda2
# Enter current: 4815162342
# Enter new passphrase (user chooses)
```

Verify LUKS passphrase works by rebooting once.
</task>

<task id="3">
Install Omarchy desktop using armarchy installer. This creates the user account.

In VM console as root:
```bash
curl -fsSL hdwy.link/armarchy-3-x | bash
```

Follow prompts:
- Enter your name
- Enter your email
- Enter username (e.g., andreym)
- Enter password (must meet Intune requirements: 12+ chars, upper/lower/digit/symbol)

CRITICAL: DO NOT REBOOT when prompted! Must fix GRUB first.
</task>

<task id="4">
Restore GRUB bootloader (armarchy installs Limine which breaks LUKS).

In VM console:
```bash
sudo cp /boot/EFI/GRUB/grubaa64.efi /boot/EFI/BOOT/BOOTAA64.EFI
ls -la /boot/EFI/BOOT/BOOTAA64.EFI  # Should be ~160KB
```

Now reboot:
```bash
sudo reboot
```

After reboot, verify:
- GRUB menu appears (not "Omarchy Bootloader")
- LUKS passphrase prompt appears
- Login as new user (not root)
</task>

<task id="5">
Run prerequisites script to configure Rosetta and Nix.

After logging in as new user:
```bash
/mnt/psf/Home/Documents/dotfiles/scripts/prerequisites.sh
```

This configures:
- Rosetta binfmt registration
- Rosetta boot survival service
- Nix installation with extra-platforms
- Dynamic linker symlink
- os-release Ubuntu spoof

Verify Nix works:
```bash
nix --version
```
</task>

<task id="6">
Apply home-manager configuration.

```bash
cd /mnt/psf/Home/Documents/dotfiles
nix run home-manager -- switch --flake .#stargazer -b backup
```

Wait for completion (may take several minutes for first build).

Apply chezmoi:
```bash
chezmoi apply
```
</task>

<task id="7">
Create first milestone snapshot: NixInstalled

From macOS:
```bash
DATE=$(date +%Y%m%d)
prlctl stop <vm-name> --kill
prlctl snapshot <vm-name> -n "NixInstalled-$DATE" -d "Nix + home-manager applied, before Intune prerequisites"
prlctl start <vm-name>
```

This snapshot captures state after Section 7 of README but before Intune configuration.
</task>

<task id="8">
Run intune-prerequisites to configure all Intune components.

After VM restarts and user logs in:
```bash
intune-prerequisites
```

Verify all sections show [+] (applied) or [=] (already configured).

Enable intune-agent timer:
```bash
systemctl --user enable --now intune-agent.timer
```

Also enable smart card sharing in Parallels:
- VM Configuration > Hardware > USB & Bluetooth > Share smart card readers with Linux
</task>

<task id="9">
Run intune-health to verify all components are healthy.

```bash
intune-health
```

Expected output:
- All critical checks show [PASS]
- YubiKey checks may show [WARN] if not inserted (OK)
- Exit code must be 0

If any critical check fails, troubleshoot using hints provided by intune-health.

Additional verification:
```bash
intune-status
systemctl --user list-timers | grep intune
```
</task>

<task id="10">
Create second milestone snapshot: PreIntune

This is the RECOVERY POINT for enrollment attempts.

From macOS:
```bash
DATE=$(date +%Y%m%d)
prlctl stop <vm-name> --kill
prlctl snapshot <vm-name> -n "PreIntune-$DATE" -d "intune-health passes, ready for enrollment"
prlctl start <vm-name>
```

List snapshots to verify:
```bash
prlctl snapshot-list <vm-name>
```

Should show two snapshots: NixInstalled-YYYYMMDD and PreIntune-YYYYMMDD.
</task>

## Verification

```bash
# 1. VM exists and has correct config
prlctl list -i <vm-name> | grep -E "cpus|memsize|rosetta"
# Expected: cpus 4, memsize 8192, rosetta-linux on

# 2. Snapshots exist
prlctl snapshot-list <vm-name>
# Expected: NixInstalled-YYYYMMDD, PreIntune-YYYYMMDD

# 3. intune-health passes (run inside VM)
intune-health
echo "Exit code: $?"
# Expected: Exit code: 0

# 4. Rosetta binfmt registered (run inside VM)
cat /proc/sys/fs/binfmt_misc/rosetta
# Expected: enabled, interpreter /mnt/psf/RosettaLinux/rosetta

# 5. Device broker running (run inside VM)
systemctl is-active microsoft-identity-device-broker
# Expected: active

# 6. intune-agent timer enabled (run inside VM)
systemctl --user is-enabled intune-agent.timer
# Expected: enabled
```

## must_haves

- [ ] Fresh VM created from ArchBase-Template (not reusing existing stargazer)
- [ ] LUKS passphrase changed from template default
- [ ] Omarchy desktop installed with user account
- [ ] GRUB bootloader restored (not Limine)
- [ ] Prerequisites script completed successfully
- [ ] Home-manager switch completed successfully
- [ ] NixInstalled snapshot created
- [ ] intune-prerequisites completed successfully
- [ ] intune-health exits with code 0
- [ ] PreIntune snapshot created (recovery point)

## Rollback

If any step fails:
- Before NixInstalled snapshot: Delete VM, start fresh clone
- After NixInstalled snapshot: Restore to NixInstalled, retry from task 8
- After PreIntune snapshot: Restore to PreIntune as needed

Recovery command:
```bash
prlctl stop <vm-name> --kill
prlctl snapshot-switch <vm-name> --name "<snapshot-name>"
prlctl start <vm-name>
```

## Notes

- This validates the entire documented workflow from hosts/stargazer/README.md on a fresh clone
- The VM becomes a permanent reference for testing future updates
- User interaction required for: LUKS passphrase entry, Omarchy prompts, password entry
- Smart card sharing must be enabled in Parallels before enrollment (task 8)
- Snapshot names include date for disambiguation (Claude's discretion: YYYYMMDD format)
