# Plan 06-03: Edge Browser YubiKey Setup and Verification

---
wave: 3
depends_on: ["06-02"]
files_modified:
  - hosts/stargazer/README.md (update with post-enrollment section)
autonomous: true
---

## Context

After enrollment, Edge browser needs NSS module configuration for YubiKey certificate authentication during web SSO. This is separate from the intune-portal authentication flow (which uses p11-kit via WebKitGTK). This plan completes the YubiKey integration story.

**User decisions:**
- Edge browser recognition of YubiKey is a Phase 6 requirement (YK-04)
- Verification method: manual intune-agent run + log inspection

## Goal

Configure Edge browser to use YubiKey for web authentication, update documentation with post-enrollment instructions, and verify the complete enrollment/compliance workflow is functional.

## Tasks

<task id="1">
Configure NSS for Edge browser to recognize YubiKey.

Inside VM:
```bash
# Create NSS database if it doesn't exist
mkdir -p ~/.pki/nssdb
certutil -d sql:$HOME/.pki/nssdb -N --empty-password 2>/dev/null || true

# Find the OpenSC PKCS#11 module
OPENSC_MODULE=$(find /nix/store -maxdepth 1 -name '*opensc-arch-0.25.1' -type d 2>/dev/null | head -1)/lib/pkcs11/opensc-pkcs11.so

# Add OpenSC module to NSS
modutil -dbdir sql:$HOME/.pki/nssdb -add "OpenSC" -libfile "$OPENSC_MODULE" -force 2>/dev/null || true

# List modules to verify
modutil -dbdir sql:$HOME/.pki/nssdb -list
```

Expected output should include "OpenSC" module.
</task>

<task id="2">
Test YubiKey certificate access via NSS.

```bash
# List certificates visible to NSS (YubiKey must be inserted)
certutil -d sql:$HOME/.pki/nssdb -L

# Should show PIV certificates from YubiKey
# If empty, check YubiKey is inserted and pcscd running
```

Troubleshooting:
- If no certificates: `pcsc_scan -r` to verify YubiKey detected
- If module not loading: Check OpenSC path matches actual Nix store path
</task>

<task id="3">
Test Edge browser YubiKey authentication.

1. Launch Edge browser:
```bash
microsoft-edge-stable &
```

2. Navigate to a Microsoft service requiring authentication:
   - portal.azure.com
   - myapps.microsoft.com
   - Or your organization's M365 portal

3. When prompted to authenticate:
   - Certificate picker should appear
   - Select YubiKey PIV certificate
   - Enter YubiKey PIN
   - Authentication should complete

4. Verify SSO works for other Microsoft services while Edge is open
</task>

<task id="4">
Verify complete compliance reporting cycle.

1. Trigger manual compliance check:
```bash
intune-agent-rosetta
```

2. Review logs for complete success:
```bash
journalctl --user -u intune-agent --since "10 minutes ago" --no-pager | grep -iE "compliant|success|upload|error|fail"
```

3. Verify intune-agent timer is working:
```bash
systemctl --user list-timers | grep intune
# Should show intune-agent.timer with next trigger time
```

4. Wait for one timer cycle (or fast-forward by restarting timer):
```bash
systemctl --user restart intune-agent.timer
# Check next trigger
systemctl --user list-timers | grep intune
```
</task>

<task id="5">
Update hosts/stargazer/README.md with post-enrollment section.

Add a new section after "9. Verify" covering:
1. Post-enrollment Edge browser setup for YubiKey SSO
2. Ongoing compliance verification commands
3. How to check enrollment status
4. Common post-enrollment troubleshooting

The section should document:
- NSS module setup for Edge
- How to verify YubiKey works with Edge
- intune-agent timer status checking
- Manual compliance trigger
</task>

<task id="6">
Final comprehensive verification of all Phase 6 requirements.

Run through complete verification checklist:

```bash
echo "=== Phase 6 Verification Checklist ==="

# INT-04: Device enrolled
echo "1. Device enrolled with Microsoft Intune"
# Check by viewing intune-portal device status

# INT-05: intune-agent timer runs
echo "2. intune-agent timer status:"
systemctl --user is-enabled intune-agent.timer && echo "  Timer enabled: YES" || echo "  Timer enabled: NO"
systemctl --user list-timers | grep intune

# YK-03: Enrollment used YubiKey PIV certificate
echo "3. Enrollment used YubiKey certificate (verified during enrollment)"

# YK-04: Edge browser recognizes YubiKey
echo "4. Edge browser YubiKey setup:"
modutil -dbdir sql:$HOME/.pki/nssdb -list 2>/dev/null | grep -q OpenSC && echo "  NSS module: YES" || echo "  NSS module: NO"

# Compliance status
echo "5. Last compliance check:"
journalctl --user -u intune-agent --since "1 hour ago" --no-pager | tail -5
```

All items should show positive status.
</task>

## Verification

```bash
# 1. NSS module configured
modutil -dbdir sql:$HOME/.pki/nssdb -list | grep -q OpenSC
echo "NSS module: $?"
# Expected: 0 (OpenSC module present)

# 2. Certificates visible to NSS (YubiKey inserted)
certutil -d sql:$HOME/.pki/nssdb -L | grep -q "Certificate"
echo "Certificates visible: $?"
# Expected: 0 (at least one certificate)

# 3. intune-agent timer enabled
systemctl --user is-enabled intune-agent.timer
# Expected: enabled

# 4. Documentation updated
grep -q "Post-Enrollment" /mnt/psf/Home/Documents/dotfiles/hosts/stargazer/README.md
echo "Documentation updated: $?"
# Expected: 0 (section exists)

# 5. Complete workflow functional
intune-status
# Expected: Shows enrolled device, running services
```

## must_haves

- [ ] NSS database created with OpenSC module
- [ ] YubiKey certificates visible via NSS
- [ ] Edge browser can use YubiKey for authentication
- [ ] intune-agent timer running and enabled
- [ ] Documentation updated with post-enrollment instructions
- [ ] All Phase 6 requirements verified (INT-04, INT-05, YK-03, YK-04)

## Documentation Update

Add the following section to hosts/stargazer/README.md after section 9:

```markdown
## 10. Post-Enrollment Setup

After successful enrollment, complete these additional steps.

### Edge Browser YubiKey Setup

Configure Edge to use YubiKey for web authentication (Microsoft 365, Azure, etc.):

```bash
# Create NSS database (if needed)
mkdir -p ~/.pki/nssdb
certutil -d sql:$HOME/.pki/nssdb -N --empty-password 2>/dev/null || true

# Add OpenSC module for YubiKey
OPENSC_MODULE=$(find /nix/store -maxdepth 1 -name '*opensc-arch-0.25.1' -type d | head -1)/lib/pkcs11/opensc-pkcs11.so
modutil -dbdir sql:$HOME/.pki/nssdb -add "OpenSC" -libfile "$OPENSC_MODULE" -force 2>/dev/null || true

# Verify module added
modutil -dbdir sql:$HOME/.pki/nssdb -list | grep OpenSC
```

### Verify Ongoing Compliance

The intune-agent runs automatically via systemd timer:

```bash
# Check timer status
systemctl --user list-timers | grep intune

# Trigger manual compliance check
intune-agent-rosetta

# View compliance logs
journalctl --user -u intune-agent --since "1 hour ago"
```

### Check Enrollment Status

```bash
# Quick status
intune-status

# Detailed health check
intune-health

# View in portal
intune-portal-rosetta
```
```

## Notes

- Edge browser NSS setup is separate from intune-portal authentication (which uses p11-kit)
- NSS module configuration persists across reboots
- If Edge doesn't prompt for certificate, clear browser cache/cookies
- intune-agent timer runs 5 minutes after login, then hourly
- This completes all Phase 6 requirements (INT-04, INT-05, YK-03, YK-04)
