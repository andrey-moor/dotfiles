# Plan 06-02: Manual Intune Enrollment with YubiKey

---
wave: 2
depends_on: ["06-01"]
files_modified:
  - (none - manual enrollment process, no code changes)
autonomous: false
---

## Context

This plan walks through manual Intune enrollment with YubiKey authentication. The enrollment flow uses intune-portal which opens WebKitGTK browser windows for Microsoft authentication. The user selects their YubiKey PIV certificate and enters the YubiKey PIN.

**User decisions:**
- YubiKey is required (no password fallback)
- Enrollment is fully manual - document each step
- Recovery approach: restore PreIntune snapshot, not unenroll/cleanup
- intune-health must pass before starting (hard gate)

## Goal

Complete device enrollment with Microsoft Intune using YubiKey PIV certificate authentication. After enrollment, verify the device is registered and compliance check begins.

## Tasks

<task id="1">
Verify prerequisites before starting enrollment.

1. Confirm VM is at PreIntune snapshot state (or freshly booted from it)
2. Insert YubiKey into macOS host
3. Verify Parallels smart card sharing is enabled:
   - VM Configuration > Hardware > USB & Bluetooth > Share smart card readers with Linux

Inside VM, run pre-enrollment checks:
```bash
# Hard gate - must exit 0
intune-health
echo "Exit code: $?"

# YubiKey detection
pcsc_scan -r
# Should show YubiKey reader

# PIV certificate presence
ykman piv info
# Should show slot 9a has authentication certificate
```

If intune-health fails, troubleshoot before proceeding.
</task>

<task id="2">
Launch intune-portal and begin enrollment.

Inside VM:
```bash
intune-portal-rosetta
```

The Intune portal window should appear with Microsoft branding.

Click "Sign In" button to begin authentication flow.
</task>

<task id="3">
Complete Microsoft authentication with YubiKey.

1. A WebKitGTK browser window opens (Microsoft login page)
2. Enter your Microsoft work email address
3. Click Next
4. Certificate picker appears - select your YubiKey PIV certificate
   - Look for certificate with your name/email from slot 9a
5. YubiKey PIN prompt appears
6. Enter your YubiKey PIN
7. Wait for authentication to complete

**Troubleshooting:**
- If browser window is blank: Check WEBKIT_DISABLE_DMABUF_RENDERER=1 is set (wrapper should handle this)
- If no certificates appear: Check pcscd socket symlink exists, YubiKey detected
- If PIN fails: Verify correct PIN, check remaining PIN attempts with `ykman piv access retries`
</task>

<task id="4">
Complete enrollment wizard.

After authentication succeeds:
1. Review enrollment information displayed
2. Accept terms of use (organization policy)
3. Click Enroll / Register device
4. Wait for enrollment to complete

The portal should show:
- Device registered successfully
- Compliance check in progress

**Expected duration:** 1-2 minutes for enrollment to complete
</task>

<task id="5">
Trigger initial compliance check.

After enrollment completes, trigger immediate compliance reporting:

```bash
# Manual compliance check
intune-agent-rosetta

# View logs
journalctl --user -u intune-agent --since "5 minutes ago" --no-pager
```

Look for success patterns in logs:
- "Starting compliance check"
- "LUKS detected" or "encryption: compliant"
- "password policy: compliant"
- "Report uploaded successfully"
</task>

<task id="6">
Verify enrollment and compliance status.

1. In intune-portal, check device status section
   - Should show device as "Enrolled" or "Managed"
   - Compliance status should show "Compliant" or "Checking..."

2. Additional verification from command line:
```bash
# Check intune-agent ran successfully
systemctl --user status intune-agent --no-pager

# View all recent Intune-related logs
intune-logs --all
```

3. Check in Intune admin portal (if you have access):
   - Navigate to Devices > All devices
   - Search for your device name
   - Verify enrollment and compliance status
</task>

<task id="7">
Handle compliance failures (if any).

If compliance check shows failures, address them within this phase:

**LUKS encryption not detected:**
```bash
# Verify LUKS is active
lsblk -f | grep crypto
cryptsetup status cryptroot
```

**Password policy not compliant:**
```bash
# Verify PAM config exists and is readable
cat /etc/pam.d/common-password
sudo chmod 644 /etc/pam.d/common-password
```

**After fixes, trigger compliance recheck:**
```bash
intune-agent-rosetta
journalctl --user -u intune-agent --since "2 minutes ago"
```
</task>

<task id="8">
Create final milestone snapshot: Enrolled

After enrollment succeeds and compliance passes, create the final snapshot.

From macOS:
```bash
DATE=$(date +%Y%m%d)
prlctl stop <vm-name> --kill
prlctl snapshot <vm-name> -n "Enrolled-$DATE" -d "Intune enrolled, compliance verified"
prlctl start <vm-name>
```

List all snapshots:
```bash
prlctl snapshot-list <vm-name>
```

Should show three snapshots: NixInstalled, PreIntune, Enrolled
</task>

## Verification

```bash
# 1. Enrollment state (run inside VM after starting)
# Check for registration state file
ls -la ~/.config/Intune* 2>/dev/null || ls -la ~/.local/share/Intune* 2>/dev/null
# Expected: Registration files/directories exist

# 2. Device broker can verify device (run inside VM)
busctl --system call com.microsoft.identity.devicebroker1 /com/microsoft/identity/devicebroker1 org.freedesktop.DBus.Peer Ping
# Expected: No error (void return)

# 3. Compliance logs show success (run inside VM)
journalctl --user -u intune-agent --since "1 hour ago" | grep -iE "compliant|success|uploaded"
# Expected: Lines showing compliance success

# 4. Intune portal shows enrolled status
# Launch intune-portal-rosetta and verify device shows as enrolled

# 5. All three snapshots exist (run from macOS)
prlctl snapshot-list <vm-name>
# Expected: NixInstalled-YYYYMMDD, PreIntune-YYYYMMDD, Enrolled-YYYYMMDD
```

## must_haves

- [ ] intune-health passed before enrollment attempt (exit code 0)
- [ ] YubiKey detected and PIV certificate accessible
- [ ] Microsoft authentication succeeded with YubiKey certificate
- [ ] Device enrollment completed successfully
- [ ] Compliance check triggered and passed
- [ ] Enrolled snapshot created

## Rollback

If enrollment fails at any point:

```bash
# From macOS - restore to clean pre-enrollment state
prlctl stop <vm-name> --kill
prlctl snapshot-switch <vm-name> --name "PreIntune-YYYYMMDD"
prlctl start <vm-name>
```

After restore:
1. Wait for VM to boot
2. Enter LUKS passphrase
3. Log in
4. Verify intune-health still passes
5. Retry enrollment from task 2

**Do NOT attempt to unenroll/cleanup** - snapshot restore provides cleaner state.

## Recovery Patterns

### Authentication fails with "no certificate found"
1. Check YubiKey is inserted
2. Check pcsc_scan -r shows YubiKey
3. Check Parallels smart card sharing enabled
4. Restore PreIntune snapshot, retry

### Browser window is blank/white
1. Check WEBKIT_DISABLE_DMABUF_RENDERER=1 in wrapper
2. Try with explicit: LIBGL_ALWAYS_SOFTWARE=1 intune-portal-rosetta
3. Restore PreIntune snapshot, retry

### Enrollment completes but compliance fails
1. Review intune-agent logs for specific failure
2. Fix the issue (LUKS, PAM, etc.)
3. Trigger recheck with intune-agent-rosetta
4. If persistent, restore PreIntune and verify configuration first

### Code:1200 error during authentication
1. Verify os-release shows Ubuntu 22.04
2. Verify OpenSSL 3.3.2 is first in LD_LIBRARY_PATH
3. Both should be handled by wrappers - if failing, check home-manager applied correctly
4. Restore PreIntune snapshot, reapply home-manager, retry

## Notes

- Enrollment is a ONE-TIME process per device - be deliberate
- YubiKey PIN has limited attempts (usually 3) before lockout
- intune-agent timer will continue reporting compliance hourly after enrollment
- The Enrolled snapshot captures working state for future reference
- If enrollment succeeds but compliance reporting fails, device may show as "non-compliant" in Intune admin portal temporarily
