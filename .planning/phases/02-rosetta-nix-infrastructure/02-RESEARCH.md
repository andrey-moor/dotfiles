# Phase 2: Rosetta and Nix Infrastructure - Research

**Researched:** 2026-02-02
**Domain:** Rosetta x86_64 emulation, Nix package manager, systemd path units
**Confidence:** HIGH

## Summary

This phase configures x86_64 emulation via Apple's Rosetta and installs the Nix package manager on an Omarchy (Arch Linux) VM running on Apple Silicon via Parallels. The core challenge is ensuring Rosetta's binfmt registration survives reboots despite a race condition with Parallels shared folder mounts.

The repository already contains working patterns in `hosts/endurance/README.md` and `modules/home/linux/rosetta.nix`. This research validates those patterns and documents the verified approach for the prerequisites script.

**Primary recommendation:** Use systemd path unit watching for `/mnt/psf/RosettaLinux/rosetta` to trigger binfmt re-registration after mount, combined with `/etc/binfmt.d/rosetta.conf` for the actual binfmt configuration.

## Standard Stack

The established tools and configuration for this domain:

### Core
| Component | Version/Source | Purpose | Why Standard |
|-----------|----------------|---------|--------------|
| Rosetta | Parallels-provided | x86_64 binary translation | Apple's official emulation layer, fastest option |
| Determinate Nix | Latest stable | Package manager | Best installer, proper systemd integration |
| systemd binfmt | Built-in | Binary format registration | Kernel-level, official mechanism |
| systemd path units | Built-in | File/directory monitoring | Proper fix for mount race condition |

### Supporting
| Component | Purpose | When to Use |
|-----------|---------|-------------|
| `/etc/binfmt.d/rosetta.conf` | Persistent binfmt config | Always - survives reboots |
| `/etc/nix/nix.custom.conf` | Nix extra-platforms | Determinate Nix custom settings |
| x86_64 glibc from Nix | Dynamic linker | Required for x86_64 binaries |

### Not Used
| Instead of | Why Not |
|------------|---------|
| update-binfmts (Debian) | Not available on Arch Linux |
| qemu-user-static | Slower than Rosetta, unnecessary |
| /etc/rc.local | Deprecated, use systemd |

**Installation:**
```bash
# Nix (Determinate installer)
curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
```

## Architecture Patterns

### Rosetta binfmt Configuration

The binfmt_misc kernel subsystem allows arbitrary executable formats to be handled by user-space interpreters. For Rosetta:

**Configuration file:** `/etc/binfmt.d/rosetta.conf`
```
:rosetta:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00:\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/mnt/psf/RosettaLinux/rosetta:PFC
```

**Format breakdown:**
- `:rosetta:` - Handler name
- `M::` - Magic number match (not extension)
- `\x7fELF\x02\x01...` - ELF x86_64 magic bytes
- `\xff\xff...` - Mask for matching
- `/mnt/psf/RosettaLinux/rosetta` - Rosetta binary path (Parallels mount)
- `PFC` - Flags:
  - **P** (preserve-argv[0]): Preserve original argv[0]
  - **F** (fix-binary): Open binary at registration time (required for mount/chroot scenarios)
  - **C** (credentials): Use binary's credentials (required for setuid support)

**Source:** [Linux Kernel binfmt_misc Documentation](https://docs.kernel.org/admin-guide/binfmt-misc.html)

### Boot Race Condition Pattern

**Problem:** The Rosetta binary lives at `/mnt/psf/RosettaLinux/rosetta`, which is a Parallels shared folder. This mount is created by `prltoolsd` (Parallels guest tools), not by systemd. When `systemd-binfmt.service` runs early in boot, the mount doesn't exist yet.

**Solution:** Use systemd path unit to watch for the Rosetta binary to appear, then restart binfmt:

```bash
# /etc/systemd/system/rosetta-binfmt.path
[Unit]
Description=Watch for Rosetta binary to appear

[Path]
PathExists=/mnt/psf/RosettaLinux/rosetta
Unit=rosetta-binfmt.service

[Install]
WantedBy=multi-user.target
```

```bash
# /etc/systemd/system/rosetta-binfmt.service
[Unit]
Description=Register Rosetta binfmt after mount

[Service]
Type=oneshot
ExecStart=/usr/bin/systemctl restart systemd-binfmt
RemainAfterExit=yes
```

**Why this works:** According to [systemd.path documentation](https://www.freedesktop.org/software/systemd/man/latest/systemd.path.html), when the path becomes accessible (even through mount appearing), systemd will detect the change and trigger the associated service.

**Source:** Existing pattern from `hosts/endurance/README.md`

### Nix Configuration Structure

Determinate Nix uses a specific configuration structure:

| File | Purpose | Modify? |
|------|---------|---------|
| `/etc/nix/nix.conf` | Generated by installer | NO - do not modify |
| `/etc/nix/nix.custom.conf` | Custom settings | YES - add extra-platforms here |

**Configuration:**
```bash
echo "extra-platforms = x86_64-linux" | sudo tee -a /etc/nix/nix.custom.conf
sudo chmod 644 /etc/nix/nix.conf  # Determinate creates with 600
sudo systemctl restart nix-daemon
```

**Source:** [Determinate Nix Documentation](https://docs.determinate.systems/determinate-nix/)

### x86_64 Dynamic Linker Pattern

x86_64 binaries look for `/lib64/ld-linux-x86-64.so.2`. On non-FHS systems (NixOS, home-manager on Arch), this doesn't exist by default. Solution:

```bash
# Get x86_64 glibc from Nix store
GLIBC_PATH=$(nix build --no-link --print-out-paths nixpkgs#pkgsCross.gnu64.glibc)

# Create symlink at standard FHS location
sudo mkdir -p /lib64
sudo chmod 755 /lib64
sudo ln -sf "$GLIBC_PATH/lib/ld-linux-x86-64.so.2" /lib64/
```

**Why this works:** Rosetta translates x86_64 instructions but doesn't intercept dynamic linker lookups. The binary still looks for `/lib64/ld-linux-x86-64.so.2` at the hardcoded path.

**Source:** [NixOS Discourse - nix-ld discussion](https://discourse.nixos.org/t/how-to-deal-with-lib64-ld-linux-x86-64-so-2-missing-on-nixos/11401)

### os-release Spoofing Pattern

Microsoft Intune only officially supports Ubuntu. The workaround:

```bash
# Backup original
sudo cp /usr/lib/os-release /usr/lib/os-release.arch.bak

# Spoof as Ubuntu 22.04
sudo tee /usr/lib/os-release << 'EOF'
NAME="Ubuntu"
VERSION="22.04.3 LTS (Jammy Jellyfish)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 22.04.3 LTS"
VERSION_ID="22.04"
VERSION_CODENAME=jammy
UBUNTU_CODENAME=jammy
EOF
```

**Note:** Use `/usr/lib/os-release` not `/etc/os-release`. The latter is typically a symlink to the former on Arch.

**Source:** [How to enroll Arch Linux in Microsoft Intune](https://blog.strits.dk/how-to-enroll-arch-linux-in-microsoft-intune/)

## Don't Hand-Roll

Problems that have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| binfmt persistence | rc.local script | `/etc/binfmt.d/*.conf` + systemd path unit | Proper systemd integration, survives daemon-reload |
| Nix installation | Manual tarball | Determinate installer | Handles systemd, permissions, uninstall |
| x86_64 linker | Copy from FHS distro | `nix build nixpkgs#pkgsCross.gnu64.glibc` | Reproducible, version-tracked |
| Mount race | Sleep in script | systemd PathExists | Event-driven, reliable |

**Key insight:** The existing endurance README documents a working solution. The goal is to extract this into an idempotent prerequisites script, not invent new approaches.

## Common Pitfalls

### Pitfall 1: binfmt Not Registered After Reboot

**What goes wrong:** x86_64 binaries fail with "cannot execute binary file" or Rosetta errors after reboot.

**Why it happens:**
1. systemd-binfmt.service runs before Parallels mounts `/mnt/psf/RosettaLinux/rosetta`
2. Registration fails silently because interpreter path doesn't exist
3. No automatic retry mechanism

**How to avoid:**
- Install rosetta-binfmt.path unit to watch for mount
- Enable path unit: `systemctl enable rosetta-binfmt.path`

**Warning signs:**
- `cat /proc/sys/fs/binfmt_misc/rosetta` shows "disabled" or file doesn't exist
- x86_64 binaries work after manual `systemctl restart systemd-binfmt`

### Pitfall 2: Nix Daemon Permission Issues

**What goes wrong:** `nix build` fails with permission errors after running Determinate installer.

**Why it happens:** Determinate Nix creates `/etc/nix/nix.conf` with 600 permissions, but nix-daemon needs to read it.

**How to avoid:**
```bash
sudo chmod 644 /etc/nix/nix.conf
```

**Warning signs:** Errors about config file not readable, daemon fails to start.

### Pitfall 3: Wrong os-release Location

**What goes wrong:** Intune still reports unsupported distro despite spoofed os-release.

**Why it happens:** Modified `/etc/os-release` but it's a symlink to `/usr/lib/os-release`. Some tools read the source directly.

**How to avoid:** Modify `/usr/lib/os-release` not `/etc/os-release`.

**Warning signs:** `cat /etc/os-release` shows Ubuntu but Intune portal rejects.

### Pitfall 4: Missing Dynamic Linker Symlink

**What goes wrong:** Rosetta translates x86_64 code but process still fails immediately.

**Why it happens:** x86_64 dynamically-linked binaries hardcode `/lib64/ld-linux-x86-64.so.2`. This path doesn't exist on Arch + home-manager.

**How to avoid:** Create symlink to Nix-provided glibc.

**Warning signs:** Error message mentions `/lib64/ld-linux-x86-64.so.2` not found.

### Pitfall 5: Prerequisites Script Not Idempotent

**What goes wrong:** Re-running prerequisites script causes errors or breaks existing setup.

**Why it happens:** Script doesn't check for existing state before modifying.

**How to avoid:**
- Check if file/unit already exists before creating
- Use `tee -a` carefully (only append if not present)
- Use `|| true` for operations that fail if already done

**Warning signs:** Script works first time, fails on second run.

## Code Examples

Verified patterns from existing repository:

### Complete Prerequisites Script Structure

```bash
#!/usr/bin/env bash
# Prerequisites script for Rosetta + Nix on Omarchy VM
# Idempotent: safe to re-run

set -euo pipefail

log() { echo "[+] $1"; }
warn() { echo "[!] $1"; }

# === Rosetta binfmt ===
if [[ ! -f /etc/binfmt.d/rosetta.conf ]]; then
    log "Installing Rosetta binfmt configuration..."
    echo ':rosetta:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00:\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/mnt/psf/RosettaLinux/rosetta:PFC' | sudo tee /etc/binfmt.d/rosetta.conf
else
    log "Rosetta binfmt already configured"
fi

# === Path watcher for boot race ===
if [[ ! -f /etc/systemd/system/rosetta-binfmt.path ]]; then
    log "Installing Rosetta binfmt path watcher..."
    cat << 'EOF' | sudo tee /etc/systemd/system/rosetta-binfmt.path
[Unit]
Description=Watch for Rosetta binary to appear

[Path]
PathExists=/mnt/psf/RosettaLinux/rosetta
Unit=rosetta-binfmt.service

[Install]
WantedBy=multi-user.target
EOF

    cat << 'EOF' | sudo tee /etc/systemd/system/rosetta-binfmt.service
[Unit]
Description=Register Rosetta binfmt after mount

[Service]
Type=oneshot
ExecStart=/usr/bin/systemctl restart systemd-binfmt
RemainAfterExit=yes
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable rosetta-binfmt.path
else
    log "Rosetta path watcher already installed"
fi

# === Restart binfmt now (if mount available) ===
if [[ -f /mnt/psf/RosettaLinux/rosetta ]]; then
    log "Rosetta binary available, restarting binfmt..."
    sudo systemctl restart systemd-binfmt
fi

# === Nix (Determinate) ===
if ! command -v nix &>/dev/null; then
    log "Installing Nix (Determinate)..."
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
    # Source for current shell
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
else
    log "Nix already installed"
fi

# === Fix Nix config permissions ===
if [[ -f /etc/nix/nix.conf ]]; then
    sudo chmod 644 /etc/nix/nix.conf
    if [[ -f /etc/nix/nix.daemon.service ]]; then
        sudo chmod 644 /etc/systemd/system/nix-daemon.service
    fi
fi

# === extra-platforms ===
if ! grep -q "extra-platforms.*x86_64-linux" /etc/nix/nix.custom.conf 2>/dev/null; then
    log "Adding extra-platforms for x86_64..."
    echo "extra-platforms = x86_64-linux" | sudo tee -a /etc/nix/nix.custom.conf
    sudo systemctl restart nix-daemon
else
    log "extra-platforms already configured"
fi

# === x86_64 dynamic linker ===
if [[ ! -L /lib64/ld-linux-x86-64.so.2 ]]; then
    log "Installing x86_64 dynamic linker..."
    GLIBC_PATH=$(nix build --no-link --print-out-paths nixpkgs#pkgsCross.gnu64.glibc)
    sudo mkdir -p /lib64
    sudo chmod 755 /lib64
    sudo ln -sf "$GLIBC_PATH/lib/ld-linux-x86-64.so.2" /lib64/
else
    log "x86_64 dynamic linker already installed"
fi

# === os-release spoof ===
if ! grep -q 'ID=ubuntu' /usr/lib/os-release 2>/dev/null; then
    log "Spoofing os-release as Ubuntu 22.04..."
    sudo cp /usr/lib/os-release /usr/lib/os-release.arch.bak
    sudo tee /usr/lib/os-release << 'EOF'
NAME="Ubuntu"
VERSION="22.04.3 LTS (Jammy Jellyfish)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 22.04.3 LTS"
VERSION_ID="22.04"
VERSION_CODENAME=jammy
UBUNTU_CODENAME=jammy
EOF
else
    log "os-release already spoofed"
fi

log "Prerequisites complete!"
```
*Source: Synthesized from hosts/endurance/README.md*

### Verification Commands

```bash
# Verify Rosetta binfmt is registered
cat /proc/sys/fs/binfmt_misc/rosetta
# Should show: enabled

# Verify extra-platforms
nix show-config | grep extra-platforms
# Should include: x86_64-linux

# Verify dynamic linker
file /lib64/ld-linux-x86-64.so.2
# Should show: symbolic link to /nix/store/...

# Verify os-release
cat /etc/os-release | grep ID
# Should show: ID=ubuntu

# Test x86_64 binary execution
nix build --no-link --print-out-paths nixpkgs#legacyPackages.x86_64-linux.hello
# Run the built binary - should work via Rosetta
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| rc.local for binfmt | systemd binfmt.d + path unit | systemd adoption | Reliable boot integration |
| Official Nix installer | Determinate Nix | 2023+ | Better macOS/Linux parity, uninstall support |
| Manual glibc copy | Nix cross-compile glibc | Always | Reproducible, versioned |
| update-binfmts (Debian) | /etc/binfmt.d (systemd native) | Arch default | Works on any systemd distro |

**Current/recommended:**
- Determinate Nix is the preferred installer for consistency
- systemd path units for file watching (not polling scripts)
- `/etc/binfmt.d/` for persistent binfmt configuration

## Open Questions

Things that couldn't be fully resolved:

1. **Exact Determinate Nix service file permissions**
   - What we know: nix.conf needs chmod 644
   - What's unclear: Do socket/service files also need permission fix?
   - Recommendation: Check permissions on first run, fix all to 644

2. **Path unit vs RequiresMountsFor**
   - What we know: Path unit works per endurance README
   - What's unclear: Would `RequiresMountsFor=/mnt/psf` work if we knew the mount unit?
   - Recommendation: Use path unit - proven, mount unit name unclear (prltoolsd creates it)

3. **glibc symlink stability across Nix updates**
   - What we know: Symlink points to specific Nix store path
   - What's unclear: Does `nix-collect-garbage` break it?
   - Recommendation: Re-run prerequisites script after garbage collection, or add as GC root

## Sources

### Primary (HIGH confidence)
- [Linux Kernel binfmt_misc Documentation](https://docs.kernel.org/admin-guide/binfmt-misc.html) - Flag definitions, registration format
- [systemd.path(5) man page](https://www.freedesktop.org/software/systemd/man/latest/systemd.path.html) - PathExists behavior, inotify limitations
- [Determinate Nix Documentation](https://docs.determinate.systems/determinate-nix/) - nix.custom.conf, configuration structure
- `hosts/endurance/README.md` - Existing working patterns in repository

### Secondary (MEDIUM confidence)
- [Parallels KB 129871](https://kb.parallels.com/129871) - General Rosetta setup (lacks binfmt details)
- [How to enroll Arch Linux in Microsoft Intune](https://blog.strits.dk/how-to-enroll-arch-linux-in-microsoft-intune/) - os-release spoofing
- [NixOS Discourse - nix-ld](https://discourse.nixos.org/t/how-to-deal-with-lib64-ld-linux-x86-64-so-2-missing-on-nixos/11401) - Dynamic linker solutions

### Tertiary (LOW confidence)
- Forum discussions about specific error scenarios - useful for troubleshooting section

## Metadata

**Confidence breakdown:**
- Rosetta binfmt registration: HIGH - Kernel docs + existing working config
- Path unit pattern: HIGH - systemd docs + existing working config
- Nix installation: HIGH - Determinate docs + existing working config
- os-release spoofing: MEDIUM - Blog post, confirmed by existing README
- Dynamic linker: MEDIUM - Community pattern, not official docs

**Research date:** 2026-02-02
**Valid until:** 2026-03-02 (30 days - stable domain, unlikely to change)
