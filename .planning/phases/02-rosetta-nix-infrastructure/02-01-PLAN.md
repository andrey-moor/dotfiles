---
phase: 02-rosetta-nix-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/prerequisites.sh
autonomous: true

must_haves:
  truths:
    - "Script installs Nix with extra-platforms = x86_64-linux"
    - "Script configures Rosetta binfmt with path watcher for boot survival"
    - "Script creates x86_64 dynamic linker symlink"
    - "Script spoofs os-release as Ubuntu 22.04"
    - "Script is idempotent (safe to re-run)"
  artifacts:
    - path: "scripts/prerequisites.sh"
      provides: "Idempotent system setup for Rosetta + Nix"
      min_lines: 80
      contains:
        - "binfmt.d/rosetta.conf"
        - "rosetta-binfmt.path"
        - "extra-platforms"
        - "os-release"
  key_links:
    - from: "scripts/prerequisites.sh"
      to: "/etc/binfmt.d/rosetta.conf"
      via: "tee command"
      pattern: "tee /etc/binfmt.d/rosetta.conf"
    - from: "scripts/prerequisites.sh"
      to: "/etc/systemd/system/rosetta-binfmt.path"
      via: "tee command"
      pattern: "rosetta-binfmt.path"
---

<objective>
Create an idempotent prerequisites script that configures Rosetta x86_64 emulation and Nix package manager on Omarchy VMs.

Purpose: Automate the manual steps from hosts/endurance/README.md sections 1-6 into a single idempotent script that can be run on any freshly cloned VM.

Output: `scripts/prerequisites.sh` - a bash script that handles Nix installation, Rosetta binfmt registration (with boot-survival path watcher), x86_64 dynamic linker, and os-release spoofing.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-rosetta-nix-infrastructure/02-RESEARCH.md

# Reference for existing patterns
@hosts/endurance/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prerequisites.sh script</name>
  <files>scripts/prerequisites.sh</files>
  <action>
Create `scripts/prerequisites.sh` with the following structure, synthesized from the research document and endurance README:

1. Script header with set -euo pipefail and helper functions (log, warn)

2. Rosetta binfmt section:
   - Check if /etc/binfmt.d/rosetta.conf exists
   - If not, create with the x86_64 ELF magic bytes configuration:
     `:rosetta:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00:\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/mnt/psf/RosettaLinux/rosetta:PFC`

3. Path watcher for boot race condition:
   - Check if /etc/systemd/system/rosetta-binfmt.path exists
   - If not, create both rosetta-binfmt.path and rosetta-binfmt.service
   - Path unit watches for /mnt/psf/RosettaLinux/rosetta to appear
   - Service unit restarts systemd-binfmt when triggered
   - Run systemctl daemon-reload and enable rosetta-binfmt.path

4. Trigger binfmt immediately if mount available:
   - Check if /mnt/psf/RosettaLinux/rosetta exists
   - If yes, run systemctl restart systemd-binfmt

5. Nix installation:
   - Check if `nix` command exists
   - If not, run Determinate Nix installer with --no-confirm
   - Source nix-daemon.sh for current shell

6. Fix Nix permissions:
   - chmod 644 /etc/nix/nix.conf (Determinate creates with 600)
   - chmod 644 on related systemd service files if they exist

7. extra-platforms configuration:
   - Check if /etc/nix/nix.custom.conf contains "extra-platforms.*x86_64-linux"
   - If not, append "extra-platforms = x86_64-linux"
   - Restart nix-daemon

8. x86_64 dynamic linker:
   - Check if /lib64/ld-linux-x86-64.so.2 is a symlink
   - If not, build glibc via nix: `nix build --no-link --print-out-paths nixpkgs#pkgsCross.gnu64.glibc`
   - Create /lib64 directory and symlink to glibc's ld-linux-x86-64.so.2

9. os-release spoofing:
   - Check if /usr/lib/os-release contains "ID=ubuntu"
   - If not, backup original and replace with Ubuntu 22.04 content
   - Use /usr/lib/os-release NOT /etc/os-release (latter is symlink)

10. Final message with verification commands

Make script executable (chmod +x in the script creation).

IMPORTANT: Each section must have idempotent checks (if file/config already exists, skip and log "already configured"). Use || true only where appropriate, prefer explicit checks.
  </action>
  <verify>
    - File exists: `ls -la scripts/prerequisites.sh`
    - Script is executable: `test -x scripts/prerequisites.sh && echo "executable"`
    - Script has shebang: `head -1 scripts/prerequisites.sh`
    - Script contains all required sections: `grep -c "binfmt\|extra-platforms\|os-release\|lib64" scripts/prerequisites.sh`
    - Shellcheck passes: `shellcheck scripts/prerequisites.sh || echo "shellcheck warnings"`
  </verify>
  <done>
    scripts/prerequisites.sh exists, is executable, contains all 9 configuration sections with idempotent checks, and passes basic validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update endurance README to reference script</name>
  <files>hosts/endurance/README.md</files>
  <action>
Update hosts/endurance/README.md Prerequisites section (lines 209-296) to reference the new script:

1. Add a "Quick Start" at the top of Prerequisites section:
   ```markdown
   ### Prerequisites

   **Quick Start:**
   ```bash
   curl -fsSL https://raw.githubusercontent.com/andrey-moor/dotfiles/main/scripts/prerequisites.sh | bash
   # Or from cloned repo:
   /mnt/psf/Home/Documents/dotfiles/scripts/prerequisites.sh
   ```

   This script handles steps 1-6 below automatically. Continue with step 7 after the script completes.

   <details>
   <summary>Manual Steps (if script fails)</summary>
   ```

2. Wrap existing steps 1-6 in the details/summary block

3. Keep steps 7-12 (Device Broker, pcscd, keyring, etc.) as they are - these are Phase 5 concerns

This keeps the manual steps documented as fallback while promoting the script as primary method.
  </action>
  <verify>
    - README contains script reference: `grep -q "prerequisites.sh" hosts/endurance/README.md && echo "found"`
    - README still contains manual steps: `grep -q "Install Nix" hosts/endurance/README.md && echo "found"`
  </verify>
  <done>
    hosts/endurance/README.md updated with prerequisites.sh quick start, manual steps preserved as fallback.
  </done>
</task>

</tasks>

<verification>
Run these commands to verify the plan completed successfully:

```bash
# Script exists and is executable
ls -la scripts/prerequisites.sh

# Script has all required sections
echo "Checking required sections..."
grep -q "binfmt.d/rosetta.conf" scripts/prerequisites.sh && echo "- Rosetta binfmt: OK"
grep -q "rosetta-binfmt.path" scripts/prerequisites.sh && echo "- Path watcher: OK"
grep -q "extra-platforms" scripts/prerequisites.sh && echo "- extra-platforms: OK"
grep -q "lib64" scripts/prerequisites.sh && echo "- Dynamic linker: OK"
grep -q "os-release" scripts/prerequisites.sh && echo "- os-release: OK"

# README updated
grep -q "prerequisites.sh" hosts/endurance/README.md && echo "- README updated: OK"
```
</verification>

<success_criteria>
1. scripts/prerequisites.sh exists and is executable
2. Script contains idempotent checks for all 9 configuration sections
3. Script follows patterns from research document (RESEARCH.md)
4. hosts/endurance/README.md references the script as quick start
5. Manual steps preserved as fallback documentation
</success_criteria>

<output>
After completion, create `.planning/phases/02-rosetta-nix-infrastructure/02-01-SUMMARY.md`
</output>
