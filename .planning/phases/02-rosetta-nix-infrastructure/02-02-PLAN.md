---
phase: 02-rosetta-nix-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Prerequisites script runs successfully on fresh VM clone"
    - "Script is idempotent (second run completes without errors)"
    - "Rosetta binfmt survives reboot (path watcher works)"
    - "x86_64 binaries execute via Rosetta after reboot"
    - "home-manager switch completes from shared folder path"
  artifacts:
    - path: "/etc/binfmt.d/rosetta.conf"
      provides: "Rosetta binfmt configuration"
    - path: "/etc/systemd/system/rosetta-binfmt.path"
      provides: "Path watcher for boot race condition"
    - path: "/lib64/ld-linux-x86-64.so.2"
      provides: "x86_64 dynamic linker symlink"
  key_links:
    - from: "rosetta-binfmt.path"
      to: "rosetta-binfmt.service"
      via: "systemd Unit= directive"
      pattern: "Unit=rosetta-binfmt.service"
    - from: "rosetta-binfmt.service"
      to: "systemd-binfmt"
      via: "ExecStart restart"
      pattern: "systemctl restart systemd-binfmt"
---

<objective>
Validate the prerequisites script on a fresh VM clone, verify reboot survival, and confirm home-manager switch works.

Purpose: Prove the script works end-to-end on a real VM, including the critical reboot test that validates VM-05 (binfmt survives reboot).

Output: Validated infrastructure setup ready for Phase 3 (automation scripts) and later phases.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-rosetta-nix-infrastructure/02-RESEARCH.md
@.planning/phases/02-rosetta-nix-infrastructure/02-01-SUMMARY.md

# Script to test
@scripts/prerequisites.sh
# Clone workflow reference
@docs/template-generalization.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clone EncryptedBase-GRUB to test VM</name>
  <files></files>
  <action>
Clone the EncryptedBase-GRUB snapshot to create a test VM for validation:

```bash
# From macOS terminal
prlctl clone ArchBase-Template --name Phase02-Test --snapshot EncryptedBase-GRUB

# Start the VM
prlctl start Phase02-Test
```

Wait for VM to boot to LUKS passphrase prompt. Enter passphrase "temppass" (from template).

After boot to login prompt, log in as root (password: temppass).

Run armarchy to create user and desktop (quick ~15min):
```bash
bash <(curl -sL arm.omarchy.com)
```

After armarchy completes and reboot, log in as new user.

NOTE: If prlctl clone fails, the test can be done on an existing VM or the ArchBase-Template itself (less clean but acceptable for validation).
  </action>
  <verify>
    - VM exists: `prlctl list -a | grep Phase02-Test`
    - VM is running: `prlctl list | grep Phase02-Test | grep running`
  </verify>
  <done>
    Phase02-Test VM cloned from EncryptedBase-GRUB, armarchy installed, user logged in.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run prerequisites script and verify</name>
  <files></files>
  <action>
Run the prerequisites script on Phase02-Test VM:

1. Execute script from shared folder:
```bash
# In VM terminal
sudo /mnt/psf/Home/Documents/dotfiles/scripts/prerequisites.sh
```

2. After script completes, verify each component:
```bash
# Rosetta binfmt registered
cat /proc/sys/fs/binfmt_misc/rosetta | head -1
# Should show: enabled

# Path watcher installed
systemctl status rosetta-binfmt.path
# Should show: active

# Nix installed with extra-platforms
nix show-config | grep extra-platforms
# Should show: extra-platforms = x86_64-linux

# Dynamic linker symlink
file /lib64/ld-linux-x86-64.so.2
# Should show: symbolic link to /nix/store/...

# os-release spoofed
grep "^ID=" /etc/os-release
# Should show: ID=ubuntu
```

3. Test idempotency - run script again:
```bash
sudo /mnt/psf/Home/Documents/dotfiles/scripts/prerequisites.sh
```
Script should complete with "already configured" messages, no errors.

4. Test x86_64 binary execution:
```bash
# Build and run an x86_64 binary
HELLO=$(nix build --no-link --print-out-paths nixpkgs#legacyPackages.x86_64-linux.hello)
$HELLO/bin/hello
# Should output: Hello, world!
```
  </action>
  <verify>
    - Script completed without errors
    - Rosetta binfmt enabled: `cat /proc/sys/fs/binfmt_misc/rosetta | grep enabled`
    - x86_64 binary works: `$HELLO/bin/hello` outputs "Hello, world!"
    - Idempotent: second run has no errors
  </verify>
  <done>
    Prerequisites script runs successfully, all components configured, idempotency verified, x86_64 binary executes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Prerequisites script configured Rosetta, Nix, and os-release on test VM</what-built>
  <how-to-verify>
**Reboot test (critical for VM-05 requirement):**

1. Reboot the VM:
   ```bash
   sudo reboot
   ```

2. Enter LUKS passphrase at boot prompt

3. After login, verify Rosetta binfmt survived:
   ```bash
   # This is the critical test - should show "enabled" without manual intervention
   cat /proc/sys/fs/binfmt_misc/rosetta | head -1
   # Expected: enabled

   # Run x86_64 binary to confirm
   HELLO=$(nix build --no-link --print-out-paths nixpkgs#legacyPackages.x86_64-linux.hello)
   $HELLO/bin/hello
   # Expected: Hello, world!
   ```

4. If binfmt NOT enabled after reboot, check path watcher:
   ```bash
   systemctl status rosetta-binfmt.path
   journalctl -u rosetta-binfmt.service
   ```

**Pass criteria:**
- Rosetta binfmt shows "enabled" after reboot WITHOUT manual intervention
- x86_64 hello binary executes successfully

Type "reboot verified" to continue, or describe any issues.
  </how-to-verify>
  <resume-signal>Type "reboot verified" or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Verify home-manager switch</name>
  <files></files>
  <action>
Test home-manager switch from shared folder path (NIX-02 requirement):

```bash
# Navigate to dotfiles via shared folder
cd /mnt/psf/Home/Documents/dotfiles

# Run home-manager switch
nix run home-manager -- switch --flake .#endurance -b backup
```

This should:
1. Build the home-manager configuration
2. Install packages defined in hosts/endurance/default.nix
3. Create symlinks for user programs

After completion, verify:
```bash
# Check home-manager generation
home-manager generations | head -1

# Verify a package was installed (e.g., intune-status)
which intune-status || echo "Package not in PATH yet - may need new shell"

# If package not found, source profile
source ~/.nix-profile/etc/profile.d/hm-session-vars.sh
which intune-status
```

Note: If home-manager switch fails due to missing dependencies, document the error. The script covers infrastructure only - some failures may be expected at this phase.
  </action>
  <verify>
    - home-manager switch completes (may have warnings)
    - Generation created: `home-manager generations | head -1` shows recent timestamp
  </verify>
  <done>
    home-manager switch completes from shared folder path, generation created.
  </done>
</task>

<task type="auto">
  <name>Task 5: Cleanup test VM</name>
  <files></files>
  <action>
After validation, clean up the test VM:

```bash
# From macOS terminal
prlctl stop Phase02-Test --kill
prlctl delete Phase02-Test
```

If you want to keep the VM for further testing, skip this task and note it in the summary.
  </action>
  <verify>
    - VM removed: `prlctl list -a | grep -v Phase02-Test`
  </verify>
  <done>
    Test VM cleaned up (or retained with note in summary).
  </done>
</task>

</tasks>

<verification>
Phase 2 success criteria checklist:

1. [ ] After reboot, x86_64 binaries execute via Rosetta without manual intervention
   - Test: `cat /proc/sys/fs/binfmt_misc/rosetta` shows "enabled" after fresh boot

2. [ ] Nix builds x86_64 packages via extra-platforms configuration
   - Test: `nix build --no-link nixpkgs#legacyPackages.x86_64-linux.hello` succeeds

3. [ ] home-manager switch completes successfully from shared folder path
   - Test: `nix run home-manager -- switch --flake /mnt/psf/Home/Documents/dotfiles#endurance` completes

4. [ ] os-release shows Ubuntu 22.04 for Intune compatibility
   - Test: `grep "^ID=" /etc/os-release` shows "ID=ubuntu"

5. [ ] Prerequisites script is idempotent (can be re-run safely)
   - Test: Running script twice produces no errors on second run

All criteria must pass for Phase 2 completion.
</verification>

<success_criteria>
1. Prerequisites script runs without errors on fresh VM
2. Script is idempotent (re-run completes successfully)
3. Rosetta binfmt survives reboot (path watcher working)
4. x86_64 binary execution works after reboot
5. home-manager switch completes from shared folder
6. os-release shows Ubuntu 22.04
</success_criteria>

<output>
After completion, create `.planning/phases/02-rosetta-nix-infrastructure/02-02-SUMMARY.md`
</output>
