---
phase: 07-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hosts/stargazer/README.md
autonomous: true

must_haves:
  truths:
    - "Each major section has a verification checklist"
    - "Pre-flight checklist exists before starting setup"
    - "Failed verification links to troubleshooting"
    - "Document shows last updated date and package versions"
  artifacts:
    - path: "hosts/stargazer/README.md"
      provides: "E2E guide with embedded verification checklists"
      contains: "### Verification"
  key_links:
    - from: "hosts/stargazer/README.md"
      to: "docs/TROUBLESHOOTING.md"
      via: "cross-reference links"
      pattern: "See.*TROUBLESHOOTING"
---

<objective>
Enhance the existing E2E guide with formal verification checklists at each major section.

Purpose: Users can verify each step succeeded before proceeding, catching failures at point of origin rather than debugging downstream issues.

Output: Updated `hosts/stargazer/README.md` with verification checklists embedded after each numbered section.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-documentation/07-RESEARCH.md

@hosts/stargazer/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add document header with metadata</name>
  <files>hosts/stargazer/README.md</files>
  <action>
Add metadata block after the title:

```markdown
# Stargazer Setup

> **Last updated:** 2026-02-03
> **Intune Portal:** 1.2511.7 | **Broker:** 2.10.90 | **OpenSSL:** 3.3.2
> **Template:** ArchBase-LUKS-GRUB.pvmp v1.0

Encrypted Arch Linux ARM VM in Parallels with LUKS for Microsoft Intune compliance.
```

Add pre-flight checklist after Quick Start section:

```markdown
## Pre-Flight Checklist

Before starting, verify these requirements:

- [ ] macOS on Apple Silicon (M1/M2/M3)
- [ ] Parallels Desktop Pro or Business installed
- [ ] Dotfiles cloned to `~/Documents/dotfiles`
- [ ] Template file available (`ArchBase-LUKS-GRUB.pvmp` or existing ArchBase-Template VM)
- [ ] 30+ minutes for full setup (mostly waiting for downloads)
- [ ] YubiKey available for enrollment step (optional - can enroll later)

**Tip:** Create VM snapshots before major changes. If something breaks, restore and retry.
```
  </action>
  <verify>grep -c "Last updated" hosts/stargazer/README.md returns 1</verify>
  <done>Document has metadata header and pre-flight checklist</done>
</task>

<task type="auto">
  <name>Task 2: Add verification checklists to sections 1-5</name>
  <files>hosts/stargazer/README.md</files>
  <action>
Add verification checklist after each section's instructions:

**Section 1: Import Template** - Add after "Configure VM" block:
```markdown
### Verification

```bash
prlctl list -a | grep stargazer
# Expected: stargazer listed as "stopped"

prlctl list -i stargazer | grep -E "(cpu|memory|rosetta|shf)"
# Expected: cpus=4, memsize=8192, rosetta=on, shf-host=on
```

- [ ] VM listed with correct name
- [ ] 4 CPUs and 8GB RAM configured
- [ ] Rosetta and shared folders enabled

**If verification fails:** See [Troubleshooting: Clone Won't Start](../../docs/TROUBLESHOOTING.md#clone-wont-start)
```

**Section 2: First Boot** - Add after "At login" line:
```markdown
### Verification

- [ ] GRUB menu appeared (not Limine)
- [ ] LUKS passphrase prompt accepted `4815162342`
- [ ] Logged in as root successfully

**If verification fails:** See [Troubleshooting: No LUKS Passphrase Prompt](../../docs/TROUBLESHOOTING.md#no-luks-passphrase-prompt)
```

**Section 3: Security Setup** - Add after hostname command:
```markdown
### Verification

```bash
hostnamectl
# Expected: hostname shows new name

cat /etc/hostname
# Expected: new hostname only
```

- [ ] LUKS passphrase changed (test with `cryptsetup luksDump /dev/vda2`)
- [ ] Root password changed
- [ ] Hostname updated

**Note:** LUKS change verified on next reboot. Don't forget your new passphrase!
```

**Section 4: Install Omarchy** - Add after password requirements:
```markdown
### Verification

```bash
id yourusername
# Expected: uid and gid shown

ls -la /home/yourusername
# Expected: home directory exists
```

- [ ] User created with username you specified
- [ ] Password meets Intune requirements (12+ chars, mixed case, digit, symbol)
- [ ] **Did NOT reboot yet** (GRUB fix required first)

**If armarchy fails:** Re-run the curl command. Script is idempotent.
```

**Section 5: Restore GRUB Bootloader** - Add after file size check:
```markdown
### Verification

```bash
ls -la /boot/EFI/BOOT/BOOTAA64.EFI
# Expected: ~160KB (158720 bytes), not ~90KB

file /boot/EFI/BOOT/BOOTAA64.EFI
# Expected: "PE32+ executable (EFI application)"
```

- [ ] File size is ~160KB (GRUB), not ~90KB (Limine)
- [ ] File is valid EFI executable
- [ ] Reboot completed successfully
- [ ] LUKS prompt appeared with your new passphrase
- [ ] Logged in as your user (not root)

**If verification fails:** See [Troubleshooting: Limine Boots Instead of GRUB](../../docs/TROUBLESHOOTING.md#limine-boots-instead-of-grub)
```
  </action>
  <verify>grep -c "### Verification" hosts/stargazer/README.md returns at least 5</verify>
  <done>Sections 1-5 have verification checklists with pass/fail criteria</done>
</task>

<task type="auto">
  <name>Task 3: Add verification checklists to sections 6-9</name>
  <files>hosts/stargazer/README.md</files>
  <action>
**Section 6: Run Prerequisites Script** - Add after script description:
```markdown
### Verification

```bash
# Check Rosetta
cat /proc/sys/fs/binfmt_misc/rosetta
# Expected: "enabled" in output

# Check Nix
nix --version
# Expected: nix (Nix) 2.x.x

# Check dynamic linker
ls -la /lib64/ld-linux-x86-64.so.2
# Expected: symlink to glibc loader

# Check os-release spoof
cat /etc/os-release | head -2
# Expected: NAME="Ubuntu", VERSION_ID="22.04"
```

- [ ] Rosetta binfmt registered and enabled
- [ ] Nix installed and in PATH
- [ ] Dynamic linker symlink exists
- [ ] os-release shows Ubuntu 22.04

**If verification fails:** See [Troubleshooting: Rosetta/Nix Issues](../../docs/TROUBLESHOOTING.md#rosetta-binfmt-not-registered)
```

**Section 7: Apply Home-Manager** - Add after "takes several minutes" line:
```markdown
### Verification

```bash
# Check home-manager generation
home-manager generations | head -1
# Expected: recent timestamp with generation number

# Check intune commands available
which intune-health
# Expected: path in ~/.nix-profile/bin/

# Check packages
nix profile list | grep intune
# Expected: intune-portal and related packages listed
```

- [ ] Home-manager generation created
- [ ] `intune-health`, `intune-status`, `intune-portal-rosetta` commands exist
- [ ] No error messages during switch

**If verification fails:** Re-run the `nix run home-manager` command. Check `nix.conf` has extra-platforms.
```

**Section 8: Intune Setup** - Add after "Verify Setup" subsection (integrate into existing):
```markdown
### Verification

After running `intune-prerequisites` and creating keyring:

```bash
intune-health
# Expected: All [PASS] for critical checks, YubiKey warnings OK
```

- [ ] intune-health exits with code 0
- [ ] D-Bus service: PASS
- [ ] Device broker: PASS
- [ ] pcscd: PASS
- [ ] Keyring: PASS
- [ ] Login keyring created in seahorse as "login"
- [ ] Login keyring set as default

**If verification fails:** See [Troubleshooting: Intune Prerequisites](../../docs/TROUBLESHOOTING.md#device-broker-fails)
```

**Section 9: Enroll Device** - Existing pre-enrollment checklist is good, add post-enrollment:
```markdown
### Verification (Post-Enrollment)

```bash
# Check enrollment status
intune-status
# Expected: Shows enrolled state

# Trigger compliance check
intune-agent-rosetta

# Check compliance report
journalctl --user -u intune-agent --since "5 minutes ago" | tail -20
# Expected: compliance check completed, no critical errors
```

- [ ] Device shows as enrolled in portal
- [ ] intune-agent runs without errors
- [ ] Compliance check completes (may show warnings for optional items)

**If enrollment fails:** See [Troubleshooting: Enrollment Issues](../../docs/TROUBLESHOOTING.md#enrollment-fails)
```
  </action>
  <verify>grep -c "### Verification" hosts/stargazer/README.md returns at least 9</verify>
  <done>All numbered sections have verification checklists</done>
</task>

</tasks>

<verification>
1. Document has metadata header with version info
2. Pre-flight checklist exists before section 1
3. Each numbered section (1-9) has "### Verification" subsection
4. Checklists include both commands and checkbox items
5. Failed verification links to TROUBLESHOOTING.md (even if file doesn't exist yet)
</verification>

<success_criteria>
- [ ] `grep -c "### Verification" hosts/stargazer/README.md` returns 9+
- [ ] `grep -c "TROUBLESHOOTING.md" hosts/stargazer/README.md` returns 5+
- [ ] `grep -c "Last updated" hosts/stargazer/README.md` returns 1
- [ ] Document renders correctly in markdown preview
</success_criteria>

<output>
After completion, create `.planning/phases/07-documentation/07-01-SUMMARY.md`
</output>
