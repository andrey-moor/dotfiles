---
phase: 07-documentation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/UPGRADE-PROCEDURES.md
autonomous: true

must_haves:
  truths:
    - "Upgrade procedures exist for each pinned component"
    - "Pre-upgrade checklists prevent data loss"
    - "Rollback procedures document recovery steps"
    - "Version history tracks what's known to work"
  artifacts:
    - path: "docs/UPGRADE-PROCEDURES.md"
      provides: "Package upgrade and rollback procedures"
      contains: "## Upgrading"
  key_links:
    - from: "docs/UPGRADE-PROCEDURES.md"
      to: "modules/home/linux/intune.nix"
      via: "package version references"
      pattern: "intune.nix|default.nix"
---

<objective>
Create upgrade procedures for all pinned packages and major components.

Purpose: Safely upgrade Intune packages, OpenSSL, and Omarchy without breaking enrollment or compliance. Document rollback procedures for when upgrades fail.

Output: New `docs/UPGRADE-PROCEDURES.md` covering Omarchy, Intune packages, and pinned dependencies.
</objective>

<execution_context>
@/Users/andreym/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andreym/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-documentation/07-RESEARCH.md

@modules/home/linux/intune.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upgrade procedures structure and Omarchy section</name>
  <files>docs/UPGRADE-PROCEDURES.md</files>
  <action>
Create `docs/UPGRADE-PROCEDURES.md`:

```markdown
# Upgrade Procedures

> **Last updated:** 2026-02-03
> **Applies to:** Stargazer and similar Intune-enrolled VMs

This document covers upgrade procedures for components in the Intune-compliant Arch Linux ARM setup. Because several packages are pinned to specific versions for compatibility, upgrades require careful testing.

## Golden Rule

**Always create a VM snapshot before upgrading anything.** If an upgrade breaks enrollment or compliance, restore the snapshot and report the issue.

```bash
# Before any upgrade
prlctl snapshot stargazer -n "Pre-Upgrade-$(date +%Y%m%d)" -d "Before upgrading X"
```

## Table of Contents

1. [Omarchy (System)](#omarchy-system)
2. [Intune Portal](#intune-portal)
3. [Microsoft Identity Broker](#microsoft-identity-broker)
4. [Microsoft Identity Device Broker](#microsoft-identity-device-broker)
5. [OpenSSL (Pinned)](#openssl-pinned)
6. [OpenSC (Pinned)](#opensc-pinned)
7. [Full System Upgrade](#full-system-upgrade)

---

## Omarchy (System)

**Current version:** armarchy-3-x
**Update frequency:** When new Omarchy releases (major versions)
**Risk level:** MEDIUM - Desktop environment changes

### When to Upgrade

- New Omarchy major version released (armarchy-4-x, etc.)
- Security patches for base system
- New features you want

### Pre-Upgrade Checklist

- [ ] VM snapshot created
- [ ] Device currently enrolled and compliant
- [ ] Documented any custom configs outside home-manager
- [ ] Know your LUKS passphrase (you'll need it)

### Procedure

1. **Create snapshot:**
   ```bash
   # From macOS
   prlctl snapshot stargazer -n "Pre-Omarchy-Upgrade" -d "Before armarchy upgrade"
   ```

2. **Check current version:**
   ```bash
   cat /etc/os-release | grep -i omarchy
   ```

3. **Run upgrade:**
   ```bash
   curl -fsSL hdwy.link/armarchy-X-x | bash
   ```
   (Replace X with new version number)

4. **CRITICAL: Restore GRUB before reboot:**
   ```bash
   sudo cp /boot/EFI/GRUB/grubaa64.efi /boot/EFI/BOOT/BOOTAA64.EFI
   ```

5. **Reboot:**
   ```bash
   sudo reboot
   ```

### Post-Upgrade Verification

```bash
# Check system boots with LUKS
# Enter your passphrase

# Verify Omarchy version
cat /etc/os-release

# Verify Nix still works
nix --version

# Verify Intune still works
intune-health

# Check enrollment status
intune-status
```

- [ ] System boots with LUKS passphrase prompt
- [ ] Logged in successfully
- [ ] `nix --version` works
- [ ] `intune-health` passes (exit code 0)
- [ ] Device still shows enrolled in portal

### Rollback

If verification fails:

1. Shutdown VM:
   ```bash
   # From macOS
   prlctl stop stargazer --kill
   ```

2. Restore snapshot:
   ```bash
   prlctl snapshot-switch stargazer --name "Pre-Omarchy-Upgrade"
   ```

3. Start VM:
   ```bash
   prlctl start stargazer
   ```

### Version History

| Date | Version | Notes |
|------|---------|-------|
| 2026-02-03 | armarchy-3-x | Current working version |

---
```
  </action>
  <verify>head -100 docs/UPGRADE-PROCEDURES.md shows structure and Omarchy section</verify>
  <done>Document structure and Omarchy upgrade procedure created</done>
</task>

<task type="auto">
  <name>Task 2: Add Intune package upgrade sections</name>
  <files>docs/UPGRADE-PROCEDURES.md</files>
  <action>
Add the Intune package sections:

```markdown
## Intune Portal

**Current version:** 1.2511.7
**Package source:** Microsoft .deb repackaged via Nix
**Location:** `packages/intune-portal/default.nix`
**Update frequency:** When Microsoft releases new version
**Risk level:** MEDIUM - May break enrollment flow

### When to Upgrade

- Microsoft announces security fix
- Current version has bugs you're experiencing
- Microsoft deprecates current version

### Finding New Versions

Microsoft publishes Linux packages at: https://packages.microsoft.com/ubuntu/22.04/prod/pool/main/i/intune-portal/

Check for new versions:
```bash
curl -s https://packages.microsoft.com/ubuntu/22.04/prod/pool/main/i/intune-portal/ | grep -oP 'intune-portal_[0-9.]+_amd64\.deb' | sort -V | tail -5
```

### Pre-Upgrade Checklist

- [ ] VM snapshot created
- [ ] Noted new version number and download URL
- [ ] Device currently enrolled and compliant

### Procedure

1. **Create snapshot:**
   ```bash
   prlctl snapshot stargazer -n "Pre-Portal-Upgrade" -d "Before intune-portal upgrade"
   ```

2. **Get new package hash:**
   ```bash
   nix-prefetch-url https://packages.microsoft.com/ubuntu/22.04/prod/pool/main/i/intune-portal/intune-portal_NEW_VERSION_amd64.deb
   ```

3. **Update package definition:**
   Edit `packages/intune-portal/default.nix`:
   - Update `version = "NEW_VERSION";`
   - Update `sha256 = "NEW_HASH";`

4. **Rebuild:**
   ```bash
   cd /mnt/psf/dotfiles  # or your dotfiles path
   nix run home-manager -- switch --flake .#stargazer -b backup
   ```

5. **Test launch:**
   ```bash
   intune-portal-rosetta
   ```

### Post-Upgrade Verification

```bash
# Check version
intune-portal-rosetta --version 2>/dev/null || echo "Check UI for version"

# Verify can sign in
# Launch portal and verify sign-in still works
```

- [ ] Portal launches without errors
- [ ] Can see device status
- [ ] Sign-in flow works (if you sign out and back in)

### Rollback

```bash
# Restore old version in default.nix
git checkout packages/intune-portal/default.nix

# Rebuild
nix run home-manager -- switch --flake .#stargazer -b backup
```

Or restore VM snapshot if Nix rebuild fails.

### Version History

| Date | Version | Notes |
|------|---------|-------|
| 2026-02-03 | 1.2511.7 | Current working version |

---

## Microsoft Identity Broker

**Current version:** 2.10.90
**Package source:** Microsoft .deb repackaged via Nix
**Location:** `packages/microsoft-identity-broker/default.nix`
**Update frequency:** When Microsoft releases new version
**Risk level:** HIGH - Handles authentication tokens

### When to Upgrade

- Security advisory from Microsoft
- Authentication failures with current version
- Compatibility issues with new Intune portal version

### Pre-Upgrade Checklist

- [ ] VM snapshot created
- [ ] Current enrollment verified working
- [ ] Noted new version from Microsoft packages site

### Procedure

Same as Intune Portal:
1. Create snapshot
2. Get new package hash with nix-prefetch-url
3. Update `packages/microsoft-identity-broker/default.nix`
4. Rebuild with home-manager
5. Test authentication

### Post-Upgrade Verification

```bash
# Check D-Bus activation
dbus-send --session --print-reply --dest=org.freedesktop.DBus /org/freedesktop/DBus org.freedesktop.DBus.ListNames | grep microsoft

# Test sign-in flow
intune-portal-rosetta
```

- [ ] Broker activates on D-Bus
- [ ] Portal authentication works

### Version History

| Date | Version | Notes |
|------|---------|-------|
| 2026-02-03 | 2.10.90 | Current working version |

---

## Microsoft Identity Device Broker

**Current version:** 2.10.10
**Package source:** Microsoft .deb repackaged via Nix
**Location:** `packages/microsoft-identity-device-broker/default.nix`
**Update frequency:** When Microsoft releases new version
**Risk level:** HIGH - System service, handles device identity

### When to Upgrade

- Security advisory
- Compliance reporting issues
- Microsoft deprecates current version

### Pre-Upgrade Checklist

- [ ] VM snapshot created
- [ ] Device broker currently running: `systemctl status microsoft-identity-device-broker`
- [ ] Compliance currently working

### Procedure

Same pattern as other Microsoft packages, plus:

After rebuild, restart the service:
```bash
sudo systemctl restart microsoft-identity-device-broker
```

### Post-Upgrade Verification

```bash
# Check service status
systemctl status microsoft-identity-device-broker

# Check D-Bus registration
dbus-send --system --print-reply --dest=org.freedesktop.DBus /org/freedesktop/DBus org.freedesktop.DBus.ListNames | grep microsoft

# Run health check
intune-health
```

- [ ] Service running (active)
- [ ] D-Bus name registered
- [ ] intune-health passes

### Version History

| Date | Version | Notes |
|------|---------|-------|
| 2026-02-03 | 2.10.10 | Current working version |

---
```
  </action>
  <verify>grep -c "## Microsoft" docs/UPGRADE-PROCEDURES.md returns 3</verify>
  <done>Intune package upgrade procedures complete</done>
</task>

<task type="auto">
  <name>Task 3: Add pinned dependency and full system upgrade sections</name>
  <files>docs/UPGRADE-PROCEDURES.md</files>
  <action>
Add the remaining sections:

```markdown
## OpenSSL (Pinned)

**Current version:** 3.3.2
**Pinned because:** Code:1200 broker authentication bug with OpenSSL 3.4+
**Location:** `modules/home/linux/intune.nix` (openssl332 derivation)
**Update frequency:** ONLY when bug is fixed or security-critical
**Risk level:** CRITICAL - Can completely break authentication

### Background

OpenSSL 3.4+ introduced changes that break the Microsoft broker's TLS authentication, resulting in "Code:1200" errors during sign-in. Version 3.3.2 is the last known working version.

### When to Upgrade

- Microsoft confirms broker works with newer OpenSSL
- Critical security vulnerability in OpenSSL 3.3.2 with no workaround
- You've tested newer version in a disposable VM

### Testing New OpenSSL Version

**Always test in a clone first, never on enrolled production VM:**

1. Clone the enrolled VM:
   ```bash
   prlctl clone stargazer --name "OpenSSL-Test"
   ```

2. Modify intune.nix to use newer OpenSSL (comment out openssl332, use nixpkgs openssl)

3. Rebuild in test VM

4. Test full authentication flow:
   - Launch portal
   - Sign out if signed in
   - Sign in fresh with YubiKey
   - Check compliance

5. If fails, discard test VM. If succeeds, document and consider production upgrade.

### Procedure (If Testing Succeeds)

1. **Create production snapshot**

2. **Update intune.nix:**
   - Comment out or remove openssl332 derivation
   - Update fullLibraryPath to use `${pkgs.openssl.out}/lib` instead

3. **Rebuild:**
   ```bash
   nix run home-manager -- switch --flake .#stargazer -b backup
   ```

4. **Test authentication immediately**

### Rollback

```bash
git checkout modules/home/linux/intune.nix
nix run home-manager -- switch --flake .#stargazer -b backup
```

### Version History

| Date | Version | Notes | OpenSSL Nixpkgs |
|------|---------|-------|-----------------|
| 2026-02-03 | 3.3.2 | Pinned - last working | 3.4.x broken |

---

## OpenSC (Pinned)

**Current version:** 0.25.1
**Pinned because:** Compatibility with YubiKey PIV and broker PKCS#11
**Location:** `modules/home/linux/intune.nix` (via Arch package archive)
**Update frequency:** When YubiKey support improves or bugs found
**Risk level:** MEDIUM - Can break YubiKey certificate access

### When to Upgrade

- Newer version explicitly adds YubiKey improvements
- Current version has bugs affecting PIV
- Testing shows newer version works

### Testing New OpenSC Version

1. Clone enrolled VM
2. Update the opensc package reference in intune.nix
3. Test certificate listing:
   ```bash
   pkcs11-tool --module /path/to/new/opensc-pkcs11.so --list-objects
   ```
4. Test full authentication with YubiKey

### Version History

| Date | Version | Notes |
|------|---------|-------|
| 2026-02-03 | 0.25.1 | From Arch archive, working |

---

## Full System Upgrade

For upgrading the entire system (Arch packages, Nix, etc.):

### Risk Assessment

Full system upgrades are the highest risk because:
- Arch is rolling release (all packages update at once)
- Kernel updates may affect Rosetta
- System library updates may break x86_64 compatibility layer

### Recommended Approach

1. **Never upgrade enrolled production VM directly**

2. **Create test clone:**
   ```bash
   prlctl clone stargazer --name "FullUpgrade-Test-$(date +%Y%m%d)"
   ```

3. **Upgrade test clone:**
   ```bash
   sudo pacman -Syu
   ```

4. **Reboot and verify:**
   - LUKS decryption works
   - Rosetta still works: `cat /proc/sys/fs/binfmt_misc/rosetta`
   - Nix still works: `nix --version`
   - Intune still works: `intune-health`
   - Can authenticate: test portal sign-in

5. **If test passes:** Upgrade production with same steps

6. **If test fails:** Discard test VM, investigate specific failing package

### Nix/Home-Manager Upgrades

To upgrade Nix flake inputs (nixpkgs, home-manager):

```bash
cd /mnt/psf/dotfiles
nix flake update

# Test rebuild
nix run home-manager -- switch --flake .#stargazer -b backup --dry-run

# If dry-run looks good
nix run home-manager -- switch --flake .#stargazer -b backup
```

### Version Tracking

Document working version combinations in your notes:

```
Working combo 2026-02-03:
- Arch: 2026-02 rolling
- Kernel: 6.x.y
- Nix: 2.x.x
- nixpkgs: rev abc123
- intune-portal: 1.2511.7
- OpenSSL: 3.3.2 (pinned)
```

---

## Quick Reference

| Component | Version | Update Frequency | Risk |
|-----------|---------|------------------|------|
| Omarchy | armarchy-3-x | Major releases | MEDIUM |
| intune-portal | 1.2511.7 | Microsoft releases | MEDIUM |
| microsoft-identity-broker | 2.10.90 | Microsoft releases | HIGH |
| microsoft-identity-device-broker | 2.10.10 | Microsoft releases | HIGH |
| OpenSSL | 3.3.2 (pinned) | Rarely | CRITICAL |
| OpenSC | 0.25.1 (pinned) | Rarely | MEDIUM |

**Remember:** Snapshot → Upgrade → Verify → Rollback if needed
```
  </action>
  <verify>grep -c "## " docs/UPGRADE-PROCEDURES.md returns at least 8</verify>
  <done>All upgrade procedures documented including pinned packages and rollback</done>
</task>

</tasks>

<verification>
1. Document covers all major components (Omarchy, Intune packages, OpenSSL, OpenSC)
2. Each section has pre-upgrade checklist
3. Each section has rollback procedure
4. Version history tables track known-working versions
5. Risk levels clearly stated
6. Quick reference table at end
</verification>

<success_criteria>
- [ ] `docs/UPGRADE-PROCEDURES.md` exists and is 350+ lines
- [ ] 7 upgrade sections documented
- [ ] All sections have rollback procedures
- [ ] OpenSSL pinning rationale explained
- [ ] Quick reference table present
</success_criteria>

<output>
After completion, create `.planning/phases/07-documentation/07-03-SUMMARY.md`
</output>
